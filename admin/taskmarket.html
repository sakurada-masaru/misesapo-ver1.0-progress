<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>Task Market - ãƒŸã‚»ã‚µãƒ</title>
    <style>
        /*
         ========================================
           Task Market ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒšãƒ¼ã‚¸
           ========================================
           
           ğŸ“‹ æ¦‚è¦
           WEBã‚µã‚¤ãƒˆé–‹ç™ºã«ãŠã‘ã‚‹æ§˜ã€…ãªã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†ã™ã‚‹ãƒšãƒ¼ã‚¸
           
           ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
           - åŸºèª¿ã‚«ãƒ©ãƒ¼: ç™½ã¨ãƒ”ãƒ³ã‚¯
           - ãƒ•ãƒ«HDç”»é¢å¯¾å¿œ
           - ã‚¹ãƒãƒ›ç‰ˆ: 430px
           
           ğŸ“ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
           - ãƒ˜ãƒƒãƒ€ãƒ¼: 60pxé«˜ã•
           - ãƒœãƒ‡ã‚£: 3ã‚«ãƒ©ãƒ 
             - ã‚«ãƒ©ãƒ 1: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆ10%å¹…ã€100%é«˜ã•ï¼‰
             - ã‚«ãƒ©ãƒ 2: ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ï¼ˆ60%å¹…ï¼‰
             - ã‚«ãƒ©ãƒ 3: è©³ç´°ãƒœãƒ¼ãƒ‰ï¼ˆ30%å¹…ï¼‰
           
           ğŸ”§ æ©Ÿèƒ½
           - æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³
           - ã‚¿ã‚¹ã‚¯å†…å®¹å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
         ========================================
        */
        :root {
            /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
            --color-primary: #FF679C;
            --color-primary-hover: #FF4081;
            --color-primary-light: rgba(255, 103, 156, 0.1);
            --color-primary-shadow: rgba(255, 103, 156, 0.2);
            
            --color-background: #ffffff;
            --color-background-secondary: #fafafa;
            --color-text-primary: #333333;
            --color-text-secondary: #7f8c8d;
            --color-border: #e1e8ed;
            
            /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
            --font-family-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚° */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* ãƒœãƒ¼ãƒ€ãƒ¼åŠå¾„ */
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            
            /* ã‚·ãƒ£ãƒ‰ã‚¦ */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            
            /* ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
            --transition-normal: 0.3s ease;

            /* ãƒ‘ãƒãƒ«ã‚«ãƒ©ãƒ¼ï¼ˆ5ã¤ã®ãƒ‘ãƒãƒ«ç”¨ï¼‰ */
            --panel-1-color: #FF679C;
            --panel-1-hover: #FF4081;
            --panel-2-color: #4A90E2;
            --panel-2-hover: #357ABD;
            --panel-3-color: #50C878;
            --panel-3-hover: #3FA863;
            --panel-4-color: #FF8C42;
            --panel-4-hover: #FF6B1F;
            --panel-5-color: #4CAF50;
            --panel-5-hover: #45a049;

            /* ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è–„ã„æ ç·šè‰²ï¼ˆã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ç”¨ï¼‰ */
            --category-design-border: rgba(255, 103, 156, 0.3);
            --category-frontend-border: rgba(74, 144, 226, 0.3);
            --category-backend-border: rgba(80, 200, 120, 0.3);
            --category-media-border: rgba(255, 140, 66, 0.3);
            --category-other-border: rgba(127, 140, 141, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-primary);
            background: var(--color-background);
            color: var(--color-text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-background);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            /* ç™½ç”»é¢ã‚’æ¶ˆã™: ãƒ­ã‚´ãŒæ¶ˆãˆãŸå¾Œï¼ˆç´„3ç§’å¾Œï¼‰ã«é–‹å§‹ */
            animation: fadeOutScreen 0.5s ease-out 3s forwards;
        }

        .splash-screen.hidden {
            display: none;
        }

        .splash-logo {
            width: 144px;
            height: 144px;
            opacity: 0;
            /* 1. ãƒ­ã‚´ãŒå‡ºã‚‹: 0.3ç§’å¾Œã«é–‹å§‹ã€1ç§’ã‹ã‘ã¦è¡¨ç¤º */
            /* 2. ãƒ­ã‚´ãŒæ¶ˆãˆã‚‹: 2ç§’å¾Œã«é–‹å§‹ã€0.5ç§’ã‹ã‘ã¦æ¶ˆãˆã‚‹ */
            animation: 
                fadeInUp 1s ease-out 0.3s forwards,
                fadeOutLogo 0.5s ease-out 2s forwards;
        }

        /* ãƒ­ã‚´ãŒãµã‚ã£ã¨è¡¨ç¤º */
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ãƒ­ã‚´ãŒæ¶ˆãˆã‚‹ */
        @keyframes fadeOutLogo {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
        }

        /* ç™½ç”»é¢ãŒæ¶ˆãˆã‚‹ */
        @keyframes fadeOutScreen {
            0% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                visibility: hidden;
            }
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            height: 60px;
            background: var(--color-background);
            border-bottom: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            position: relative;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .logo {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .nav-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--color-text-primary);
            font-size: var(--font-size-sm);
            cursor: pointer;
            border-radius: var(--border-radius-md);
            transition: var(--transition-normal);
        }

        .nav-button:hover {
            background: var(--color-primary-light);
            color: var(--color-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }


        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆå¹ãå‡ºã—ï¼‰ */
        .tooltip-text {
            position: absolute;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 11px;
            white-space: nowrap;
            border-radius: var(--border-radius-sm);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .tooltip-text::before {
            content: '';
            position: absolute;
            border: 6px solid transparent;
        }
        
        /* å·¦å´ãƒœã‚¿ãƒ³ï¼ˆå·¦ãƒ‘ãƒãƒ«ï¼‰ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .slide-panel-handle .tooltip-text {
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 8px;
        }
        
        .slide-panel-handle .tooltip-text::before {
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border-right-color: rgba(0, 0, 0, 0.85);
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆãƒ›ãƒãƒ¼æ™‚ï¼‰ */
        .add-task-button:hover .tooltip-text,
        .add-badge-button:hover .tooltip-text,
        .trash-bin:hover .tooltip-text,
        .complete-button:hover .tooltip-text,
        .slide-panel-handle:hover .tooltip-text {
            opacity: 1;
            visibility: visible;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            width: 100%;
        }


        /* ã‚«ãƒ©ãƒ 2: ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ */
        .main-board {
            width: 100%;
            height: 100%;
            background: var(--color-background);
            overflow-y: auto;
            padding: var(--spacing-lg);
            transition: var(--transition-normal);
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ã®å¹…èª¿æ•´ã¯JavaScriptã§åˆ¶å¾¡ */

        /* ã‚«ãƒ©ãƒ 3: è©³ç´°ãƒœãƒ¼ãƒ‰ï¼ˆå³ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã™ã‚‹ãƒ‘ãƒãƒ«ï¼‰ */
        .detail-board-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1500;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .detail-board-overlay.active {
            display: block;
        }

        .detail-board {
            position: fixed;
            top: 0;
            right: 0;
            width: 40%;
            height: 100%;
            background: var(--color-background-secondary);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1501;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            border-left: 2px solid var(--color-border);
            padding: var(--spacing-lg);
        }

        .detail-board.active {
            transform: translateX(0);
        }
        
        /* ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆå³ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã€ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ‘ãƒãƒ«ã®ä¸Šã«è¡¨ç¤ºï¼‰ */
        .time-record-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1600;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .time-record-panel-overlay.active {
            display: block;
        }

        .time-record-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 40%;
            height: 100%;
            background: var(--color-background-secondary);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1601;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            border-left: 2px solid var(--color-border);
            padding: var(--spacing-lg);
        }

        .time-record-panel.active {
            transform: translateX(0);
        }

        .time-record-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--color-border);
            position: sticky;
            top: 0;
            background: var(--color-background-secondary);
            z-index: 10;
            padding-top: var(--spacing-md);
        }

        .time-record-panel-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .time-record-panel-close-button {
            background: none;
            border: none;
            font-size: 32px;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-md);
            transition: var(--transition-normal);
            line-height: 1;
        }

        .time-record-panel-close-button:hover {
            background: var(--color-background-secondary);
            color: var(--color-text-primary);
        }

        .detail-board-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--color-border);
            position: sticky;
            top: 0;
            background: var(--color-background-secondary);
            z-index: 10;
            padding-top: var(--spacing-md);
        }

        .detail-board-close-button {
            background: none;
            border: none;
            font-size: 32px;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-md);
            transition: var(--transition-normal);
            line-height: 1;
        }

        .detail-board-close-button:hover {
            background: var(--color-background-secondary);
            color: var(--color-text-primary);
        }

        .detail-edit-button,
        .detail-time-record-button {
            background: var(--color-primary);
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-md);
            transition: var(--transition-normal);
            line-height: 1;
            position: relative; /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®åŸºæº–ç‚¹ */
        }

        .detail-edit-button:hover,
        .detail-time-record-button:hover {
            background: var(--color-primary-hover);
            transform: scale(1.05);
        }

        .detail-edit-icon {
            width: 20px;
            height: 20px;
            filter: brightness(0) invert(1); /* SVGã‚’ç™½ã«å¤‰æ› */
            transition: transform 0.3s ease;
        }

        .detail-edit-button:hover .detail-edit-icon {
            transform: rotate(180deg); /* ãƒ›ãƒãƒ¼æ™‚ã«å›è»¢ */
        }

        /* è©³ç´°ãƒ‘ãƒãƒ«ã®ä¿®æ­£ãƒœã‚¿ãƒ³ã¨ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .detail-edit-button .tooltip-text,
        .detail-time-record-button .tooltip-text {
            left: auto;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 0;
            margin-right: 8px;
        }
        
        .detail-edit-button .tooltip-text::before,
        .detail-time-record-button .tooltip-text::before {
            left: 100%;
            right: auto;
            border-left-color: rgba(0, 0, 0, 0.85);
            border-right-color: transparent;
        }

        .detail-edit-button:hover .tooltip-text,
        .detail-time-record-button:hover .tooltip-text {
            opacity: 1;
            visibility: visible;
        }

        /* æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆç”»é¢ä¸‹éƒ¨ä¸­å¤®ã«å›ºå®šãƒ»å††å½¢ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ */
        .add-task-button {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 64px;
            height: 64px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 32px;
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            line-height: 1;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        
        /* å®Œäº†ãƒœã‚¿ãƒ³ï¼ˆç”»é¢å·¦ä¸‹ã«å›ºå®šãƒ»å††å½¢ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ */
        .complete-button {
            position: fixed !important;
            bottom: 24px !important;
            left: 24px !important;
            top: auto !important;
            right: auto !important;
            width: 64px;
            height: 64px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            opacity: 0.8;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        
        .complete-button:hover {
            background: #45a049;
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px) scale(1.1);
            opacity: 1;
        }
        
        .complete-button.drag-over {
            background: #45a049;
            transform: scale(1.2);
            opacity: 1;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        }
        
        .complete-icon {
            font-size: 32px;
            font-weight: var(--font-weight-bold);
            user-select: none;
        }
        
        .complete-button .tooltip-text {
            left: 100%;
            right: auto;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 8px;
            margin-right: 0;
        }
        
        .complete-button .tooltip-text::before {
            left: -6px;
            right: auto;
            border-right-color: rgba(0, 0, 0, 0.85);
            border-left-color: transparent;
        }
        
        .add-task-button .tooltip-text {
            left: auto;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 0;
            margin-right: 8px;
        }
        
        .add-task-button .tooltip-text::before {
            left: 100%;
            right: auto;
            border-left-color: rgba(0, 0, 0, 0.85);
            border-right-color: transparent;
        }

        .add-task-button:hover {
            background: var(--color-primary-hover);
            box-shadow: var(--shadow-xl);
            transform: translateX(-50%) translateY(-2px) scale(1.1);
        }

        .add-task-button:active {
            transform: translateX(-50%) translateY(0) scale(1.05);
        }
        
        .add-task-button:focus {
            outline: none;
            box-shadow: var(--shadow-xl), 0 0 0 3px rgba(255, 103, 156, 0.3);
        }

        /* ãƒãƒƒã‚¸ã‚’ä½œã‚‹ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šã«å›ºå®šãƒ»â—¯ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ */
        .add-badge-button {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            font-weight: var(--font-weight-bold);
            cursor: pointer;
            transition: var(--transition-normal);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            line-height: 1;
            padding: 0;
        }

        .add-badge-button .tooltip-text {
            left: auto;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 0;
            margin-right: 8px;
        }
        
        .add-badge-button .tooltip-text::before {
            left: 100%;
            right: auto;
            border-left-color: rgba(0, 0, 0, 0.85);
            border-right-color: transparent;
        }

        .add-badge-button:hover {
            background: var(--color-primary-hover);
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px) scale(1.1);
        }

        .add-badge-button:active {
            transform: translateY(0) scale(1.05);
        }

        .badge-icon-text {
            font-size: 28px;
            line-height: 1;
        }

        /* ã‚´ãƒŸç®±ï¼ˆç”»é¢å³ä¸‹ã«å›ºå®šï¼‰ */
        .trash-bin {
            position: fixed !important;
            bottom: 24px !important;
            right: 24px !important;
            top: auto !important;
            left: auto !important;
            width: 64px;
            height: 64px;
            background: var(--color-danger, #ff4757);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            opacity: 0.8;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        
        .trash-bin .tooltip-text {
            left: auto;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 0;
            margin-right: 8px;
        }
        
        .trash-bin .tooltip-text::before {
            left: 100%;
            right: auto;
            border-left-color: rgba(0, 0, 0, 0.85);
            border-right-color: transparent;
        }

        .trash-bin:hover {
            background: var(--color-danger-hover, #ff3838);
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px) scale(1.1);
            opacity: 1;
        }
        
        .trash-bin:focus {
            outline: none;
            box-shadow: var(--shadow-xl), 0 0 0 3px rgba(255, 71, 87, 0.3);
        }

        .trash-bin.drag-over {
            background: var(--color-danger-hover, #ff3838);
            transform: scale(1.2);
            opacity: 1;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.6);
        }

        /* ã‚¹ãƒãƒ›ç‰ˆï¼šã‚¿ãƒƒãƒãƒ‰ãƒ©ãƒƒã‚°æ™‚ã®ã‚´ãƒŸç®±æ‹¡å¤§ */
        .trash-bin.touch-drag-over {
            background: var(--color-danger-hover, #ff3838);
            transform: scale(1.3);
            width: 80px;
            height: 80px;
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.8);
        }

        @media (max-width: 430px) {
            .trash-bin.touch-drag-over {
                width: 80px;
                height: 80px;
            }
        }

        .trash-bin:active {
            transform: translateY(0) scale(1.05);
        }

        .trash-icon {
            font-size: 28px;
            user-select: none;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* ã‚¿ã‚¹ã‚¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ */
        .task-form {
            background: var(--color-background);
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .task-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--color-border);
        }

        .task-form-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .modal-close-button {
            background: none;
            border: none;
            font-size: 32px;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-md);
            transition: var(--transition-normal);
            line-height: 1;
        }

        .modal-close-button:hover {
            background: var(--color-background-secondary);
            color: var(--color-text-primary);
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ãƒ‘ãƒãƒ«ï¼ˆå·¦ã‹ã‚‰å³ã«ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã€æœ€å‰é¢ã«è¡¨ç¤ºï¼‰ */
        .slide-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .slide-panel-overlay.active {
            display: block;
        }

        .slide-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 40%;
            height: 100%;
            background: var(--color-background);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 2001;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            border-right: 2px solid var(--color-border);
        }

        .slide-panel.active {
            transform: translateX(0);
        }

        .slide-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 2px solid var(--color-border);
            background: var(--color-background);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .slide-panel-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .slide-panel-close-button {
            background: none;
            border: none;
            font-size: 32px;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-md);
            transition: var(--transition-normal);
            line-height: 1;
        }

        .slide-panel-close-button:hover {
            background: var(--color-background-secondary);
            color: var(--color-text-primary);
        }

        .slide-panel-content {
            padding: var(--spacing-lg);
        }
        
        /* ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
        .archive-task-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        /* ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ */
        .archive-task-item {
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            transition: var(--transition-normal);
        }
        
        .archive-task-item:hover {
            box-shadow: var(--shadow-sm);
        }
        
        .archive-task-header {
            padding: var(--spacing-md);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--color-background-secondary);
            transition: var(--transition-normal);
        }
        
        .archive-task-header:hover {
            background: var(--color-border);
        }
        
        .archive-task-item.active .archive-task-header {
            background: var(--color-primary-light);
            border-bottom: 1px solid var(--color-border);
        }
        
        .archive-task-title {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            flex: 1;
            margin-right: var(--spacing-sm);
        }
        
        .archive-task-meta {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: 4px;
        }
        
        .archive-task-arrow {
            font-size: var(--font-size-lg);
            transition: transform 0.3s ease;
        }
        
        .archive-task-item.active .archive-task-arrow {
            transform: rotate(180deg);
        }
        
        .archive-task-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 var(--spacing-md);
        }
        
        .archive-task-item.active .archive-task-content {
            max-height: 500px;
            padding: var(--spacing-md);
        }
        
        .archive-task-body {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .archive-task-description {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .archive-task-badges {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
            align-items: center;
        }
        
        .archive-task-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--color-background-secondary);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
        }
        
        .archive-task-badge-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .archive-empty {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--color-text-secondary);
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ãƒ‘ãƒãƒ«ã®ãƒãƒ³ãƒ‰ãƒ«ï¼ˆå·¦ç«¯ã«å›ºå®šã€5ã¤ã®ãƒ‘ãƒãƒ«ç”¨ï¼‰ */
        .slide-panel-handle {
            position: fixed;
            left: 0;
            width: 24px;
            height: 80px;
            border-radius: 0 12px 12px 0;
            cursor: pointer;
            z-index: 1999;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            padding: 0;
            border: none;
        }

        /* å„ãƒ‘ãƒãƒ«ã®ãƒãƒ³ãƒ‰ãƒ«ã®ä½ç½®ã¨è‰²ï¼ˆç­‰é–“éš”é…ç½®ï¼‰ */
        .slide-panel-handle.panel-1 {
            top: calc(100vh / 6);
            transform: translateY(-50%);
            background: var(--panel-1-color);
        }

        .slide-panel-handle.panel-2 {
            top: calc(100vh / 3);
            transform: translateY(-50%);
            background: var(--panel-2-color);
        }

        .slide-panel-handle.panel-3 {
            top: 50%;
            transform: translateY(-50%);
            background: var(--panel-3-color);
        }

        .slide-panel-handle.panel-4 {
            top: calc(100vh * 2 / 3);
            transform: translateY(-50%);
            background: var(--panel-4-color);
        }

        .slide-panel-handle.panel-5 {
            top: calc(100vh * 5 / 6);
            transform: translateY(-50%);
            background: var(--panel-5-color);
        }

        /* ã‚¹ãƒãƒ›ç‰ˆã§ã®å·¦ãƒ‘ãƒãƒ«ãƒãƒ³ãƒ‰ãƒ«ã®é…ç½®ï¼ˆ100pxä¸‹ã«é…ç½®ï¼‰ */
        @media (max-width: 430px) {
            .slide-panel-handle.panel-1 {
                top: 100px;
                transform: none;
            }

            .slide-panel-handle.panel-2 {
                top: calc(100px + 50px + 20px); /* 100px + 50px (é«˜ã•) + 20px (ã‚®ãƒ£ãƒƒãƒ—) */
                transform: none;
            }

            .slide-panel-handle.panel-3 {
                top: calc(100px + (50px + 20px) * 2);
                transform: none;
            }

            .slide-panel-handle.panel-4 {
                top: calc(100px + (50px + 20px) * 3);
                transform: none;
            }

            .slide-panel-handle.panel-5 {
                top: calc(100px + (50px + 20px) * 4);
                transform: none;
            }
        }

        .slide-panel-handle:hover {
            width: 32px;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
        }

        .slide-panel-handle.panel-1:hover {
            background: var(--panel-1-hover);
        }

        .slide-panel-handle.panel-2:hover {
            background: var(--panel-2-hover);
        }

        .slide-panel-handle.panel-3:hover {
            background: var(--panel-3-hover);
        }

        .slide-panel-handle.panel-4:hover {
            background: var(--panel-4-hover);
        }

        .slide-panel-handle.panel-5:hover {
            background: var(--panel-5-hover);
        }

        .slide-panel-handle::before {
            content: 'â—€';
            color: white;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .slide-panel-handle:hover::before {
            transform: translateX(2px);
        }

        .slide-panel-handle.active {
            left: 40%;
        }

        .slide-panel-handle.panel-1.active {
            left: 40%;
            top: calc(100vh / 6);
            transform: translateY(-50%) translateX(-100%);
        }

        .slide-panel-handle.panel-2.active {
            left: 40%;
            top: calc(100vh / 3);
            transform: translateY(-50%) translateX(-100%);
        }

        .slide-panel-handle.panel-3.active {
            left: 40%;
            transform: translateY(-50%) translateX(-100%);
        }

        .slide-panel-handle.panel-4.active {
            left: 40%;
            top: calc(100vh * 2 / 3);
            transform: translateY(-50%) translateX(-100%);
        }

        .slide-panel-handle.panel-5.active {
            left: 40%;
            top: calc(100vh * 5 / 6);
            transform: translateY(-50%) translateX(-100%);
        }

        .slide-panel-handle.active::before {
            content: 'â–¶';
            transform: rotate(180deg);
        }

        .slide-panel-handle.panel-1.active::before,
        .slide-panel-handle.panel-2.active::before,
        .slide-panel-handle.panel-4.active::before,
        .slide-panel-handle.panel-5.active::before {
            content: 'â–¶';
            transform: rotate(180deg);
        }

        /* å„ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè‰²åˆ†ã‘ï¼‰ */
        .slide-panel.panel-1 {
            border-right: 4px solid var(--panel-1-color);
        }

        .slide-panel.panel-2 {
            border-right: 4px solid var(--panel-2-color);
        }

        .slide-panel.panel-3 {
            border-right: 4px solid var(--panel-3-color);
        }

        .slide-panel.panel-4 {
            border-right: 4px solid var(--panel-4-color);
        }

        .slide-panel.panel-5 {
            border-right: 4px solid var(--panel-5-color);
        }

        .slide-panel-header.panel-1 {
            border-bottom: 2px solid var(--panel-1-color);
        }

        .slide-panel-header.panel-2 {
            border-bottom: 2px solid var(--panel-2-color);
        }

        .slide-panel-header.panel-3 {
            border-bottom: 2px solid var(--panel-3-color);
        }

        .slide-panel-header.panel-4 {
            border-bottom: 2px solid var(--panel-4-color);
        }

        .slide-panel-header.panel-5 {
            border-bottom: 2px solid var(--panel-5-color);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-sm);
            font-family: var(--font-family-primary);
            transition: var(--transition-normal);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
            margin-top: var(--spacing-lg);
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-background-secondary);
            color: var(--color-text-primary);
            border: 2px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ï¼ˆæ²ç¤ºæ¿é¢¨ã®ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ï¼‰ */
        .task-grid {
            position: relative;
            min-height: 800px;
            width: 100%;
            background: var(--color-background-secondary);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            overflow-y: auto;
            /* ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ç”¨ã®ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
            transition: transform 0.3s ease-out;
        }
        
        /* ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ç”¨ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .pull-refresh-indicator {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--color-primary);
            font-size: var(--font-size-sm);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .pull-refresh-indicator.active {
            opacity: 1;
        }
        
        .pull-refresh-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-primary-light);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ’ãƒ³ãƒˆï¼ˆã‚¹ãƒãƒ›ç‰ˆã®ã¿ï¼‰ */
        .pull-refresh-hint {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(0, 0, 0, 0.5); /* é»’æ–‡å­—ã§åŠé€æ˜ */
            font-size: var(--font-size-sm);
            pointer-events: none;
            user-select: none;
            z-index: 1;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            white-space: nowrap;
        }
        
        /* ã‚¹ãƒãƒ›ç‰ˆï¼ˆSPï¼‰ï¼šãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¯¾å¿œã¨ãƒ’ãƒ³ãƒˆè¡¨ç¤º */
        @media (max-width: 430px) {
            .task-grid {
                -webkit-overflow-scrolling: touch;
            }
            
            /* ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤ºï¼ˆã‚¹ãƒãƒ›ç‰ˆã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤ºï¼‰ */
            .pull-refresh-hint {
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            /* ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å ´åˆã¯ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã«å¿œã˜ã¦è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ */
            .task-grid.has-tasks:not(.scroll-top) .pull-refresh-hint {
                opacity: 0;
                visibility: hidden;
            }
            
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒæœ€ä¸Šéƒ¨ï¼ˆ5pxä»¥ä¸‹ï¼‰ã®æ™‚ã®ã¿ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º */
            .task-grid.scroll-top .pull-refresh-hint,
            .task-grid:not(.has-tasks) .pull-refresh-hint {
                opacity: 1 !important;
                visibility: visible !important;
            }
        }

        .task-card {
            position: absolute;
            background: var(--color-background);
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            transition: var(--transition-normal);
            cursor: grab;
            width: 280px;
            min-height: 180px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .task-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px) rotate(0deg) !important;
            z-index: 10;
        }

        /* ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®æ ç·šè‰² */
        .task-card.category-design {
            border-color: var(--category-design-border);
        }

        .task-card.category-frontend {
            border-color: var(--category-frontend-border);
        }

        .task-card.category-backend {
            border-color: var(--category-backend-border);
        }

        .task-card.category-media {
            border-color: var(--category-media-border);
        }

        .task-card.category-database {
            border-color: var(--category-backend-border);
        }

        .task-card.category-other {
            border-color: var(--category-other-border);
        }

        .task-card.category-design:hover {
            border-color: rgba(255, 103, 156, 0.5);
        }

        .task-card.category-frontend:hover {
            border-color: rgba(74, 144, 226, 0.5);
        }

        .task-card.category-backend:hover,
        .task-card.category-database:hover {
            border-color: rgba(80, 200, 120, 0.5);
        }

        .task-card.category-media:hover {
            border-color: rgba(255, 140, 66, 0.5);
        }

        .task-card.category-other:hover {
            border-color: rgba(127, 140, 141, 0.5);
        }

        .task-card.selected {
            border: 2px solid var(--color-primary);
            box-shadow: 0 0 15px rgba(255, 103, 156, 0.4);
            transform: scale(1.02);
            z-index: 500;
        }

        /* ã‚¹ãƒãƒ›ç‰ˆï¼ˆSPï¼‰ï¼šé¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        @media (max-width: 430px) {
            .task-card.selected {
                border: 2px solid var(--color-primary);
                box-shadow: 0 0 20px rgba(255, 103, 156, 0.8); /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚·ãƒ£ãƒ‰ã‚¦ã‚’æ¿ƒã */
                transform: scale(1.05);
            }
        }

        .task-card.dragging {
            opacity: 1;
            cursor: grabbing;
            transform: rotate(0deg) !important;
            z-index: 999 !important; /* ã‚´ãƒŸç®±ã®z-index: 1000ã‚ˆã‚Šä¸‹ã«ã™ã‚‹ */
        }

        .task-grid.drag-over {
            background: var(--color-primary-light);
        }

        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            gap: var(--spacing-sm);
        }

        .task-card-title {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            line-height: 1.3;
            margin: 0;
            flex: 1;
            min-width: 0; /* ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã‚’è¨±å¯ */
        }

        .task-card-priority {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-shrink: 0;
            font-size: 10px; /* å°ã•ãè¡¨ç¤º */
            margin-left: auto; /* å³å´ã«é…ç½® */
        }

        .task-card-priority-star {
            color: #fbbf24;
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1));
        }

        .task-card-description {
            flex: 1;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            line-height: 1.5;
            margin: 0;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }

        .task-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--color-border);
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .task-card-category {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .task-card-footer-icon {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

        /* ãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
        .badge {
            position: absolute;
            width: 60px;
            height: 60px;
            background: var(--color-primary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            box-shadow: var(--shadow-md);
            z-index: 100;
            transition: var(--transition-normal);
            padding: var(--spacing-xs);
            border: 3px solid var(--color-background);
        }

        .badge:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
            z-index: 101;
        }

        .badge.dragging {
            opacity: 1;
            cursor: grabbing;
            z-index: 1000 !important;
        }

        .badge-icon {
            font-size: 24px;
            line-height: 1;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .badge-icon img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            -webkit-touch-callout: none; /* iOSã®ãƒ­ãƒ³ã‚°ã‚¿ãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç„¡åŠ¹åŒ– */
            -webkit-user-select: none; /* ç”»åƒã®é¸æŠã‚’ç„¡åŠ¹åŒ– */
            user-select: none;
            pointer-events: none; /* ç”»åƒã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ– */
        }

        .badge-name {
            font-size: 10px;
            font-weight: var(--font-weight-semibold);
            color: white;
            text-align: center;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        /* ã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ãŸãƒãƒƒã‚¸ */
        .task-card .badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            z-index: 5;
        }

        /* ã‚¹ãƒãƒ›ç‰ˆï¼ˆSPï¼‰ï¼šã‚«ãƒ¼ãƒ‰ã®ç›´ä¸‹ï¼ˆã‚«ãƒ¼ãƒ‰å¤–ï¼‰ã«å¯†ç€ã—ã¦å¸ç€ */
        @media (max-width: 430px) {
            .task-card .badge.attached {
                position: absolute;
                bottom: -48px !important; /* ã‚«ãƒ¼ãƒ‰ä¸‹éƒ¨ã¨ãƒãƒƒã‚¸ä¸Šéƒ¨ãŒå¯†ç€ï¼ˆ-48px = ãƒãƒƒã‚¸ã®é«˜ã•ï¼‰ */
                left: 50% !important;
                right: auto !important;
                transform: translateX(-50%) !important;
                margin: 0;
            }

            /* è¤‡æ•°ã®ãƒãƒƒã‚¸ãŒã‚ã‚‹å ´åˆã€æ¨ªæ–¹å‘ã«ä¸¦ã¹ã‚‹ */
            .task-card .badge.attached:nth-of-type(2) {
                left: calc(50% - 28px) !important; /* ä¸­å¤®ã‹ã‚‰å·¦ã«28pxï¼ˆ48px/2 + 8px/2ï¼‰ */
                transform: translateX(0) !important;
            }

            .task-card .badge.attached:nth-of-type(3) {
                left: calc(50% + 28px) !important; /* ä¸­å¤®ã‹ã‚‰å³ã«28px */
                transform: translateX(0) !important;
            }

            .task-card .badge.attached:nth-of-type(4) {
                left: calc(50% - 84px) !important; /* ã•ã‚‰ã«å·¦ã« */
                transform: translateX(0) !important;
            }

            .task-card .badge.attached:nth-of-type(5) {
                left: calc(50% + 84px) !important; /* ã•ã‚‰ã«å³ã« */
                transform: translateX(0) !important;
            }
        }

        .task-card .badge:hover {
            transform: scale(1.1);
        }

        .task-card.badge-attached {
            border: 2px dashed var(--color-primary);
        }

        .task-card.drag-over-badge {
            border: 3px solid var(--color-primary);
            box-shadow: 0 0 20px rgba(255, 103, 156, 0.5);
            transform: scale(1.05);
        }

        /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .task-card-tooltip {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 11px;
            white-space: nowrap;
            border-radius: var(--border-radius-sm);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            pointer-events: none;
            z-index: 1000;
        }

        /* ã‚¹ãƒãƒ›ç‰ˆï¼ˆSPï¼‰ï¼šé¸æŠæ™‚ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆã‚«ãƒ¼ãƒ‰ä¸Šã«è¡¨ç¤ºï¼‰ */
        @media (max-width: 430px) {
            .task-card-tooltip {
                bottom: 100%;
                top: auto;
                left: 50%;
                transform: translateX(-50%);
                margin-bottom: 12px;
            }

            .task-card-tooltip::before {
                bottom: -6px;
                top: auto;
                left: 50%;
                transform: translateX(-50%);
                border: 6px solid transparent;
                border-top-color: rgba(0, 0, 0, 0.85);
                border-right-color: transparent;
                border-bottom-color: transparent;
            }

            .task-card.selected .task-card-tooltip {
                opacity: 1 !important;
                visibility: visible !important;
            }
        }

        /* PCç‰ˆï¼šãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®çŸ¢å°ï¼ˆä¸‹ã‹ã‚‰ä¸Šï¼‰ */
        @media (min-width: 431px) {
            .task-card-tooltip::before {
                content: '';
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                border: 6px solid transparent;
                border-bottom-color: rgba(0, 0, 0, 0.85);
            }
        }

        /* PCç‰ˆï¼šãƒ›ãƒãƒ¼æ™‚ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤º */
        @media (min-width: 431px) {
            .task-card:hover .task-card-tooltip {
                opacity: 1;
                visibility: visible;
            }
        }

        /* è©³ç´°ãƒœãƒ¼ãƒ‰ */
        .detail-header {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--color-border);
        }

        .detail-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-sm);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 430px) {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
            .header {
                padding: 0 var(--spacing-sm);
                height: 50px;
            }

            .header-left {
                gap: var(--spacing-xs);
            }

            .logo {
                font-size: var(--font-size-md);
            }

            .nav-button {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: var(--font-size-xs);
                display: none; /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
            }

            .header-right {
                gap: var(--spacing-xs);
            }

            /* Googleèªè¨¼ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
            #googleSignInContainer {
                gap: var(--spacing-xs) !important;
            }

            #userAvatar {
                width: 24px !important;
                height: 24px !important;
            }

            #userName {
                font-size: var(--font-size-xs) !important;
            }

            /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
            .main-container {
                flex-direction: column;
                height: calc(100vh - 50px);
            }

            .main-board {
                width: 100%;
                height: auto;
                flex: 1;
                padding: var(--spacing-sm);
            }

            /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ï¼ˆæ°´å¹³æ–¹å‘ã«3ã¤ä¸¦ã¶ã‚µã‚¤ã‚ºï¼‰ */
            .task-card {
                width: calc((100vw - 24px - 40px) / 3 - 12px); /* ç”»é¢å¹…ã‹ã‚‰ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨ã‚®ãƒ£ãƒƒãƒ—ã‚’å¼•ã„ã¦3ç­‰åˆ† */
                max-width: 120px;
                min-height: 100px;
                padding: calc(var(--spacing-xs) * 0.8);
                font-size: 0.75rem;
            }

            .task-card-title {
                font-size: calc(var(--font-size-sm) * 0.8);
            }

            .task-card-description {
                font-size: 9px; /* 11px * 0.8 â‰ˆ 9px */
                -webkit-line-clamp: 3;
            }

            .task-card-priority {
                font-size: 6px; /* 8px * 0.8 = 6px */
            }

            .task-card-footer {
                font-size: calc(var(--font-size-xs) * 0.8);
            }

            .task-card-category-icon {
                width: 16px; /* 20px * 0.8 = 16px */
                height: 16px;
            }

            /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼ˆSPï¼‰ã§ã¯è¡¨ç¤ºï¼‰ */
            .task-card-tooltip {
                display: block !important;
                opacity: 0;
                visibility: hidden;
            }
            
            /* ã‚¹ãƒãƒ›ç‰ˆï¼ˆSPï¼‰ï¼šé¸æŠæ™‚ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤º */
            .task-card.selected .task-card-tooltip {
                opacity: 1 !important;
                visibility: visible !important;
            }

            /* ã‚¿ã‚¹ã‚¯ã‚°ãƒªãƒƒãƒ‰ï¼ˆæ°´å¹³æ–¹å‘ã«3ã¤ä¸¦ã¶ï¼‰ */
            .task-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                padding: var(--spacing-sm);
            }

            /* å›ºå®šãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
            .add-task-button,
            .complete-button,
            .add-badge-button {
                width: 48px;
                height: 48px;
                font-size: 24px;
            }
            
            /* ã‚´ãƒŸç®±ã®ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆSPç‰ˆï¼‰ */
            .trash-bin {
                width: 48px !important;
                height: 48px !important;
                font-size: 24px !important;
            }
            
            .complete-icon {
                font-size: 24px;
            }

            /* æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ï¼šç”»é¢ä¸‹éƒ¨ä¸­å¤®ã«å›ºå®šï¼ˆ430pxç”»é¢å¹…å†…ã«åã‚ã‚‹ï¼‰ */
            .add-task-button {
                position: fixed;
                bottom: 16px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
            }
            
            .add-task-button:hover {
                transform: translateX(-50%) translateY(-2px) scale(1.1);
            }
            
            .add-task-button:active {
                transform: translateX(-50%) translateY(0) scale(1.05);
            }
            
            .add-task-button:focus {
                outline: none;
                box-shadow: var(--shadow-xl), 0 0 0 3px rgba(255, 103, 156, 0.3);
            }

            /* ãƒãƒƒã‚¸ãƒœã‚¿ãƒ³ï¼šç”»é¢å³ä¸Šã«å›ºå®šï¼ˆä¸‹æ–¹å‘ã«80pxç§»å‹•ï¼‰ */
            .add-badge-button {
                position: fixed;
                top: 92px; /* 12px + 80px = 92px */
                right: 12px;
                z-index: 1000;
            }

            .badge-icon-text {
                font-size: 20px;
            }

            /* å®Œäº†ãƒœã‚¿ãƒ³ï¼šç”»é¢å·¦ä¸‹ã«å›ºå®šï¼ˆ430pxç”»é¢å¹…å†…ã«åã‚ã‚‹ï¼‰ */
            .complete-button {
                position: fixed !important;
                bottom: 16px !important;
                left: 16px !important;
                top: auto !important;
                right: auto !important;
                z-index: 1001;
            }
            
            /* ã‚´ãƒŸç®±ãƒœã‚¿ãƒ³ï¼šç”»é¢å³ä¸‹ã«å›ºå®šï¼ˆ430pxç”»é¢å¹…å†…ã«åã‚ã‚‹ï¼‰ */
            .trash-bin {
                position: fixed !important;
                bottom: 16px !important;
                right: 16px !important;
                top: auto !important;
                left: auto !important;
                width: 48px !important;
                height: 48px !important;
                z-index: 1001 !important; /* ã‚«ãƒ¼ãƒ‰ã®z-indexã‚ˆã‚Šä¸Šã«ã—ã¦ã€å¸¸ã«ä¸Šã«è¡¨ç¤º */
                /* å®Œäº†ãƒœã‚¿ãƒ³ã¨åŒã˜ä½ç½®ï¼ˆå·¦ä¸‹ï¼‰ã«è¡¨ç¤ºã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 50% !important;
                /* èƒŒæ™¯ã¨ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­å¿ƒç‚¹ã‚’åˆã‚ã›ã‚‹ */
                padding: 0 !important;
                margin: 0 !important;
            }

            .trash-bin .trash-icon {
                font-size: 20px !important;
                line-height: 1 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* è©³ç´°ãƒœãƒ¼ãƒ‰ */
            .detail-board {
                width: 100%;
            }

            .detail-board-header {
                padding: var(--spacing-sm);
            }

            .detail-title {
                font-size: var(--font-size-lg);
            }

            .detail-edit-button {
                width: 36px;
                height: 36px;
                padding: 6px;
            }

            .detail-edit-icon {
                width: 18px;
                height: 18px;
            }

            .detail-board-close-button {
                width: 36px;
                height: 36px;
                font-size: 24px;
            }

            /* ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« */
            .time-record-panel {
                width: 350px;
                padding: var(--spacing-sm) !important;
            }
            
            .time-record-panel-header {
                padding: var(--spacing-xs) !important;
                margin-bottom: var(--spacing-sm) !important;
                padding-bottom: var(--spacing-xs) !important;
                padding-top: var(--spacing-xs) !important;
            }
            
            .time-record-panel-title {
                font-size: var(--font-size-md) !important;
            }
            
            .time-record-panel-close-button {
                width: 28px !important;
                height: 28px !important;
                font-size: 20px !important;
            }
            
            #timeRecordContent {
                font-size: var(--font-size-sm) !important;
            }
            
            #timeRecordContent h3 {
                font-size: var(--font-size-md) !important;
                margin-bottom: var(--spacing-sm) !important;
            }
            
            #timeRecordContent div[style*="padding"] {
                padding: var(--spacing-sm) !important;
                margin-bottom: var(--spacing-sm) !important;
            }
            
            #timeRecordContent div[style*="margin-bottom"] {
                margin-bottom: var(--spacing-xs) !important;
            }

            /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ãƒ‘ãƒãƒ« */
            .slide-panel {
                width: 100%;
            }

            .slide-panel-handle {
                width: 20px;
                height: 50px;
                z-index: 1999;
            }


            /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
            .task-form {
                width: 95%;
                max-width: 95%;
                max-height: 90vh;
                padding: var(--spacing-md);
                overflow-y: auto;
            }

            .task-form-header {
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .task-form-title {
                font-size: var(--font-size-md);
            }

            .modal-close-button {
                width: 32px;
                height: 32px;
                font-size: 24px;
            }

            /* ãƒãƒƒã‚¸ */
            .badge {
                width: 48px;
                height: 48px;
            }

            .badge-icon {
                font-size: 18px;
            }

            .badge-name {
                font-size: 8px;
            }

            .task-card .badge {
                width: 40px;
                height: 40px;
            }

            /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç°¡ç•¥è¡¨ç¤ºã¾ãŸã¯éè¡¨ç¤ºï¼‰ */
            .tooltip-text {
                font-size: 10px;
                padding: 4px 8px;
            }

            /* ãƒ•ã‚©ãƒ¼ãƒ  */
            .form-group {
                margin-bottom: var(--spacing-sm);
            }

            .form-group label {
                font-size: var(--font-size-xs);
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: var(--font-size-sm);
                padding: var(--spacing-xs) var(--spacing-sm);
            }

            .btn {
                padding: var(--spacing-xs) var(--spacing-md);
                font-size: var(--font-size-xs);
            }

            /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
            .splash-logo {
                width: 80px;
                height: 80px;
            }
        }
    </style>
    
    <!-- Google Identity Services -->
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
    <div class="splash-screen" id="splashScreen">
        <img src="images/logo_144x144.png" alt="ãƒŸã‚»ã‚µãƒ" class="splash-logo">
    </div>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-left">
            <div class="logo">ğŸ“‹ Task Market</div>
            <button class="nav-button">ãƒ›ãƒ¼ãƒ </button>
            <button class="nav-button">ã‚¿ã‚¹ã‚¯</button>
            <button class="nav-button">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</button>
        </div>
        <div class="header-right">
            <!-- Googleèªè¨¼ãƒœã‚¿ãƒ³/ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆæœ€å³ï¼‰ -->
            <div id="googleSignInContainer" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                <!-- ãƒ­ã‚°ã‚¤ãƒ³å‰: Googleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
                <div id="googleSignInButton" style="display: inline-block;"></div>
                
                <!-- ãƒ­ã‚°ã‚¤ãƒ³å¾Œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º -->
                <div id="userInfo" style="display: none; align-items: center; gap: var(--spacing-sm);">
                    <img id="userAvatar" src="" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--color-border);">
                    <span id="userName" style="color: var(--color-text-primary); font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold);"></span>
                    <button class="nav-button" onclick="signOut()" style="padding: var(--spacing-xs) var(--spacing-sm);">
                        <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="main-container">
        <!-- ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ -->
        <div class="main-board">
            <!-- ã‚¿ã‚¹ã‚¯ã‚°ãƒªãƒƒãƒ‰ -->
            <div class="task-grid" id="taskGrid">
                <!-- ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
                <div class="pull-refresh-indicator" id="pullRefreshIndicator">
                    <div class="pull-refresh-spinner"></div>
                    <span>æ›´æ–°ä¸­...</span>
                </div>
                
                <!-- ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ’ãƒ³ãƒˆï¼ˆã‚¹ãƒãƒ›ç‰ˆã®ã¿ï¼‰ -->
                <div class="pull-refresh-hint" id="pullRefreshHint">
                    ã€Œæ›´æ–°ã€ã¯ç”»é¢ã‚’ä¸‹ã«ã²ã„ã¦ãã ã•ã„
                </div>
                
                <!-- æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆä¸‹éƒ¨ä¸­å¤®ã«å›ºå®šï¼‰ -->
                <button class="add-task-button" type="button" onclick="toggleTaskForm(event)">
                    +
                    <span class="tooltip-text">æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </span>
                </button>
                
                <!-- å®Œäº†ãƒœã‚¿ãƒ³ï¼ˆå·¦ä¸‹ã«å›ºå®šï¼‰ -->
                <div class="complete-button" id="completeButton">
                    <span class="complete-icon">âœ“</span>
                    <span class="tooltip-text">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§å®Œäº†</span>
                </div>
                
                <!-- ãƒãƒƒã‚¸ã‚’ä½œã‚‹ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šã«å›ºå®šãƒ»â—¯ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ -->
                <button class="add-badge-button" onclick="openBadgeForm()">
                    <span class="badge-icon-text">ğŸ·ï¸</span>
                    <span class="tooltip-text">ãƒãƒƒã‚¸ã‚’ä½œã‚‹</span>
                </button>
                
                <!-- ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary);">
                    <p>ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    <p style="font-size: var(--font-size-sm); margin-top: var(--spacing-sm);">å·¦ä¸‹ã®ã€Œ+ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ã‚´ãƒŸç®±ï¼ˆå³ä¸‹ã«å›ºå®šã€bodyç›´ä¸‹ã«é…ç½®ï¼‰ -->
    <div class="trash-bin" id="trashBin">
        <span class="trash-icon">ğŸ—‘ï¸</span>
        <span class="tooltip-text">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§å‰Šé™¤</span>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ‘ãƒãƒ«ï¼ˆå³ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼‰ -->
    <div class="detail-board-overlay" id="detailBoardOverlay" onclick="closeDetailBoardOnOverlay(event)">
        <div class="detail-board" id="detailBoard" onclick="event.stopPropagation()">
            <div class="detail-board-header">
                <div>
                    <h2 class="detail-title">ã‚¿ã‚¹ã‚¯è©³ç´°</h2>
                    <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm); margin: 0;">ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã§è©³ç´°ã®ã€Œç·¨é›†ã€ãŒè¡Œãˆã¾ã™ã€‚</p>
                </div>
                <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                    <button class="detail-time-record-button" id="detailTimeRecordButton" onclick="showTimeRecords()" style="display: none;">
                        <span style="font-size: 20px;">ğŸ•</span>
                        <span class="tooltip-text">ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰</span>
                    </button>
                    <button class="detail-edit-button" id="detailEditButton" onclick="toggleTaskEditMode()" style="display: none;">
                        <img src="images/ãƒªãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³.svg" alt="ç·¨é›†" class="detail-edit-icon">
                        <span class="tooltip-text">ã‚¿ã‚¹ã‚¯æƒ…å ±ã®ç·¨é›†ã¯ã“ã¡ã‚‰ã‹ã‚‰</span>
                    </button>
                <button class="detail-board-close-button" onclick="closeDetailBoard()" title="é–‰ã˜ã‚‹">Ã—</button>
                </div>
            </div>
            <div id="detailContent">
                <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary);">
                    <p>ã‚¿ã‚¹ã‚¯ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆå³ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼‰ -->
    <div class="time-record-panel-overlay" id="timeRecordPanelOverlay" onclick="closeTimeRecordPanelOnOverlay(event)">
        <div class="time-record-panel" id="timeRecordPanel" onclick="event.stopPropagation()">
            <div class="time-record-panel-header">
                <h2 class="time-record-panel-title">ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰</h2>
                <button class="time-record-panel-close-button" onclick="closeTimeRecordPanel()" title="é–‰ã˜ã‚‹">Ã—</button>
            </div>
            <div id="timeRecordContent">
                <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary);">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ãƒ‘ãƒãƒ«ã®ãƒãƒ³ãƒ‰ãƒ«ï¼ˆå·¦ç«¯ã«å›ºå®šã€5ã¤ï¼‰ -->
    <button class="slide-panel-handle panel-1" id="slidePanelHandle1" onclick="toggleSlidePanel(1)">
        <span class="tooltip-text">ãƒªãƒ³ã‚¯ãƒ‘ãƒãƒ«ã‚’é–‹ã</span>
    </button>
    <button class="slide-panel-handle panel-2" id="slidePanelHandle2" onclick="toggleSlidePanel(2)">
        <span class="tooltip-text">ãƒ•ãƒ­ãƒ³ãƒˆãƒ‘ãƒãƒ«ã‚’é–‹ã</span>
    </button>
    <button class="slide-panel-handle panel-3" id="slidePanelHandle3" onclick="toggleSlidePanel(3)">
        <span class="tooltip-text">ãƒãƒƒã‚¯ãƒ‘ãƒãƒ«ã‚’é–‹ã</span>
    </button>
    <button class="slide-panel-handle panel-4" id="slidePanelHandle4" onclick="toggleSlidePanel(4)">
        <span class="tooltip-text">ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ‘ãƒãƒ«ã‚’é–‹ã</span>
    </button>
    <button class="slide-panel-handle panel-5" id="slidePanelHandle5" onclick="toggleSlidePanel(5)">
        <span class="tooltip-text">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‘ãƒãƒ«ã‚’é–‹ã</span>
    </button>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚¿ã‚¹ã‚¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="modal-overlay" id="taskFormModal" onclick="closeModalOnOverlay(event)">
        <div class="task-form" onclick="event.stopPropagation()">
            <div class="task-form-header">
                <h3 class="task-form-title">æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ</h3>
                <button class="modal-close-button" onclick="cancelTaskForm()" title="é–‰ã˜ã‚‹">Ã—</button>
            </div>
            <form id="taskInputForm">
                <div class="form-group">
                    <label for="taskTitle">ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ« *</label>
                    <input type="text" id="taskTitle" name="title" required placeholder="ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label for="taskDescription">èª¬æ˜</label>
                    <textarea id="taskDescription" name="description" placeholder="ã‚¿ã‚¹ã‚¯ã®è©³ç´°ã‚’å…¥åŠ›"></textarea>
                </div>
                <div class="form-group">
                    <label for="taskCategory">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                    <select id="taskCategory" name="category">
                        <option value="design">ãƒ‡ã‚¶ã‚¤ãƒ³</option>
                        <option value="frontend">ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</option>
                        <option value="backend">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</option>
                        <option value="database">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</option>
                        <option value="media">ãƒ¡ãƒ‡ã‚£ã‚¢</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskPriority">å„ªå…ˆåº¦</label>
                    <select id="taskPriority" name="priority">
                        <option value="low">ä½</option>
                        <option value="medium" selected>ä¸­</option>
                        <option value="high">é«˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskEstimatedTime">äºˆæƒ³ä½œæ¥­æ™‚é–“</label>
                    <select id="taskEstimatedTime" name="estimatedTime">
                        <option value="">æœªè¨­å®š</option>
                        <option value="10">10åˆ†</option>
                        <option value="20">20åˆ†</option>
                        <option value="30">30åˆ†</option>
                        <option value="40">40åˆ†</option>
                        <option value="50">50åˆ†</option>
                        <option value="60">1æ™‚é–“</option>
                        <option value="70">1æ™‚é–“10åˆ†</option>
                        <option value="80">1æ™‚é–“20åˆ†</option>
                        <option value="90">1æ™‚é–“30åˆ†</option>
                        <option value="100">1æ™‚é–“40åˆ†</option>
                        <option value="110">1æ™‚é–“50åˆ†</option>
                        <option value="120">2æ™‚é–“</option>
                        <option value="150">2æ™‚é–“30åˆ†</option>
                        <option value="180">3æ™‚é–“</option>
                        <option value="240">4æ™‚é–“</option>
                        <option value="300">5æ™‚é–“</option>
                        <option value="360">6æ™‚é–“</option>
                        <option value="480">8æ™‚é–“</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cancelTaskForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒãƒƒã‚¸ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="modal-overlay" id="badgeFormModal" onclick="closeBadgeFormOnOverlay(event)">
        <div class="task-form" onclick="event.stopPropagation()">
            <div class="task-form-header">
                <h3 class="task-form-title">æ–°ã—ã„ãƒãƒƒã‚¸ã‚’ä½œæˆ</h3>
                <button class="modal-close-button" onclick="cancelBadgeForm()" title="é–‰ã˜ã‚‹">Ã—</button>
            </div>
            <form id="badgeInputForm">
                <div class="form-group">
                    <label for="badgeName">ãƒãƒƒã‚¸åï¼ˆæ‹…å½“è€…åï¼‰*</label>
                    <input type="text" id="badgeName" name="name" required placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ">
                </div>
                <div class="form-group">
                    <label for="badgeIcon">ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰</label>
                    <input type="text" id="badgeIcon" name="icon" placeholder="ä¾‹: ğŸ‘¤ ğŸ§‘â€ğŸ’» ğŸ‘¨â€ğŸ’¼">
                </div>
                <div class="form-group">
                    <label for="badgeColor">ã‚«ãƒ©ãƒ¼</label>
                    <input type="color" id="badgeColor" name="color" value="#FF679C">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="cancelBadgeForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-google" id="createFromGoogleBtn" onclick="createBadgeFromGoogle()" style="display: none; background: #4285F4; color: white; margin-right: 8px;">ğŸ”µ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ä½œæˆ</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ãƒ‘ãƒãƒ«ï¼ˆå·¦ã‹ã‚‰å³ã«ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã€5ã¤ï¼‰ -->
    <!-- ãƒ‘ãƒãƒ«1ï¼ˆãƒ”ãƒ³ã‚¯ï¼šãƒªãƒ³ã‚¯ãƒ‘ãƒãƒ«ï¼‰ -->
    <div class="slide-panel-overlay" id="slidePanelOverlay1" onclick="closeSlidePanelOnOverlay(event, 1)">
        <div class="slide-panel panel-1" id="slidePanel1" onclick="event.stopPropagation()">
            <div class="slide-panel-header panel-1">
                <h2 class="slide-panel-title">ãƒªãƒ³ã‚¯ãƒ‘ãƒãƒ«</h2>
                <button class="slide-panel-close-button" onclick="closeSlidePanel(1)" title="é–‰ã˜ã‚‹">Ã—</button>
            </div>
            <div class="slide-panel-content">
                <!-- ãƒªãƒ³ã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div style="padding: var(--spacing-md); margin-bottom: var(--spacing-md); background: var(--color-background-secondary); border-radius: var(--border-radius-md);">
                    <h3 style="font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); margin-bottom: var(--spacing-sm); color: var(--color-text-primary);">å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚’è¿½åŠ </h3>
                    <form id="linkAddForm" style="display: flex; gap: var(--spacing-sm); align-items: flex-end;">
                        <div style="flex: 1;">
                            <label for="linkUrl" style="display: block; font-size: var(--font-size-sm); margin-bottom: 4px; color: var(--color-text-secondary);">URL *</label>
                            <input type="url" id="linkUrl" required placeholder="https://example.com" style="width: 100%; padding: var(--spacing-xs); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); font-size: var(--font-size-sm);">
                </div>
                        <div style="flex: 1;">
                            <label for="linkTitle" style="display: block; font-size: var(--font-size-sm); margin-bottom: 4px; color: var(--color-text-secondary);">ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰</label>
                            <input type="text" id="linkTitle" placeholder="ãƒªãƒ³ã‚¯å" style="width: 100%; padding: var(--spacing-xs); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); font-size: var(--font-size-sm);">
            </div>
                        <button type="submit" class="btn btn-primary" style="padding: var(--spacing-xs) var(--spacing-md); font-size: var(--font-size-sm);">è¿½åŠ </button>
                    </form>
        </div>
                
                <!-- ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚°ãƒªãƒƒãƒ‰ -->
                <div id="linkIconGrid" class="link-icon-grid">
                    <!-- ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ãƒãƒ«2ï¼ˆãƒ–ãƒ«ãƒ¼ï¼šãƒ•ãƒ­ãƒ³ãƒˆï¼‰ -->
    <div class="slide-panel-overlay" id="slidePanelOverlay2" onclick="closeSlidePanelOnOverlay(event, 2)">
        <div class="slide-panel panel-2" id="slidePanel2" onclick="event.stopPropagation()">
            <div class="slide-panel-header panel-2">
                <h2 class="slide-panel-title">ãƒ•ãƒ­ãƒ³ãƒˆ</h2>
                <button class="slide-panel-close-button" onclick="closeSlidePanel(2)" title="é–‰ã˜ã‚‹">Ã—</button>
            </div>
            <div class="slide-panel-content">
                <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">
                    ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã®ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ‘ãƒãƒ«ã§ã™ã€‚
                </p>
                <div style="padding: var(--spacing-lg); background: var(--color-background-secondary); border-radius: var(--border-radius-md);">
                    <h3 style="font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); margin-bottom: var(--spacing-md); color: var(--color-text-primary);">ãƒ•ãƒ­ãƒ³ãƒˆã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h3>
                    <p style="color: var(--color-text-secondary);">ã“ã“ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–¢é€£ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ç½®ã§ãã¾ã™ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ãƒãƒ«3ï¼ˆã‚°ãƒªãƒ¼ãƒ³ï¼šãƒãƒƒã‚¯ï¼‰ -->
    <div class="slide-panel-overlay" id="slidePanelOverlay3" onclick="closeSlidePanelOnOverlay(event, 3)">
        <div class="slide-panel panel-3" id="slidePanel3" onclick="event.stopPropagation()">
            <div class="slide-panel-header panel-3">
                <h2 class="slide-panel-title">ãƒãƒƒã‚¯</h2>
                <button class="slide-panel-close-button" onclick="closeSlidePanel(3)" title="é–‰ã˜ã‚‹">Ã—</button>
            </div>
            <div class="slide-panel-content">
                <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">
                    ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã®ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ‘ãƒãƒ«ã§ã™ã€‚
                </p>
                <div style="padding: var(--spacing-lg); background: var(--color-background-secondary); border-radius: var(--border-radius-md);">
                    <h3 style="font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); margin-bottom: var(--spacing-md); color: var(--color-text-primary);">ãƒãƒƒã‚¯ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h3>
                    <p style="color: var(--color-text-secondary);">ã“ã“ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢é€£ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ç½®ã§ãã¾ã™ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ãƒãƒ«4ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼šãƒ¡ãƒ‡ã‚£ã‚¢ï¼‰ -->
    <div class="slide-panel-overlay" id="slidePanelOverlay4" onclick="closeSlidePanelOnOverlay(event, 4)">
        <div class="slide-panel panel-4" id="slidePanel4" onclick="event.stopPropagation()">
            <div class="slide-panel-header panel-4">
                <h2 class="slide-panel-title">ãƒ¡ãƒ‡ã‚£ã‚¢</h2>
                <button class="slide-panel-close-button" onclick="closeSlidePanel(4)" title="é–‰ã˜ã‚‹">Ã—</button>
            </div>
            <div class="slide-panel-content">
                <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">
                    ãƒ¡ãƒ‡ã‚£ã‚¢é–¢é€£ã®ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ‘ãƒãƒ«ã§ã™ã€‚
                </p>
                <div style="padding: var(--spacing-lg); background: var(--color-background-secondary); border-radius: var(--border-radius-md);">
                    <h3 style="font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); margin-bottom: var(--spacing-md); color: var(--color-text-primary);">ãƒ¡ãƒ‡ã‚£ã‚¢ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h3>
                    <p style="color: var(--color-text-secondary);">ã“ã“ã«ãƒ¡ãƒ‡ã‚£ã‚¢é–¢é€£ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ç½®ã§ãã¾ã™ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ãƒãƒ«5ï¼ˆãƒ‘ãƒ¼ãƒ—ãƒ«ï¼šã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰ -->
    <div class="slide-panel-overlay" id="slidePanelOverlay5" onclick="closeSlidePanelOnOverlay(event, 5)">
        <div class="slide-panel panel-5" id="slidePanel5" onclick="event.stopPropagation()">
            <div class="slide-panel-header panel-5">
                <h2 class="slide-panel-title">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</h2>
                <button class="slide-panel-close-button" onclick="closeSlidePanel(5)" title="é–‰ã˜ã‚‹">Ã—</button>
            </div>
            <div class="slide-panel-content">
                <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ -->
                <div class="archive-filter" style="padding: var(--spacing-md); margin-bottom: var(--spacing-md); background: var(--color-background-secondary); border-radius: var(--border-radius-md);">
                    <h3 style="font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); margin-bottom: var(--spacing-sm); color: var(--color-text-primary);">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                    <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 120px;">
                            <label style="display: block; font-size: var(--font-size-xs); margin-bottom: 4px; color: var(--color-text-secondary);">æ—¥ä»˜</label>
                            <select id="archiveFilterDate" style="width: 100%; padding: var(--spacing-xs); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); font-size: var(--font-size-sm);">
                                <option value="all">ã™ã¹ã¦</option>
                                <option value="today">ä»Šæ—¥</option>
                                <option value="week">ä»Šé€±</option>
                                <option value="month">ä»Šæœˆ</option>
                                <option value="year">ä»Šå¹´</option>
                            </select>
                </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label style="display: block; font-size: var(--font-size-xs); margin-bottom: 4px; color: var(--color-text-secondary);">æ‹…å½“è€…</label>
                            <select id="archiveFilterAssignee" style="width: 100%; padding: var(--spacing-xs); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); font-size: var(--font-size-sm);">
                                <option value="all">ã™ã¹ã¦</option>
                            </select>
            </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label style="display: block; font-size: var(--font-size-xs); margin-bottom: 4px; color: var(--color-text-secondary);">ã‚«ãƒ†ã‚´ãƒª</label>
                            <select id="archiveFilterCategory" style="width: 100%; padding: var(--spacing-xs); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); font-size: var(--font-size-sm);">
                                <option value="all">ã™ã¹ã¦</option>
                                <option value="design">ãƒ‡ã‚¶ã‚¤ãƒ³</option>
                                <option value="frontend">ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</option>
                                <option value="backend">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</option>
                                <option value="database">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</option>
                                <option value="media">ãƒ¡ãƒ‡ã‚£ã‚¢</option>
                                <option value="other">ãã®ä»–</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label style="display: block; font-size: var(--font-size-xs); margin-bottom: 4px; color: var(--color-text-secondary);">æ¤œç´¢</label>
                            <input type="text" id="archiveFilterSearch" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã§æ¤œç´¢" style="width: 100%; padding: var(--spacing-xs); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); font-size: var(--font-size-sm);">
                        </div>
                    </div>
                </div>
                
                <!-- å®Œäº†æ¸ˆã‚¿ã‚¹ã‚¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– -->
                <div id="archiveTaskList" class="archive-task-list">
                    <!-- å®Œäº†æ¸ˆã‚¿ã‚¹ã‚¯ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    <p class="archive-empty">å®Œäº†æ¸ˆã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ========================================
           ğŸ”§ FirebaseåˆæœŸåŒ– (Firebase Initialization)
           ======================================== */
        
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDi2_U6INLm7sb-02GsdWzDl2qaFBe8US4",
            authDomain: "misesapo-progress.firebaseapp.com",
            databaseURL: "https://misesapo-progress-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "misesapo-progress",
            storageBucket: "misesapo-progress.firebasestorage.app",
            messagingSenderId: "926808186549",
            appId: "1:926808186549:web:91ce8534877c4ecf2e28fc",
            measurementId: "G-5JS29JLL13"
        };

        // FirebaseåˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        console.log('FirebaseåˆæœŸåŒ–é–‹å§‹');
        let firebaseInitialized = false;
        let db;
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('FirebaseåˆæœŸåŒ–æˆåŠŸ');
            } else {
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('Firebaseæ—¢ã«åˆæœŸåŒ–æ¸ˆã¿');
            }
        } catch (error) {
            console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            firebaseInitialized = false;
        }

        // Firestoreè¨­å®š
        if (firebaseInitialized && db) {
            console.log('Firestoreæ¥ç¶šæº–å‚™å®Œäº†');
        }

        // Googleèªè¨¼é–¢é€£
        let currentUser = null;
        
        // Googleèªè¨¼ã®åˆæœŸåŒ–
        function initializeGoogleSignIn() {
            // ========================================
            // Google OAuth 2.0 Client ID ã®è¨­å®šæ–¹æ³•
            // ========================================
            // 1. Google Cloud Console (https://console.cloud.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
            // 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã¾ãŸã¯é¸æŠ
            // 3. ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€Œèªè¨¼æƒ…å ±ã€ã«ç§»å‹•
            // 4. ã€Œèªè¨¼æƒ…å ±ã‚’ä½œæˆã€â†’ã€ŒOAuth 2.0 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ IDã€ã‚’é¸æŠ
            // 5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡: ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€
            // 6. æ‰¿èªæ¸ˆã¿ã® JavaScript ç”Ÿæˆå…ƒ:
            //    - é–‹ç™ºç’°å¢ƒ: http://localhost:8000 (ãƒãƒ¼ãƒˆç•ªå·ã¯ç’°å¢ƒã«å¿œã˜ã¦å¤‰æ›´)
            //    - æœ¬ç•ªç’°å¢ƒ: https://yourdomain.com
            // 7. æ‰¿èªæ¸ˆã¿ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI:
            //    - http://localhost:8000 (é–‹ç™ºç’°å¢ƒã®å ´åˆ)
            //    - https://yourdomain.com (æœ¬ç•ªç’°å¢ƒã®å ´åˆ)
            // 8. ä½œæˆã•ã‚ŒãŸClient IDã‚’ä»¥ä¸‹ã®å®šæ•°ã«è¨­å®šã—ã¦ãã ã•ã„
            // ========================================
            
            // Google Cloud Consoleã§å–å¾—ã—ãŸClient IDã‚’è¨­å®š
            // æ³¨æ„: å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€Client IDã‚’ç’°å¢ƒå¤‰æ•°ã‚„è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€
            // Client IDãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
            const CLIENT_ID = '926808186549-b0nhr610mnojulc9f8e679nh19ag58f1.apps.googleusercontent.com';
            
            // Client IDãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (!CLIENT_ID || CLIENT_ID.trim() === '') {
                console.warn('âš ï¸ Google Client IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Google Cloud Consoleã§Client IDã‚’å–å¾—ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¡¨ç¤º
                document.getElementById('googleSignInButton').innerHTML = 
                    '<button style="padding: 8px 16px; border: 1px solid #dadce0; border-radius: 4px; background: white; cursor: pointer; color: #3c4043; font-size: 14px;">Client IDã‚’è¨­å®šã—ã¦ãã ã•ã„</button>';
                return;
            }
            
            // Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!window.google || !window.google.accounts || !window.google.accounts.id) {
                console.error('âŒ Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
            const savedUser = localStorage.getItem('googleUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    displayUserInfo(currentUser);
                } catch (e) {
                    console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                    localStorage.removeItem('googleUser');
                }
            }
            
            try {
                // Google Sign-In ãƒœã‚¿ãƒ³ã‚’åˆæœŸåŒ–ï¼ˆFedCMå¯¾å¿œï¼‰
                window.google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: true,
                    // FedCMç§»è¡Œå¯¾å¿œ: use_fedcm_for_prompt ã‚’ true ã«è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    // use_fedcm_for_prompt: true
                });
                
                // Google Sign-In ãƒœã‚¿ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                if (!currentUser) {
                    window.google.accounts.id.renderButton(
                        document.getElementById('googleSignInButton'),
                        {
                            type: 'standard',
                            theme: 'outline',
                            size: 'medium',
                            text: 'signin_with',
                            shape: 'rectangular',
                            logo_alignment: 'left'
                        }
                    );
                    
                    // One Tap ã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰- FedCMç§»è¡Œè­¦å‘Šã‚’å›é¿ã™ã‚‹ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç„¡åŠ¹åŒ–
                    // å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„
                    /*
                    try {
                        window.google.accounts.id.prompt((notification) => {
                            // FedCMç§»è¡Œå¯¾å¿œ: isDismissedMoment() ã¨ getNotDisplayedReason() ã‚’ä½¿ç”¨
                            if (notification.isDismissedMoment && notification.isDismissedMoment()) {
                                console.log('One Tap ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦é–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ');
                            } else if (notification.getNotDisplayedReason) {
                                const reason = notification.getNotDisplayedReason();
                                if (reason !== 'browser_not_supported' && reason !== 'invalid_client') {
                                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®ã¿è¡¨ç¤ºï¼ˆè­¦å‘Šã¯å‡ºã•ãªã„ï¼‰
                                    console.log('One Tap ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ç†ç”±:', reason);
                                }
                            } else {
                                // æ—§APIã¨ã®äº’æ›æ€§
                                if (notification.isNotDisplayed || notification.isSkippedMoment) {
                                    console.log('One Tap ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                                }
                            }
                        });
                    } catch (e) {
                        console.warn('One Tap ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–å¯èƒ½ï¼‰:', e);
                        // One Tap UIã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ã—ã¦ç¶šè¡Œ
                    }
                    */
                }
            } catch (e) {
                console.error('Googleèªè¨¼ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
                document.getElementById('googleSignInButton').innerHTML = 
                    '<button style="padding: 8px 16px; border: 1px solid #dadce0; border-radius: 4px; background: white; cursor: pointer; color: #3c4043; font-size: 14px;" disabled>èªè¨¼ã‚¨ãƒ©ãƒ¼</button>';
            }
        }
        
        // Googleèªè¨¼æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        function handleCredentialResponse(response) {
            // JWT ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
            const payload = parseJwt(response.credential);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
            currentUser = {
                id: payload.sub,
                name: payload.name,
                email: payload.email,
                picture: payload.picture
            };
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('googleUser', JSON.stringify(currentUser));
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            displayUserInfo(currentUser);
            
            console.log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', currentUser.name, currentUser.email);
        }
        
        // JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('JWTè§£æã‚¨ãƒ©ãƒ¼:', e);
                return null;
            }
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
        function displayUserInfo(user) {
            const signInButton = document.getElementById('googleSignInButton');
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                signInButton.style.display = 'none';
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                userAvatar.src = user.picture || '';
                userName.textContent = user.name || user.email || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                userInfo.style.display = 'flex';
            } else {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’éè¡¨ç¤º
                userInfo.style.display = 'none';
                signInButton.style.display = 'inline-block';
            }
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function signOut() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å‰Šé™¤
            localStorage.removeItem('googleUser');
            currentUser = null;
            
            // Googleèªè¨¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            window.google.accounts.id.disableAutoSelect();
            
            // UIã‚’æ›´æ–°
            displayUserInfo(null);
            
            // Google Sign-In ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
            initializeGoogleSignIn();
            
            console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
        }
        
        // Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«åˆæœŸåŒ–
        window.addEventListener('load', function() {
            // Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…ã¤
            if (window.google && window.google.accounts && window.google.accounts.id) {
                initializeGoogleSignIn();
            } else {
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
                setTimeout(function() {
                    if (window.google && window.google.accounts && window.google.accounts.id) {
                        initializeGoogleSignIn();
                    } else {
                        console.error('Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                    }
                }, 1000);
            }
        });
        
        // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿
        let tasks = [];

        // ãƒãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿
        let badges = [];

        // ã‚¿ã‚¹ã‚¯ã«ç´ã¥ããƒãƒƒã‚¸ï¼ˆã‚¿ã‚¹ã‚¯IDã‚’ã‚­ãƒ¼ã«ã€ãƒãƒƒã‚¸IDã®é…åˆ—ã‚’å€¤ã«ï¼‰
        let taskBadges = {};
        
        // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆãƒãƒƒã‚¸ãŒã‚¿ã‚¹ã‚¯ã«ä»˜ã‘ã‚‰ã‚ŒãŸæ™‚é–“ã‹ã‚‰å®Œäº†ã¾ã§ã®æ™‚é–“ã‚’è¨˜éŒ²ï¼‰
        let timeRecords = [];
        // timeRecordsæ§‹é€ : [{ id, taskId, badgeId, startTime, endTime, duration, status }]

        /* ========================================
           ğŸ’¾ Firebaseãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ (Firebase Data Save & Load)
           ======================================== */

        // ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«ä¿å­˜
        async function saveTaskMarketData() {
            if (!firebaseInitialized || !db) {
                console.warn('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚localStorageã«ä¿å­˜ã—ã¾ã™ã€‚');
                // FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯localStorageã«ä¿å­˜
                localStorage.setItem('taskMarketTasks', JSON.stringify(tasks));
                localStorage.setItem('taskMarketBadges', JSON.stringify(badges));
                localStorage.setItem('taskMarketTaskBadges', JSON.stringify(taskBadges));
                localStorage.setItem('timeRecords', JSON.stringify(timeRecords));
                localStorage.setItem('externalLinks', JSON.stringify(externalLinks));
                return;
            }

            try {
                const payload = {
                    tasks: tasks,
                    badges: badges,
                    taskBadges: taskBadges,
                    timeRecords: timeRecords,
                    externalLinks: externalLinks,
                    _updatedAt: Date.now()
                };

                await db.collection('taskMarket').doc('main').set(payload, { merge: true });
                console.log('âœ… ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('âŒ Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                localStorage.setItem('taskMarketTasks', JSON.stringify(tasks));
                localStorage.setItem('taskMarketBadges', JSON.stringify(badges));
                localStorage.setItem('taskMarketTaskBadges', JSON.stringify(taskBadges));
                localStorage.setItem('timeRecords', JSON.stringify(timeRecords));
                localStorage.setItem('externalLinks', JSON.stringify(externalLinks));
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿
        async function loadTaskMarketData() {
            // 1) Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆæœ€å„ªå…ˆï¼‰
            if (firebaseInitialized && db) {
                try {
                    const doc = await db.collection('taskMarket').doc('main').get();
                    if (doc.exists) {
                        const data = doc.data();
                        console.log('ğŸ”¥ Firebaseã‹ã‚‰ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', data);
                        
                        if (data.tasks) tasks = data.tasks;
                        if (data.badges) badges = data.badges;
                        if (data.taskBadges) taskBadges = data.taskBadges;
                        if (data.timeRecords) timeRecords = data.timeRecords;
                        if (data.externalLinks) externalLinks = data.externalLinks;
                        
                        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’è¨­å®š
                        setupRealtimeListener();
                        
                        // UIã‚’æ›´æ–°
                        updateTaskGrid();
                        updateBadges();
                        updateLinkIconGrid();
                        updateArchivePanel();
                        
                        return;
                    }
                } catch (error) {
                    console.warn('Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            // 2) localStorageã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            try {
                const savedTasks = localStorage.getItem('taskMarketTasks');
                const savedBadges = localStorage.getItem('taskMarketBadges');
                const savedTaskBadges = localStorage.getItem('taskMarketTaskBadges');
                const savedTimeRecords = localStorage.getItem('timeRecords');
                const savedExternalLinks = localStorage.getItem('externalLinks');

                if (savedTasks) tasks = JSON.parse(savedTasks);
                if (savedBadges) badges = JSON.parse(savedBadges);
                if (savedTaskBadges) taskBadges = JSON.parse(savedTaskBadges);
                if (savedTimeRecords) timeRecords = JSON.parse(savedTimeRecords);
                if (savedExternalLinks) externalLinks = JSON.parse(savedExternalLinks);

                console.log('localStorageã‹ã‚‰ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');

                // UIã‚’æ›´æ–°
                updateTaskGrid();
                updateBadges();
                updateLinkIconGrid();
                updateArchivePanel();
            } catch (error) {
                console.warn('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆåˆå›èµ·å‹•æ™‚ï¼‰
                tasks = [];
                badges = [];
                taskBadges = {};
                timeRecords = [];
                externalLinks = [];
            }
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        function setupRealtimeListener() {
            if (!firebaseInitialized || !db) return;

            try {
                db.collection('taskMarket').doc('main').onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        console.log('ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’å—ä¿¡ã—ã¾ã—ãŸ:', data);
                        
                        // ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã®ã¿åæ˜ ï¼ˆè‡ªåˆ†è‡ªèº«ã®æ›´æ–°ã¯é™¤å¤–ï¼‰
                        if (data.tasks) tasks = data.tasks;
                        if (data.badges) badges = data.badges;
                        if (data.taskBadges) taskBadges = data.taskBadges;
                        if (data.timeRecords) timeRecords = data.timeRecords;
                        if (data.externalLinks) externalLinks = data.externalLinks;
                        
                        // UIã‚’æ›´æ–°
                        updateTaskGrid();
                        updateBadges();
                        updateLinkIconGrid();
                        updateArchivePanel();
                    }
                }, (error) => {
                    console.error('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                });
            } catch (error) {
                console.error('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒãƒƒã‚¸ã®ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ç®¡ç†
        let draggedBadgeGlobal = null;
        let draggedBadgeOffset = { x: 0, y: 0 };

        // ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
        function toggleTaskForm(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            const modal = document.getElementById('taskFormModal');
            if (!modal) return;
            
            // æ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
            if (modal.classList.contains('active')) {
                modal.classList.remove('active');
                document.getElementById('taskInputForm').reset();
                return;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            modal.classList.add('active');
            document.getElementById('taskInputForm').reset();
            
                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æœ€åˆã®å…¥åŠ›æ¬„ã«
                setTimeout(() => {
                const titleInput = document.getElementById('taskTitle');
                if (titleInput) {
                    titleInput.focus();
                }
                }, 100);
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼‰
        function cancelTaskForm() {
            const modal = document.getElementById('taskFormModal');
            modal.classList.remove('active');
            document.getElementById('taskInputForm').reset();
        }

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModalOnOverlay(event) {
            if (event.target.id === 'taskFormModal') {
                cancelTaskForm();
            }
        }

        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const taskModal = document.getElementById('taskFormModal');
                const badgeModal = document.getElementById('badgeFormModal');
                if (taskModal && taskModal.classList.contains('active')) {
                    cancelTaskForm();
                } else if (badgeModal && badgeModal.classList.contains('active')) {
                    cancelBadgeForm();
                }
            }
        });

        // ã‚¿ã‚¹ã‚¯ä½œæˆ
        const taskInputForm = document.getElementById('taskInputForm');
        if (taskInputForm) {
            taskInputForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
                const estimatedTime = formData.get('estimatedTime');
            const task = {
                id: Date.now(),
                title: formData.get('title'),
                description: formData.get('description'),
                category: formData.get('category'),
                priority: formData.get('priority'),
                    estimatedTime: estimatedTime ? parseInt(estimatedTime) : null, // åˆ†å˜ä½
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            tasks.push(task);
            updateTaskGrid();
            saveTaskMarketData(); // Firebaseã«ä¿å­˜
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            cancelTaskForm();
        });
        }

        // ãƒãƒƒã‚¸ä½œæˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        function openBadgeForm() {
            const modal = document.getElementById('badgeFormModal');
            modal.classList.add('active');
            document.getElementById('badgeInputForm').reset();
            
            // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const googleBtn = document.getElementById('createFromGoogleBtn');
            if (currentUser) {
                googleBtn.style.display = 'inline-block';
            } else {
                googleBtn.style.display = 'none';
            }
            
            setTimeout(() => {
                document.getElementById('badgeName').focus();
            }, 100);
        }

        // ãƒãƒƒã‚¸ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelBadgeForm() {
            const modal = document.getElementById('badgeFormModal');
            modal.classList.remove('active');
            document.getElementById('badgeInputForm').reset();
        }

        // ãƒãƒƒã‚¸ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯
        function closeBadgeFormOnOverlay(event) {
            if (event.target.id === 'badgeFormModal') {
                cancelBadgeForm();
            }
        }

        // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ãƒãƒƒã‚¸ã‚’ä½œæˆ
        function createBadgeFromGoogle() {
            if (!currentUser) {
                alert('Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // æ—¢ã«åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒƒã‚¸ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            const existingBadge = badges.find(b => b.userId === currentUser.id);
            if (existingBadge) {
                if (confirm(`æ—¢ã«ã€Œ${existingBadge.name}ã€ã®ãƒãƒƒã‚¸ãŒå­˜åœ¨ã—ã¾ã™ã€‚æ–°ã—ãä½œæˆã—ã¾ã™ã‹ï¼Ÿ`)) {
                    // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤
                    badges = badges.filter(b => b.id !== existingBadge.id);
                } else {
                    return;
                }
            }
            
            // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‹ã‚‰ãƒãƒƒã‚¸ã‚’ä½œæˆ
            const badge = {
                id: Date.now(),
                userId: currentUser.id,
                name: currentUser.name || currentUser.email || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                icon: currentUser.picture ? `img:${currentUser.picture}` : 'ğŸ‘¤',
                color: '#FF679C',
                email: currentUser.email,
                picture: currentUser.picture,
                position: {
                    top: Math.random() * 300 + 100,
                    left: Math.random() * 300 + 100
                },
                attachedToTaskId: null,
                createdAt: new Date().toISOString()
            };
            
            badges.push(badge);
            updateBadges();
            saveTaskMarketData(); // Firebaseã«ä¿å­˜
            cancelBadgeForm();
            
            console.log('Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ãƒãƒƒã‚¸ã‚’ä½œæˆã—ã¾ã—ãŸ:', badge);
        }

        // ãƒãƒƒã‚¸ä½œæˆ
        const badgeInputForm = document.getElementById('badgeInputForm');
        if (badgeInputForm) {
            badgeInputForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const badge = {
                id: Date.now(),
                name: formData.get('name'),
                icon: formData.get('icon') || 'ğŸ‘¤',
                color: formData.get('color') || '#FF679C',
                position: {
                    top: Math.random() * 300 + 100,
                    left: Math.random() * 300 + 100
                },
                attachedToTaskId: null // ã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ã¦ã„ãªã„å ´åˆã¯null
            };

            badges.push(badge);
            updateBadges();
            saveTaskMarketData(); // Firebaseã«ä¿å­˜
            cancelBadgeForm();
        });
        }

        // ã‚¿ã‚¹ã‚¯ã‚°ãƒªãƒƒãƒ‰æ›´æ–°ï¼ˆæ²ç¤ºæ¿é¢¨ã®ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ï¼‰
        function updateTaskGrid() {
            const taskGrid = document.getElementById('taskGrid');
            
            // ãƒ’ãƒ³ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚¹ãƒãƒ›ç‰ˆã®ã¿ï¼‰
            if (window.innerWidth <= 430) {
            if (tasks.length === 0) {
                    taskGrid.classList.remove('has-tasks');
                    taskGrid.classList.add('scroll-top');
                } else {
                    taskGrid.classList.add('has-tasks');
                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°ï¼ˆåˆæœŸåŒ–æ™‚ã¯æœ€ä¸Šéƒ¨ã¨ã¿ãªã™ï¼‰
                    setTimeout(() => {
                        updatePullRefreshHint();
                    }, 100);
                }
            }
            
            // å®Œäº†ã—ã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
            const pendingTasksCount = tasks.filter(task => task.status !== 'completed').length;
            
            if (pendingTasksCount === 0) {
                // ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒœã‚¿ãƒ³ã¯æ®‹ã™ã€ã‚´ãƒŸç®±ã¯taskGridå¤–ã«å›ºå®šã•ã‚Œã¦ã„ã‚‹ã®ã§é™¤å¤–ï¼‰
                const addButton = taskGrid.querySelector('.add-task-button');
                const completeButton = taskGrid.querySelector('.complete-button');
                const addBadgeButton = taskGrid.querySelector('.add-badge-button');
                // ã‚´ãƒŸç®±ã¯taskGridå¤–ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€querySelectorã—ãªã„
                taskGrid.innerHTML = '';
                
                // ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
                if (addButton) {
                    taskGrid.appendChild(addButton);
                } else {
                    const button = document.createElement('button');
                    button.className = 'add-task-button';
                    button.type = 'button';
                    button.setAttribute('onclick', 'toggleTaskForm(event)');
                    button.innerHTML = '+<span class="tooltip-text">æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </span>';
                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç›´æ¥è¿½åŠ ï¼ˆonclickå±æ€§ã¨ä½µç”¨ï¼‰
                    button.addEventListener('click', function(e) {
                        toggleTaskForm(e);
                    });
                    taskGrid.appendChild(button);
                }
                
                // å®Œäº†ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
                if (completeButton) {
                    taskGrid.appendChild(completeButton);
                } else {
                    const complete = document.createElement('div');
                    complete.className = 'complete-button';
                    complete.id = 'completeButton';
                    complete.innerHTML = '<span class="complete-icon">âœ“</span><span class="tooltip-text">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§å®Œäº†</span>';
                    taskGrid.appendChild(complete);
                    // å®Œäº†ãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†è¨­å®š
                    completeButtonHandlerSet = false;
                    setupCompleteButtonDrop(); // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚’å†è¨­å®š
                }
                
                // ãƒãƒƒã‚¸ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
                if (addBadgeButton) {
                    taskGrid.appendChild(addBadgeButton);
                } else {
                    const badgeButton = document.createElement('button');
                    badgeButton.className = 'add-badge-button';
                    badgeButton.onclick = openBadgeForm;
                    badgeButton.innerHTML = '<span class="badge-icon-text">ğŸ·ï¸</span><span class="tooltip-text">ãƒãƒƒã‚¸ã‚’ä½œã‚‹</span>';
                    taskGrid.appendChild(badgeButton);
                }
                
                // ã‚´ãƒŸç®±ã¯taskGridå¤–ã«é…ç½®ï¼ˆposition: fixedã§ç”»é¢å³ä¸‹ã«å›ºå®šï¼‰
                // taskGridå†…ã«ã¯è¿½åŠ ã—ãªã„
                
                const emptyMessage = document.createElement('div');
                emptyMessage.style.cssText = 'text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);';
                
                // PCç‰ˆã¨SPç‰ˆã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†ã‘ã‚‹
                const isMobile = window.innerWidth <= 430;
                const createMessage = isMobile ? 'ã€Œ+ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ' : 'ã€Œ+ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯';
                
                emptyMessage.innerHTML = `
                    <p>ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆã¯${createMessage}</p>
                `;
                taskGrid.appendChild(emptyMessage);
                return;
            }

            // ã‚°ãƒªãƒƒãƒ‰ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const gridWidth = taskGrid.offsetWidth - 48; // paddingåˆ†ã‚’å¼•ã
            const gridHeight = Math.max(800, taskGrid.offsetHeight - 48);
            const cardWidth = 280;
            const cardHeight = 180;

            // ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒœã‚¿ãƒ³ã¯æ®‹ã™ã€ã‚´ãƒŸç®±ã¯taskGridå¤–ã«å›ºå®šã•ã‚Œã¦ã„ã‚‹ã®ã§é™¤å¤–ï¼‰
            const addButton = taskGrid.querySelector('.add-task-button');
            const completeButton = taskGrid.querySelector('.complete-button');
            const addBadgeButton = taskGrid.querySelector('.add-badge-button');
            // ã‚´ãƒŸç®±ã¯taskGridå¤–ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€querySelectorã—ãªã„
            taskGrid.innerHTML = '';
            
            // ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
            if (addButton) {
                taskGrid.appendChild(addButton);
            } else {
                const button = document.createElement('button');
                button.className = 'add-task-button';
                button.onclick = toggleTaskForm;
                button.innerHTML = '+<span class="tooltip-text">æ–°è¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </span>';
                taskGrid.appendChild(button);
            }
            
            // å®Œäº†ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
            if (completeButton) {
                taskGrid.appendChild(completeButton);
            } else {
                const complete = document.createElement('div');
                complete.className = 'complete-button';
                complete.id = 'completeButton';
                complete.innerHTML = '<span class="complete-icon">âœ“</span><span class="tooltip-text">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§å®Œäº†</span>';
                taskGrid.appendChild(complete);
                // å®Œäº†ãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†è¨­å®š
                completeButtonHandlerSet = false;
                setupCompleteButtonDrop(); // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚’å†è¨­å®š
            }
            
            // ãƒãƒƒã‚¸ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
            if (addBadgeButton) {
                taskGrid.appendChild(addBadgeButton);
            } else {
                const badgeButton = document.createElement('button');
                badgeButton.className = 'add-badge-button';
                badgeButton.onclick = openBadgeForm;
                badgeButton.innerHTML = '<span class="badge-icon-text">ğŸ·ï¸</span><span class="tooltip-text">ãƒãƒƒã‚¸ã‚’ä½œã‚‹</span>';
                taskGrid.appendChild(badgeButton);
            }
            
            // ã‚´ãƒŸç®±ã¯taskGridå¤–ã«é…ç½®ï¼ˆposition: fixedã§ç”»é¢å³ä¸‹ã«å›ºå®šï¼‰
            // taskGridå†…ã«ã¯è¿½åŠ ã—ãªã„
            
            // é…ç½®æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã®ä½ç½®ã‚’è¨˜éŒ²
            const placedCards = [];

            // å®Œäº†ã—ã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤ºï¼ˆpendingã‚¿ã‚¹ã‚¯ã®ã¿ï¼‰
            const pendingTasks = tasks.filter(task => task.status !== 'completed');

            // å„ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«é…ç½®ï¼ˆã¾ãŸã¯ä¿å­˜ã•ã‚ŒãŸä½ç½®ã‚’ä½¿ç”¨ï¼‰
            let hasPositionUpdates = false;
            pendingTasks.forEach((task, index) => {
                const card = document.createElement('div');
                card.className = `task-card category-${task.category}`;
                card.draggable = true;
                card.dataset.taskId = task.id;
                card.dataset.isDragging = 'false';
                card.dataset.hasDragged = 'false';
                
                // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå³ãƒ‘ãƒãƒ«ã‚’å±•é–‹ï¼‰
                card.addEventListener('dblclick', function(e) {
                    // ãƒ‰ãƒ©ãƒƒã‚°ã§ãªã„å ´åˆã®ã¿ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®Ÿè¡Œ
                    if (this.dataset.hasDragged === 'false' && this.dataset.isDragging === 'false') {
                        e.stopPropagation();
                        showTaskDetail(task.id);
                    }
                });
                
                let top, left, rotation, zIndex;
                
                // ä¿å­˜ã•ã‚ŒãŸä½ç½®ãŒã‚ã‚Œã°ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
                // ç›¸å¯¾ä½ç½®ï¼ˆ%ï¼‰ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ã—ã€çµ¶å¯¾ä½ç½®ï¼ˆpxï¼‰ã¯å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã‚µãƒãƒ¼ãƒˆ
                if (task.position) {
                    if (task.position.leftPercent !== undefined && task.position.topPercent !== undefined) {
                        // ç›¸å¯¾ä½ç½®ï¼ˆ%ï¼‰ã‹ã‚‰çµ¶å¯¾ä½ç½®ï¼ˆpxï¼‰ã«å¤‰æ›
                        left = (task.position.leftPercent / 100) * gridWidth;
                        top = (task.position.topPercent / 100) * gridHeight;
                    } else if (task.position.left !== undefined && task.position.top !== undefined) {
                        // æ—¢å­˜ã®çµ¶å¯¾ä½ç½®ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰- ç¾åœ¨ã®ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦æ­£è¦åŒ–
                        // å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯100%å¹…ã‚’1920pxã€100%é«˜ã•ã‚’1080pxã¨ä»®å®šã—ã¦å¤‰æ›
                        const oldGridWidth = 1920 - 48;
                        const oldGridHeight = 1080 - 48;
                        const leftPercent = (task.position.left / oldGridWidth) * 100;
                        const topPercent = (task.position.top / oldGridHeight) * 100;
                        // æ–°ã—ã„ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã«å¤‰æ›
                        left = (leftPercent / 100) * gridWidth;
                        top = (topPercent / 100) * gridHeight;
                        // ç›¸å¯¾ä½ç½®ã¨ã—ã¦ä¿å­˜ã—ç›´ã™
                        if (!task.position.leftPercent) task.position.leftPercent = leftPercent;
                        if (!task.position.topPercent) task.position.topPercent = topPercent;
                    } else {
                        // ä½ç½®æƒ…å ±ãªã— - ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ã«ç¶šã
                        left = undefined;
                        top = undefined;
                    }
                    rotation = task.position.rotation || (Math.random() - 0.5) * 8;
                    zIndex = task.position.zIndex || Math.floor(Math.random() * 11);
                }
                
                if (left === undefined || top === undefined) {
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã‚’è¨ˆç®—ï¼ˆé‡ãªã‚Šã‚’é¿ã‘ã‚‹ï¼‰
                    let attempts = 0;
                    const maxAttempts = 50;
                    
                    do {
                        top = Math.random() * Math.max(0, gridHeight - cardHeight);
                        left = Math.random() * Math.max(0, gridWidth - cardWidth);
                        rotation = (Math.random() - 0.5) * 8; // -4åº¦ã‹ã‚‰+4åº¦ã®ç¯„å›²
                        attempts++;
                        
                        // æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã¨ã®é‡ãªã‚Šã‚’ãƒã‚§ãƒƒã‚¯
                        let overlaps = false;
                        for (let i = 0; i < placedCards.length; i++) {
                            const placed = placedCards[i];
                            // ç°¡æ˜“çš„ãªé‡ãªã‚Šãƒã‚§ãƒƒã‚¯ï¼ˆä½™ç™½20pxã‚’è€ƒæ…®ï¼‰
                            const margin = 20;
                            if (!(left + cardWidth + margin < placed.left ||
                                  left > placed.left + placed.width + margin ||
                                  top + cardHeight + margin < placed.top ||
                                  top > placed.top + placed.height + margin)) {
                                overlaps = true;
                                break;
                            }
                        }
                        
                        if (!overlaps || attempts >= maxAttempts) break;
                    } while (attempts < maxAttempts);
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªz-indexã‚’è¨­å®šï¼ˆ0ã€œ10ã®ç¯„å›²ï¼‰
                    zIndex = Math.floor(Math.random() * 11);
                    
                    // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã«ä½ç½®æƒ…å ±ã‚’ä¿å­˜ï¼ˆç›¸å¯¾ä½ç½®ï¼ˆ%ï¼‰ã§ä¿å­˜ï¼‰
                    if (!task.position) {
                        task.position = {};
                    }
                    // ç›¸å¯¾ä½ç½®ï¼ˆ%ï¼‰ã‚’è¨ˆç®—ã—ã¦ä¿å­˜
                    task.position.leftPercent = (left / gridWidth) * 100;
                    task.position.topPercent = (top / gridHeight) * 100;
                    task.position.rotation = rotation;
                    task.position.zIndex = zIndex;
                } else {
                    // æ—¢å­˜ã®ä½ç½®ã‹ã‚‰ç›¸å¯¾ä½ç½®ã‚’æ›´æ–°ï¼ˆã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸå ´åˆã®èª¿æ•´ï¼‰
                    if (task.position.leftPercent !== undefined && task.position.topPercent !== undefined) {
                        // ç›¸å¯¾ä½ç½®ã‹ã‚‰æ–°ã—ã„çµ¶å¯¾ä½ç½®ã‚’è¨ˆç®—ï¼ˆæ—¢ã«è¨ˆç®—æ¸ˆã¿ï¼‰
                        // ç›¸å¯¾ä½ç½®ã¯ãã®ã¾ã¾ä¿æŒ
                    }
                }
                
                // é…ç½®æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã®ä½ç½®ã‚’è¨˜éŒ²
                placedCards.push({
                    left: left,
                    top: top,
                    width: cardWidth,
                    height: cardHeight
                });
                
                card.style.top = top + 'px';
                card.style.left = left + 'px';
                card.style.transform = `rotate(${rotation}deg)`;
                card.style.zIndex = zIndex;
                
                // ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ‘ã‚¹ã‚’å–å¾—
                const categoryIconPath = getCategoryIconPath(task.category);
                const categoryIconHtml = categoryIconPath ? 
                    `<img src="${categoryIconPath}" alt="${getCategoryName(task.category)}" class="task-card-footer-icon">` : 
                    '';
                
                card.innerHTML = `
                    <span class="tooltip-text task-card-tooltip">ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º</span>
                    <div class="task-card-header">
                        <div class="task-card-title">${task.title}</div>
                        <div class="task-card-priority">${getPriorityStars(task.priority)}</div>
                    </div>
                    <div class="task-card-description">${task.description || 'èª¬æ˜ãªã—'}</div>
                    <div class="task-card-footer">
                        <div class="task-card-category">
                            ${categoryIconHtml}
                            <span>${getCategoryName(task.category)}</span>
                        </div>
                    </div>
                `;
                
                // ã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ãŸãƒãƒƒã‚¸ã‚’è¡¨ç¤º
                if (taskBadges[task.id] && taskBadges[task.id].length > 0) {
                    taskBadges[task.id].forEach((badgeId, index) => {
                        const badge = badges.find(b => b.id === badgeId);
                        if (badge && badge.attachedToTaskId === task.id) {
                            const badgeElement = createAttachedBadgeElement(badge, index);
                            card.appendChild(badgeElement);
                            card.classList.add('badge-attached');
                        }
                    });
                }
                
                taskGrid.appendChild(card);
                
                // ã‚«ãƒ¼ãƒ‰ã¸ã®ãƒãƒƒã‚¸å¸ç€æ©Ÿèƒ½ã‚’è¨­å®š
                setupTaskCardBadgeDrop(card, task);
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            setupDragAndDrop();
            
            // ãƒãƒƒã‚¸ã‚’æ›´æ–°ï¼ˆã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ã¦ã„ãªã„ã‚‚ã®ã‚’è¡¨ç¤ºï¼‰
            updateBadges();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã®è¨­å®š
        function setupDragAndDrop() {
            const taskGrid = document.getElementById('taskGrid');
            const taskCards = taskGrid.querySelectorAll('.task-card');
            
            let draggedCard = null;
            let draggedOffset = { x: 0, y: 0 };
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç”¨ã®å¤‰æ•°ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
            let touchStartX = 0;
            let touchStartY = 0;
            let cardStartX = 0;
            let cardStartY = 0;
            let isDragging = false;
            let touchTimeout = null;
            let currentTouchedCard = null;
            let selectedCard = null;
            let selectedBadge = null;
            
            // ã‚«ãƒ¼ãƒ‰é¸æŠã‚’è§£é™¤ã™ã‚‹é–¢æ•°
            function deselectAllCards() {
                const allCards = taskGrid.querySelectorAll('.task-card');
                allCards.forEach(c => {
                    c.classList.remove('selected');
                    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼‰
                    const tooltip = c.querySelector('.task-card-tooltip');
                    if (tooltip && window.innerWidth <= 430) {
                        tooltip.style.opacity = '0';
                        tooltip.style.visibility = 'hidden';
                    }
                });
                selectedCard = null;
            }
            
            // ãƒãƒƒã‚¸é¸æŠã‚’è§£é™¤ã™ã‚‹é–¢æ•°
            function deselectAllBadges() {
                const allBadges = taskGrid.querySelectorAll('.badge');
                allBadges.forEach(b => {
                    b.classList.remove('selected');
                });
                selectedBadge = null;
            }
            
            // ã‚°ãƒªãƒƒãƒ‰å¤–ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰é¸æŠè§£é™¤ã¨ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—éè¡¨ç¤º
            taskGrid.addEventListener('touchstart', function(e) {
                if (!e.target.closest('.task-card') && !e.target.closest('.badge')) {
                    deselectAllCards();
                    // ãƒãƒƒã‚¸ã®é¸æŠã‚‚è§£é™¤
                    deselectAllBadges();
                }
            }, { passive: true });
            
            // ãƒšãƒ¼ã‚¸å…¨ä½“ã§ä½•ã‚‚ãªã„å ´æ‰€ã‚’ã‚¿ãƒƒãƒã—ãŸå ´åˆã‚‚é¸æŠè§£é™¤
            document.addEventListener('touchstart', function(e) {
                if (window.innerWidth <= 430) {
                    // ã‚«ãƒ¼ãƒ‰ã€ãƒãƒƒã‚¸ã€ãƒœã‚¿ãƒ³ä»¥å¤–ã‚’ã‚¿ãƒƒãƒã—ãŸå ´åˆ
                    if (!e.target.closest('.task-card') && 
                        !e.target.closest('.badge') && 
                        !e.target.closest('button') &&
                        !e.target.closest('.modal') &&
                        !e.target.closest('.slide-panel')) {
                        deselectAllCards();
                        deselectAllBadges();
                    }
                }
            }, { passive: true });
            
            // ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼‰
            if (window.innerWidth <= 430) {
                setupPullRefresh();
            }
            
            taskCards.forEach(card => {
                const taskId = parseInt(card.dataset.taskId);
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;
                
                // ã‚¿ãƒƒãƒé–‹å§‹ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
                card.addEventListener('touchstart', function(e) {
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        touchStartX = touch.clientX;
                        touchStartY = touch.clientY;
                        currentTouchedCard = this;
                        
                        // ã‚«ãƒ¼ãƒ‰ã®ç¾åœ¨ä½ç½®ã‚’å–å¾—
                        const rect = this.getBoundingClientRect();
                        const gridRect = taskGrid.getBoundingClientRect();
                        cardStartX = rect.left - gridRect.left;
                        cardStartY = rect.top - gridRect.top;
                        
                        // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®å ´åˆã¯å³åº§ã«ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«ã™ã‚‹
                        if (this.classList.contains('selected') && selectedCard === this) {
                            // é¸æŠæ¸ˆã¿ã®å ´åˆã¯å³åº§ã«ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«ã™ã‚‹
                            isDragging = true;
                            this.dataset.hasDragged = 'true';
                            this.classList.add('dragging');
                            this.style.transition = 'none';
                            this.style.zIndex = '999'; /* ã‚´ãƒŸç®±ã‚ˆã‚Šä¸‹ã«ã™ã‚‹ */
                            this.style.opacity = '0.8';
                            this.style.transform += ' scale(1.05)';
                        } else {
                            // æ–°è¦é¸æŠï¼šã¾ãšé¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                            deselectAllCards();
                            this.classList.add('selected');
                            selectedCard = this;
                            
                            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼ˆSPï¼‰ï¼‰
                            if (window.innerWidth <= 430) {
                                const tooltip = this.querySelector('.task-card-tooltip');
                                if (tooltip) {
                                    tooltip.textContent = 'ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º';
                                    // å¼·åˆ¶çš„ã«è¡¨ç¤ºï¼ˆCSSã‚‚é©ç”¨ï¼‰
                                    tooltip.style.display = 'block';
                                    tooltip.style.opacity = '1';
                                    tooltip.style.visibility = 'visible';
                                    // 3ç§’å¾Œã«éè¡¨ç¤º
                                    setTimeout(() => {
                                        if (tooltip && this.classList.contains('selected')) {
                                            tooltip.style.opacity = '0';
                                            tooltip.style.visibility = 'hidden';
                                        }
                                    }, 3000);
                                }
                            }
                            
                            // é¸æŠå¾Œã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹åˆ¤å®šã¯çŸ­æ™‚é–“ï¼ˆ50msï¼‰ã«ã™ã‚‹
                            touchTimeout = setTimeout(() => {
                                if (this.classList.contains('selected') && selectedCard === this) {
                                    isDragging = true;
                                    this.dataset.hasDragged = 'true';
                                    this.classList.add('dragging');
                                    this.style.transition = 'none';
                                    this.style.zIndex = '999'; /* ã‚´ãƒŸç®±ã‚ˆã‚Šä¸‹ã«ã™ã‚‹ */
                                    this.style.opacity = '0.8';
                                    this.style.transform += ' scale(1.05)';
                                }
                            }, 50); // é™ã‚ŠãªãçŸ­ã„æ™‚é–“ã«è¨­å®š
                        }
                    }
                }, { passive: false });
                
                // ã‚¿ãƒƒãƒç§»å‹•ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
                card.addEventListener('touchmove', function(e) {
                    if (isDragging && e.touches.length === 1 && currentTouchedCard === this) {
                        const touch = e.touches[0];
                        const deltaX = touch.clientX - touchStartX;
                        const deltaY = touch.clientY - touchStartY;
                        
                        // ã‚«ãƒ¼ãƒ‰ã®ä½ç½®ã‚’æ›´æ–°
                        const gridRect = taskGrid.getBoundingClientRect();
                        const newX = cardStartX + deltaX;
                        const newY = cardStartY + deltaY;
                        
                        // ã‚¿ã‚¹ã‚¯ã‚°ãƒªãƒƒãƒ‰ã®å¢ƒç•Œå†…ã«åˆ¶é™
                        const cardRect = this.getBoundingClientRect();
                        const cardWidth = cardRect.width;
                        const cardHeight = cardRect.height;
                        
                        const maxX = taskGrid.offsetWidth - cardWidth;
                        const maxY = Math.max(800, taskGrid.offsetHeight) - cardHeight;
                        
                        const clampedX = Math.max(0, Math.min(newX, maxX));
                        const clampedY = Math.max(0, Math.min(newY, maxY));
                        
                        this.style.left = clampedX + 'px';
                        this.style.top = clampedY + 'px';
                        
                        // ã‚´ãƒŸç®±ã¨ã®é‡ãªã‚Šã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚«ãƒ¼ãƒ‰ã®é ˜åŸŸå…¨ä½“ã§åˆ¤å®šï¼‰
                        const trashBin = document.getElementById('trashBin');
                        if (trashBin) {
                            const trashRect = trashBin.getBoundingClientRect();
                            // ã‚«ãƒ¼ãƒ‰ã®é ˜åŸŸå…¨ä½“ã‚’è¨ˆç®—ï¼ˆã‚°ãƒªãƒƒãƒ‰åº§æ¨™ç³»ï¼‰
                            const cardLeft = clampedX + gridRect.left;
                            const cardRight = cardLeft + cardWidth;
                            const cardTop = clampedY + gridRect.top;
                            const cardBottom = cardTop + cardHeight;
                            
                            // ã‚«ãƒ¼ãƒ‰ã®é ˜åŸŸãŒã‚´ãƒŸç®±ã®é ˜åŸŸã¨é‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                            const isOverlapping = !(cardRight < trashRect.left || 
                                                   cardLeft > trashRect.right || 
                                                   cardBottom < trashRect.top || 
                                                   cardTop > trashRect.bottom);
                            
                            if (isOverlapping) {
                                trashBin.classList.add('touch-drag-over');
                            } else {
                                trashBin.classList.remove('touch-drag-over');
                            }
                        }
                        
                        // å®Œäº†ãƒœã‚¿ãƒ³ã¨ã®é‡ãªã‚Šã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚«ãƒ¼ãƒ‰ã®é ˜åŸŸå…¨ä½“ã§åˆ¤å®šï¼‰
                        const completeButton = document.getElementById('completeButton');
                        if (completeButton) {
                            const completeRect = completeButton.getBoundingClientRect();
                            // ã‚«ãƒ¼ãƒ‰ã®é ˜åŸŸå…¨ä½“ã‚’è¨ˆç®—ï¼ˆã‚°ãƒªãƒƒãƒ‰åº§æ¨™ç³»ï¼‰
                            const cardLeft = clampedX + gridRect.left;
                            const cardRight = cardLeft + cardWidth;
                            const cardTop = clampedY + gridRect.top;
                            const cardBottom = cardTop + cardHeight;
                            
                            // ã‚«ãƒ¼ãƒ‰ã®é ˜åŸŸãŒå®Œäº†ãƒœã‚¿ãƒ³ã®é ˜åŸŸã¨é‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                            const isOverlapping = !(cardRight < completeRect.left || 
                                                   cardLeft > completeRect.right || 
                                                   cardBottom < completeRect.top || 
                                                   cardTop > completeRect.bottom);
                            
                            if (isOverlapping) {
                                completeButton.classList.add('drag-over');
                            } else {
                                completeButton.classList.remove('drag-over');
                            }
                        }
                        
                        e.preventDefault();
                    } else if (currentTouchedCard === this) {
                        // é¸æŠæ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã®ç§»å‹•ã‚’æ¤œå‡ºã—ãŸã‚‰å³åº§ã«ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                        if (this.classList.contains('selected') && selectedCard === this) {
                            const touch = e.touches[0];
                            const deltaX = Math.abs(touch.clientX - touchStartX);
                            const deltaY = Math.abs(touch.clientY - touchStartY);
                            
                            // ç§»å‹•é‡ãŒ5pxä»¥ä¸Šã®å ´åˆã€å³åº§ã«ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                            if (deltaX > 5 || deltaY > 5) {
                                clearTimeout(touchTimeout);
                                touchTimeout = null;
                                isDragging = true;
                                this.dataset.hasDragged = 'true';
                                this.classList.add('dragging');
                                this.style.transition = 'none';
                                this.style.zIndex = '999'; /* ã‚´ãƒŸç®±ã‚ˆã‚Šä¸‹ã«ã™ã‚‹ */
                                this.style.opacity = '0.8';
                                this.style.transform += ' scale(1.05)';
                                e.preventDefault();
                            }
                        } else if (touchTimeout) {
                            // æœªé¸æŠã‚«ãƒ¼ãƒ‰ã®å ´åˆ
                            const touch = e.touches[0];
                            const deltaX = Math.abs(touch.clientX - touchStartX);
                            const deltaY = Math.abs(touch.clientY - touchStartY);
                            
                            if (deltaX < 5 && deltaY < 5) {
                                // ã¾ã ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ã¦ã„ãªã„
                                return;
                            } else {
                                // ç§»å‹•é‡ãŒå¤§ãã„å ´åˆã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                                clearTimeout(touchTimeout);
                                touchTimeout = null;
                                // ç§»å‹•ãŒæ¤œå‡ºã•ã‚ŒãŸã‚‰å³åº§ã«ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                                isDragging = true;
                                this.dataset.hasDragged = 'true';
                                this.classList.add('dragging');
                                this.style.transition = 'none';
                                this.style.zIndex = '999'; /* ã‚´ãƒŸç®±ã‚ˆã‚Šä¸‹ã«ã™ã‚‹ */
                                this.style.opacity = '0.8';
                                this.style.transform += ' scale(1.05)';
                                e.preventDefault();
                            }
                        }
                    }
                }, { passive: false });
                
                // ã‚¿ãƒƒãƒçµ‚äº†ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
                card.addEventListener('touchend', function(e) {
                    clearTimeout(touchTimeout);
                    touchTimeout = null;
                    
                    // ã‚´ãƒŸç®±ã®æ‹¡å¤§è¡¨ç¤ºã‚’è§£é™¤
                    const trashBin = document.getElementById('trashBin');
                    if (trashBin) {
                        trashBin.classList.remove('touch-drag-over');
                    }
                    
                    // å®Œäº†ãƒœã‚¿ãƒ³ã®æ‹¡å¤§è¡¨ç¤ºã‚’è§£é™¤
                    const completeButton = document.getElementById('completeButton');
                    if (completeButton) {
                        completeButton.classList.remove('drag-over');
                    }
                    
                    if (isDragging && currentTouchedCard === this) {
                        // ã‚´ãƒŸç®±ã¾ãŸã¯å®Œäº†ãƒœã‚¿ãƒ³ã®ä¸Šã«ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚«ãƒ¼ãƒ‰ã®é ˜åŸŸå…¨ä½“ã§åˆ¤å®šï¼‰
                        const gridRect = taskGrid.getBoundingClientRect();
                        const cardRect = this.getBoundingClientRect();
                        let droppedOnTrash = false;
                        let droppedOnComplete = false;
                        
                        if (trashBin) {
                            const trashRect = trashBin.getBoundingClientRect();
                            // ã‚«ãƒ¼ãƒ‰ã®é ˜åŸŸå…¨ä½“ãŒã‚´ãƒŸç®±ã®é ˜åŸŸã¨é‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                            const isOverlapping = !(cardRect.right < trashRect.left || 
                                                   cardRect.left > trashRect.right || 
                                                   cardRect.bottom < trashRect.top || 
                                                   cardRect.top > trashRect.bottom);
                            
                            if (isOverlapping) {
                                droppedOnTrash = true;
                            }
                        }
                        
                        if (completeButton && !droppedOnTrash) {
                            const completeRect = completeButton.getBoundingClientRect();
                            // ã‚«ãƒ¼ãƒ‰ã®é ˜åŸŸå…¨ä½“ãŒå®Œäº†ãƒœã‚¿ãƒ³ã®é ˜åŸŸã¨é‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                            const isOverlapping = !(cardRect.right < completeRect.left || 
                                                   cardRect.left > completeRect.right || 
                                                   cardRect.bottom < completeRect.top || 
                                                   cardRect.top > completeRect.bottom);
                            
                            if (isOverlapping) {
                                droppedOnComplete = true;
                            }
                        }
                        
                        if (droppedOnTrash) {
                            // å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                            const taskTitle = task.title || 'ç„¡é¡Œã®ã‚¿ã‚¹ã‚¯';
                            if (confirm(`ã€Œ${taskTitle}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                                deleteTask(task.id);
                            } else {
                                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯å…ƒã®ä½ç½®ã«æˆ»ã™
                                if (task.position) {
                                    this.style.left = task.position.left + 'px';
                                    this.style.top = task.position.top + 'px';
                                }
                                this.style.transition = '';
                                this.style.zIndex = task.position ? task.position.zIndex || 0 : 0;
                                this.style.opacity = '1';
                                this.style.transform = this.style.transform.replace(' scale(1.05)', '');
                                this.classList.remove('dragging');
                            }
                        } else if (droppedOnComplete) {
                            // ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹
                            completeTask(task.id);
                            
                            // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚’è§£é™¤
                            this.style.transition = '';
                            this.style.opacity = '1';
                            this.style.transform = this.style.transform.replace(' scale(1.05)', '');
                            this.classList.remove('dragging');
                        } else {
                            // ã‚¿ã‚¹ã‚¯ã®ä½ç½®æƒ…å ±ã‚’æ›´æ–°
                            const newLeft = cardRect.left - gridRect.left;
                            const newTop = cardRect.top - gridRect.top;
                            
                            // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®ä½ç½®ã‚’æ›´æ–°ï¼ˆç›¸å¯¾ä½ç½®ï¼ˆ%ï¼‰ã§ä¿å­˜ï¼‰
                            if (!task.position) {
                                task.position = {};
                            }
                            // ç›¸å¯¾ä½ç½®ï¼ˆ%ï¼‰ã‚’è¨ˆç®—ã—ã¦ä¿å­˜
                            const taskGrid = document.getElementById('taskGrid');
                            const gridWidth = taskGrid.offsetWidth - 48;
                            const gridHeight = Math.max(800, taskGrid.offsetHeight - 48);
                            task.position.leftPercent = (newLeft / gridWidth) * 100;
                            task.position.topPercent = (newTop / gridHeight) * 100;
                            task.position.rotation = task.position.rotation || 0;
                            task.position.zIndex = task.position.zIndex || 0;
                            
                            this.style.transition = '';
                            this.style.zIndex = task.position.zIndex || 0;
                            this.style.opacity = '1';
                            this.style.transform = this.style.transform.replace(' scale(1.05)', '');
                            this.classList.remove('dragging');
                            
                            console.log('ã‚¿ã‚¹ã‚¯ã®ä½ç½®ã‚’æ›´æ–°ã—ã¾ã—ãŸ:', task.id, task.position);
                            // Firebaseã«ä¿å­˜
                            saveTaskMarketData();
                        }
                        
                        isDragging = false;
                        this.dataset.hasDragged = 'false';
                        currentTouchedCard = null;
                        
                        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å¾Œã‚‚é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒ
                        this.classList.add('selected');
                        selectedCard = this;
                    } else if (currentTouchedCard === this) {
                        // ã‚¿ãƒƒãƒ—åˆ¤å®šï¼ˆç§»å‹•é‡ãŒå°‘ãªã„å ´åˆï¼‰
                        const touch = e.changedTouches[0];
                        const deltaX = Math.abs(touch.clientX - touchStartX);
                        const deltaY = Math.abs(touch.clientY - touchStartY);
                        
                        if (deltaX < 10 && deltaY < 10) {
                            // å˜ç´”ãªã‚¿ãƒƒãƒ—ï¼šé¸æŠçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
                            if (this.classList.contains('selected') && selectedCard === this) {
                                // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠè§£é™¤
                                this.classList.remove('selected');
                                selectedCard = null;
                                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éè¡¨ç¤º
                                const tooltip = this.querySelector('.task-card-tooltip');
                                if (tooltip) {
                                    tooltip.style.opacity = '0';
                                    tooltip.style.visibility = 'hidden';
                                }
                            } else {
                                // æ–°è¦é¸æŠ
                                deselectAllCards();
                                this.classList.add('selected');
                                selectedCard = this;
                                
                                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼ˆSPï¼‰ï¼‰
                                if (window.innerWidth <= 430) {
                                    const tooltip = this.querySelector('.task-card-tooltip');
                                    if (tooltip) {
                                        tooltip.textContent = 'ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º';
                                        // å¼·åˆ¶çš„ã«è¡¨ç¤ºï¼ˆCSSã‚‚é©ç”¨ï¼‰
                                        tooltip.style.display = 'block';
                                        tooltip.style.opacity = '1';
                                        tooltip.style.visibility = 'visible';
                                        // 3ç§’å¾Œã«éè¡¨ç¤º
                                        setTimeout(() => {
                                            if (tooltip) {
                                                tooltip.style.opacity = '0';
                                                tooltip.style.visibility = 'hidden';
                                            }
                                        }, 3000);
                                    }
                                }
                            }
                        }
                        
                        currentTouchedCard = null;
                    }
                });
                
                // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
                card.addEventListener('touchcancel', function(e) {
                    clearTimeout(touchTimeout);
                    touchTimeout = null;
                    isDragging = false;
                    this.classList.remove('dragging');
                    this.style.transition = '';
                    this.style.opacity = '1';
                    this.style.transform = this.style.transform.replace(' scale(1.05)', '');
                    this.dataset.hasDragged = 'false';
                    currentTouchedCard = null;
                    
                    // ã‚´ãƒŸç®±ã®æ‹¡å¤§è¡¨ç¤ºã‚’è§£é™¤
                    const trashBin = document.getElementById('trashBin');
                    if (trashBin) {
                        trashBin.classList.remove('touch-drag-over');
                    }
                    
                    // å®Œäº†ãƒœã‚¿ãƒ³ã®æ‹¡å¤§è¡¨ç¤ºã‚’è§£é™¤
                    const completeButton = document.getElementById('completeButton');
                    if (completeButton) {
                        completeButton.classList.remove('drag-over');
                    }
                    
                    // é¸æŠçŠ¶æ…‹ã¯ç¶­æŒ
                });
                
                // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼ˆPCå¯¾å¿œï¼‰
                card.addEventListener('dragstart', function(e) {
                    draggedCard = this;
                    this.classList.add('dragging');
                    this.dataset.isDragging = 'true';
                    this.dataset.hasDragged = 'true'; // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã‚’ãƒãƒ¼ã‚¯
                    
                    // ã‚«ãƒ¼ãƒ‰ã®ä½ç½®ã¨ãƒã‚¦ã‚¹ä½ç½®ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—
                    const rect = this.getBoundingClientRect();
                    draggedOffset.x = e.clientX - rect.left;
                    draggedOffset.y = e.clientY - rect.top;
                    
                    // å…ƒã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æ™‚çš„ã«éè¡¨ç¤ºã«ã—ã¦æ®‹åƒã‚’é˜²æ­¢
                    this.style.visibility = 'hidden';
                    
                    // ãƒ‡ãƒ¼ã‚¿è»¢é€è¨­å®šï¼ˆå¿…é ˆï¼‰
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.outerHTML);
                });
                
                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ï¼ˆPCå¯¾å¿œï¼‰
                card.addEventListener('dragend', function(e) {
                    // å…ƒã®ã‚«ãƒ¼ãƒ‰ã‚’å†åº¦è¡¨ç¤º
                    this.style.visibility = 'visible';
                    this.classList.remove('dragging');
                    this.dataset.isDragging = 'false';
                    taskGrid.classList.remove('drag-over');
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å¾Œã€å°‘ã—é…å»¶ã•ã›ã¦ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ã‚ˆã†ã«ï¼‰
                    setTimeout(() => {
                        this.dataset.hasDragged = 'false';
                    }, 100);
                });
            });
            
            // ã‚°ãƒªãƒƒãƒ‰ä¸Šã®ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
            taskGrid.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                this.classList.add('drag-over');
                
                if (draggedCard) {
                    // ã‚«ãƒ¼ãƒ‰ã®ä½ç½®ã‚’ãƒã‚¦ã‚¹ä½ç½®ã«æ›´æ–°
                    const gridRect = this.getBoundingClientRect();
                    const gridWidth = this.offsetWidth - 48;
                    const gridHeight = Math.max(800, this.offsetHeight - 48);
                    const cardWidth = 280;
                    const cardHeight = 180;
                    
                    // ã‚°ãƒªãƒƒãƒ‰å†…ã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—ï¼ˆãƒã‚¦ã‚¹ä½ç½®ã‹ã‚‰ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å¼•ãï¼‰
                    let left = e.clientX - gridRect.left - draggedOffset.x - 24; // paddingåˆ†ã‚’è€ƒæ…®
                    let top = e.clientY - gridRect.top - draggedOffset.y - 24;
                    
                    // ã‚°ãƒªãƒƒãƒ‰å†…ã«åˆ¶é™
                    left = Math.max(0, Math.min(left, gridWidth - cardWidth));
                    top = Math.max(0, Math.min(top, gridHeight - cardHeight));
                    
                    draggedCard.style.left = left + 'px';
                    draggedCard.style.top = top + 'px';
                    draggedCard.style.transform = 'rotate(0deg)'; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯å›è»¢ãªã—
                }
            });
            
            // ã‚°ãƒªãƒƒãƒ‰ã‹ã‚‰ã®ãƒ‰ãƒ©ãƒƒã‚°é›¢è„±
            taskGrid.addEventListener('dragleave', function(e) {
                // ã‚°ãƒªãƒƒãƒ‰å¤–ã«å‡ºãŸå ´åˆã®ã¿
                if (!this.contains(e.relatedTarget)) {
                    this.classList.remove('drag-over');
                }
            });
            
            // ãƒ‰ãƒ­ãƒƒãƒ—
            taskGrid.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                if (draggedCard) {
                    const taskId = parseInt(draggedCard.dataset.taskId);
                    const task = tasks.find(t => t.id === taskId);
                    
                    if (task) {
                        // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã«æ–°ã—ã„ä½ç½®ã‚’ä¿å­˜ï¼ˆç›¸å¯¾ä½ç½®ï¼ˆ%ï¼‰ã§ä¿å­˜ï¼‰
                        if (!task.position) {
                            task.position = {};
                        }
                        const absLeft = parseInt(draggedCard.style.left);
                        const absTop = parseInt(draggedCard.style.top);
                        // ç›¸å¯¾ä½ç½®ï¼ˆ%ï¼‰ã‚’è¨ˆç®—ã—ã¦ä¿å­˜
                        const taskGrid = document.getElementById('taskGrid');
                        const gridWidth = taskGrid.offsetWidth - 48;
                        const gridHeight = Math.max(800, taskGrid.offsetHeight - 48);
                        task.position.leftPercent = (absLeft / gridWidth) * 100;
                        task.position.topPercent = (absTop / gridHeight) * 100;
                        // ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã¯å›è»¢ã‚’ä¿æŒï¼ˆå…ƒã®å›è»¢ãŒã‚ã‚Œã°ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
                        if (!task.position.rotation) {
                            task.position.rotation = (Math.random() - 0.5) * 8;
                        }
                        draggedCard.style.transform = `rotate(${task.position.rotation}deg)`;
                        // Firebaseã«ä¿å­˜
                        saveTaskMarketData();
                    }
                    
                    draggedCard = null;
                }
            });
            
            // ã‚´ãƒŸç®±ã®ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚’è¨­å®š
            setupTrashBinDrop();
        }

        // ãƒãƒƒã‚¸è¡¨ç¤ºã¨æ›´æ–°
        function updateBadges() {
            const taskGrid = document.getElementById('taskGrid');
            
            // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤ï¼ˆã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ã¦ã„ã‚‹ã‚‚ã®ã‚’é™¤ãï¼‰
            const existingBadges = taskGrid.querySelectorAll('.badge:not(.attached)');
            existingBadges.forEach(badge => badge.remove());
            
            // ãƒãƒƒã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ã¦ã„ãªã„ã‚‚ã®ï¼‰
            badges.forEach(badge => {
                if (!badge.attachedToTaskId) {
                    const badgeElement = createBadgeElement(badge);
                    taskGrid.appendChild(badgeElement);
                    setupBadgeDragAndDrop(badgeElement, badge);
                }
            });
            
            // ã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ãŸãƒãƒƒã‚¸ã¯ã€updateTaskGrid()ã§å€‹åˆ¥ã«æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å‘¼ã³å‡ºã•ãªã„
            // updateTaskGrid()ã‚’å‘¼ã³å‡ºã™ã¨ã‚«ãƒ¼ãƒ‰ãŒå†ç”Ÿæˆã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€ãƒãƒƒã‚¸ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®ã¿æ‰‹å‹•ã§å‘¼ã³å‡ºã™
        }

        // ãƒãƒƒã‚¸è¦ç´ ã‚’ä½œæˆï¼ˆã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ã¦ã„ãªã„ã‚‚ã®ï¼‰
        function createBadgeElement(badge) {
            const badgeDiv = document.createElement('div');
            badgeDiv.className = 'badge';
            badgeDiv.dataset.badgeId = badge.id;
            badgeDiv.style.background = badge.color;
            badgeDiv.style.top = badge.position.top + 'px';
            badgeDiv.style.left = badge.position.left + 'px';
            
            // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç”»åƒã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
            let iconHtml = badge.icon;
            if (badge.icon && badge.icon.startsWith('img:')) {
                const imageUrl = badge.icon.substring(4); // "img:"ã‚’å‰Šé™¤
                iconHtml = `<img src="${imageUrl}" alt="${badge.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else if (badge.picture) {
                // pictureãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒç›´æ¥ã‚ã‚‹å ´åˆ
                iconHtml = `<img src="${badge.picture}" alt="${badge.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            }
            
            badgeDiv.innerHTML = `
                <div class="badge-icon">${iconHtml}</div>
                <div class="badge-name">${badge.name}</div>
            `;
            
            return badgeDiv;
        }

        // ã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ãŸãƒãƒƒã‚¸è¦ç´ ã‚’ä½œæˆ
        function createAttachedBadgeElement(badge, index = 0) {
            const badgeDiv = document.createElement('div');
            badgeDiv.className = 'badge attached';
            badgeDiv.dataset.badgeId = badge.id;
            badgeDiv.style.background = badge.color;
            badgeDiv.title = badge.name + 'ãŒç€æ‰‹ä¸­ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å¤–ã™ï¼‰';
            
            // PCç‰ˆï¼šã‚«ãƒ¼ãƒ‰å†…ã«é…ç½®ï¼ˆå³ä¸‹ï¼‰
            // ã‚¹ãƒãƒ›ç‰ˆï¼šã‚«ãƒ¼ãƒ‰ã®ç›´ä¸‹ï¼ˆã‚«ãƒ¼ãƒ‰å¤–ï¼‰ã«å¯†ç€ã—ã¦é…ç½®ï¼ˆCSSã§åˆ¶å¾¡ï¼‰
            const badgeSize = 48;
            const badgeSpacing = 12; // ãƒãƒƒã‚¸é–“ã®ã‚¹ãƒšãƒ¼ã‚¹
            const baseRight = 8;
            const baseBottom = 8; // ãƒ•ãƒƒã‚¿ãƒ¼å³ã«é…ç½®
            
            // PCç‰ˆç”¨ã®é…ç½®ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
            if (window.innerWidth > 430) {
                // å³å´ã‹ã‚‰å·¦å´ã¸ã€å°‘ã—ä¸Šã«ãšã‚‰ã™é…ç½®
                // æœ€å¤§3ã¤ã¾ã§æ¨ªã«ä¸¦ã¹ã€ãã‚Œä»¥ä¸Šã¯ä¸Šã«é…ç½®ï¼ˆ2åˆ—ç›®ï¼‰
                if (index < 3) {
                    // æœ€åˆã®3ã¤ã¯æ¨ªã«ä¸¦ã¹ã‚‹
                    badgeDiv.style.right = (baseRight + (index * (badgeSize + badgeSpacing))) + 'px';
                    badgeDiv.style.bottom = baseBottom + 'px';
                } else {
                    // 4ã¤ç›®ä»¥é™ã¯ä¸Šã«é…ç½®ï¼ˆ2åˆ—ç›®ï¼‰
                    const colIndex = index - 3;
                    badgeDiv.style.right = (baseRight + (colIndex * (badgeSize + badgeSpacing))) + 'px';
                    badgeDiv.style.bottom = (baseBottom + badgeSize + badgeSpacing) + 'px';
                }
            } else {
                // ã‚¹ãƒãƒ›ç‰ˆï¼šã‚«ãƒ¼ãƒ‰ã®ç›´ä¸‹ã«é…ç½®ï¼ˆCSSã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡ã•ã‚Œã‚‹ãŸã‚ã€ã‚¹ã‚¿ã‚¤ãƒ«ã¯æœ€å°é™ï¼‰
                // CSSã®.attachedã‚¯ãƒ©ã‚¹ã§ä½ç½®ãŒåˆ¶å¾¡ã•ã‚Œã‚‹
            }
            
            // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç”»åƒã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
            let iconHtml = badge.icon;
            if (badge.icon && badge.icon.startsWith('img:')) {
                const imageUrl = badge.icon.substring(4); // "img:"ã‚’å‰Šé™¤
                iconHtml = `<img src="${imageUrl}" alt="${badge.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else if (badge.picture) {
                // pictureãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒç›´æ¥ã‚ã‚‹å ´åˆ
                iconHtml = `<img src="${badge.picture}" alt="${badge.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            }
            
            badgeDiv.innerHTML = `
                <div class="badge-icon">${iconHtml}</div>
                <div class="badge-name">${badge.name}</div>
            `;
            
            // ã‚¯ãƒªãƒƒã‚¯ã§ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¸ã‚’å¤–ã™
            badgeDiv.addEventListener('click', function(e) {
                e.stopPropagation();
                if (badge.attachedToTaskId) {
                    const taskId = badge.attachedToTaskId;
                    
                    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                    const task = tasks.find(t => t.id === taskId);
                    const taskTitle = task ? task.title : 'ã‚¿ã‚¹ã‚¯';
                    const badgeName = badge.name || 'ãƒãƒƒã‚¸';
                    
                    if (confirm(`ä½œæ¥­ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ\nãƒãƒƒã‚¸ã‚’å¤–ã™ã¨ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒåœæ­¢ã—ã¾ã™ã€‚\n\nãƒãƒƒã‚¸: ${badgeName}\nã‚¿ã‚¹ã‚¯: ${taskTitle}`)) {
                        // ã“ã®ãƒãƒƒã‚¸ã«é–¢é€£ã™ã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åœæ­¢
                        endTimeRecordsForBadge(taskId, badge.id);
                        
                    // ã‚¿ã‚¹ã‚¯ã‹ã‚‰ãƒãƒƒã‚¸ã‚’å¤–ã™
                    if (taskBadges[taskId]) {
                        taskBadges[taskId] = taskBadges[taskId].filter(id => id !== badge.id);
                        if (taskBadges[taskId].length === 0) {
                            delete taskBadges[taskId];
                            // ã‚«ãƒ¼ãƒ‰ã‹ã‚‰badge-attachedã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                            const card = this.closest('.task-card');
                            if (card) {
                                card.classList.remove('badge-attached');
                            }
                        }
                    }
                    // ãƒãƒƒã‚¸ã®å¸ç€çŠ¶æ…‹ã‚’è§£é™¤
                    badge.attachedToTaskId = null;
                    // ãƒãƒƒã‚¸è¦ç´ ã‚’å‰Šé™¤
                    this.remove();
                    // Firebaseã«ä¿å­˜
                    saveTaskMarketData();
                    // ã‚°ãƒªãƒƒãƒ‰ä¸Šã«ãƒãƒƒã‚¸ã‚’å†è¡¨ç¤º
                    updateBadges();
                    }
                }
            });
            
            return badgeDiv;
        }

        // ãƒãƒƒã‚¸ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’è¨­å®š
        function setupBadgeDragAndDrop(badgeElement, badge) {
            const taskGrid = document.getElementById('taskGrid');
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç”¨ã®å¤‰æ•°ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
            let touchStartX = 0;
            let touchStartY = 0;
            let badgeStartX = 0;
            let badgeStartY = 0;
            let isBadgeDragging = false;
            let badgeTouchTimeout = null;
            let currentTouchedBadge = null;
            
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç„¡åŠ¹åŒ–ï¼ˆç”»åƒä¿å­˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãªã©ã‚’é˜²ãï¼‰
            badgeElement.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
            
            // ç”»åƒã®é¸æŠã‚’ç„¡åŠ¹åŒ–
            badgeElement.addEventListener('selectstart', function(e) {
                e.preventDefault();
            });
            
            // ã‚¿ãƒƒãƒé–‹å§‹ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
            badgeElement.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                    currentTouchedBadge = this;
                    
                    // ãƒãƒƒã‚¸ã®ç¾åœ¨ä½ç½®ã‚’å–å¾—
                    const rect = this.getBoundingClientRect();
                    const gridRect = taskGrid.getBoundingClientRect();
                    badgeStartX = rect.left - gridRect.left;
                    badgeStartY = rect.top - gridRect.top;
                    
                    // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒãƒƒã‚¸ã®å ´åˆã¯å³åº§ã«ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«ã™ã‚‹
                    if (this.classList.contains('selected') && selectedBadge === this) {
                        // é¸æŠæ¸ˆã¿ã®å ´åˆã¯å³åº§ã«ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«ã™ã‚‹
                        isBadgeDragging = true;
                        this.classList.add('dragging');
                        this.style.transition = 'none';
                        this.style.zIndex = '1000';
                        this.style.opacity = '0.8';
                        this.style.transform += ' scale(1.1)';
                    } else {
                        // æ–°è¦é¸æŠï¼šã¾ãšé¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                        deselectAllBadges();
                        this.classList.add('selected');
                        selectedBadge = this;
                        
                        // é¸æŠå¾Œã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹åˆ¤å®šã¯çŸ­æ™‚é–“ï¼ˆ50msï¼‰ã«ã™ã‚‹
                        badgeTouchTimeout = setTimeout(() => {
                            if (this.classList.contains('selected') && selectedBadge === this) {
                                isBadgeDragging = true;
                                this.classList.add('dragging');
                                this.style.transition = 'none';
                                this.style.zIndex = '1000';
                                this.style.opacity = '0.8';
                                this.style.transform += ' scale(1.1)';
                            }
                        }, 50); // é™ã‚ŠãªãçŸ­ã„æ™‚é–“ã«è¨­å®š
                    }
                }
            }, { passive: false });
            
            // ã‚¿ãƒƒãƒç§»å‹•ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
            badgeElement.addEventListener('touchmove', function(e) {
                // é¸æŠæ¸ˆã¿ãƒãƒƒã‚¸ãŒç§»å‹•ã—ãŸå ´åˆã¯å³åº§ã«ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                if (this.classList.contains('selected') && selectedBadge === this && !isBadgeDragging) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - touchStartX);
                    const deltaY = Math.abs(touch.clientY - touchStartY);
                    if (deltaX > 5 || deltaY > 5) {
                        // ç§»å‹•ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯å³åº§ã«ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                        clearTimeout(badgeTouchTimeout);
                        isBadgeDragging = true;
                        this.classList.add('dragging');
                        this.style.transition = 'none';
                        this.style.zIndex = '1000';
                        this.style.opacity = '0.8';
                        this.style.transform += ' scale(1.1)';
                    }
                }
                
                if (isBadgeDragging && e.touches.length === 1 && currentTouchedBadge === this) {
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - touchStartX;
                    const deltaY = touch.clientY - touchStartY;
                    
                    // ãƒãƒƒã‚¸ã®ä½ç½®ã‚’æ›´æ–°
                    const gridRect = taskGrid.getBoundingClientRect();
                    const newX = badgeStartX + deltaX;
                    const newY = badgeStartY + deltaY;
                    
                    // ã‚¿ã‚¹ã‚¯ã‚°ãƒªãƒƒãƒ‰ã®å¢ƒç•Œå†…ã«åˆ¶é™
                    const badgeRect = this.getBoundingClientRect();
                    const badgeWidth = badgeRect.width;
                    const badgeHeight = badgeRect.height;
                    
                    const maxX = taskGrid.offsetWidth - badgeWidth;
                    const maxY = Math.max(800, taskGrid.offsetHeight) - badgeHeight;
                    
                    const clampedX = Math.max(0, Math.min(newX, maxX));
                    const clampedY = Math.max(0, Math.min(newY, maxY));
                    
                    this.style.left = clampedX + 'px';
                    this.style.top = clampedY + 'px';
                    
                    // ã‚«ãƒ¼ãƒ‰ã¨ã®é‡ãªã‚Šã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼šãƒãƒƒã‚¸å¸ç€æ©Ÿèƒ½ï¼‰
                    const taskCards = taskGrid.querySelectorAll('.task-card');
                    taskCards.forEach(card => {
                        const cardRect = card.getBoundingClientRect();
                        const badgeCenterX = clampedX + badgeWidth / 2 + gridRect.left;
                        const badgeCenterY = clampedY + badgeHeight / 2 + gridRect.top;
                        
                        // ãƒãƒƒã‚¸ã®ä¸­å¿ƒç‚¹ãŒã‚«ãƒ¼ãƒ‰ã®ç¯„å›²å†…ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (badgeCenterX >= cardRect.left && badgeCenterX <= cardRect.right &&
                            badgeCenterY >= cardRect.top && badgeCenterY <= cardRect.bottom) {
                            card.classList.add('drag-over-badge');
                        } else {
                            card.classList.remove('drag-over-badge');
                        }
                    });
                    
                    // ã‚´ãƒŸç®±ã¨ã®é‡ãªã‚Šã‚’ãƒã‚§ãƒƒã‚¯
                    const trashBin = document.getElementById('trashBin');
                    if (trashBin) {
                        const trashRect = trashBin.getBoundingClientRect();
                        const badgeCenterX = clampedX + badgeWidth / 2 + gridRect.left;
                        const badgeCenterY = clampedY + badgeHeight / 2 + gridRect.top;
                        
                        // ãƒãƒƒã‚¸ã®ä¸­å¿ƒç‚¹ãŒã‚´ãƒŸç®±ã®ç¯„å›²å†…ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (badgeCenterX >= trashRect.left && badgeCenterX <= trashRect.right &&
                            badgeCenterY >= trashRect.top && badgeCenterY <= trashRect.bottom) {
                            trashBin.classList.add('touch-drag-over');
                        } else {
                            trashBin.classList.remove('touch-drag-over');
                        }
                    }
                    
                    e.preventDefault();
                } else if (badgeTouchTimeout && currentTouchedBadge === this) {
                    // ç§»å‹•ãŒå°ã•ã„å ´åˆã¯ãƒ‰ãƒ©ãƒƒã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - touchStartX);
                    const deltaY = Math.abs(touch.clientY - touchStartY);
                    
                    if (deltaX < 5 && deltaY < 5) {
                        // ã¾ã ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ã¦ã„ãªã„
                        return;
                    } else {
                        // ç§»å‹•é‡ãŒå¤§ãã„å ´åˆã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
                        clearTimeout(badgeTouchTimeout);
                        badgeTouchTimeout = null;
                    }
                }
            }, { passive: false });
            
                // ã‚¿ãƒƒãƒçµ‚äº†ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
                badgeElement.addEventListener('touchend', function(e) {
                    clearTimeout(badgeTouchTimeout);
                    badgeTouchTimeout = null;
                    
                    // ã‚´ãƒŸç®±ã®æ‹¡å¤§è¡¨ç¤ºã‚’è§£é™¤
                    const trashBin = document.getElementById('trashBin');
                    if (trashBin) {
                        trashBin.classList.remove('touch-drag-over');
                    }
                    
                    // ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ…‹ã‚’è§£é™¤
                    const taskCards = taskGrid.querySelectorAll('.task-card');
                    taskCards.forEach(card => {
                        card.classList.remove('drag-over-badge');
                    });
                    
                    if (isBadgeDragging && currentTouchedBadge === this) {
                        // ã‚´ãƒŸç®±ã®ä¸Šã«ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
                        const gridRect = taskGrid.getBoundingClientRect();
                        const badgeRect = this.getBoundingClientRect();
                        let droppedOnTrash = false;
                        let droppedOnCard = null;
                        
                        if (trashBin) {
                            const trashRect = trashBin.getBoundingClientRect();
                            // ãƒãƒƒã‚¸ã®ä¸­å¿ƒç‚¹ãŒã‚´ãƒŸç®±ã®ç¯„å›²å†…ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                            const badgeCenterX = badgeRect.left + badgeRect.width / 2;
                            const badgeCenterY = badgeRect.top + badgeRect.height / 2;
                            
                            if (badgeCenterX >= trashRect.left && badgeCenterX <= trashRect.right &&
                                badgeCenterY >= trashRect.top && badgeCenterY <= trashRect.bottom) {
                                droppedOnTrash = true;
                            }
                        }
                        
                        // ã‚«ãƒ¼ãƒ‰ã®ä¸Šã«ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼šãƒãƒƒã‚¸å¸ç€æ©Ÿèƒ½ï¼‰
                        if (!droppedOnTrash) {
                            taskCards.forEach(card => {
                                const cardRect = card.getBoundingClientRect();
                                const badgeCenterX = badgeRect.left + badgeRect.width / 2;
                                const badgeCenterY = badgeRect.top + badgeRect.height / 2;
                                
                                // ãƒãƒƒã‚¸ã®ä¸­å¿ƒç‚¹ãŒã‚«ãƒ¼ãƒ‰ã®ç¯„å›²å†…ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                                if (badgeCenterX >= cardRect.left && badgeCenterX <= cardRect.right &&
                                    badgeCenterY >= cardRect.top && badgeCenterY <= cardRect.bottom) {
                                    const taskId = parseInt(card.dataset.taskId);
                                    if (taskId && badge.attachedToTaskId !== taskId) {
                                        droppedOnCard = { card: card, taskId: taskId };
                                    }
                                }
                            });
                        }
                        
                        if (droppedOnTrash) {
                            // ãƒãƒƒã‚¸ã‚’å‰Šé™¤ï¼ˆç¢ºèªãªã—ï¼‰
                            deleteBadge(badge.id);
                        } else if (droppedOnCard) {
                            // ã‚«ãƒ¼ãƒ‰ã«ãƒãƒƒã‚¸ã‚’å¸ç€ï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼‰
                            const taskId = droppedOnCard.taskId;
                            const card = droppedOnCard.card;
                            
                            // ä»¥å‰ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¸ã‚’å¤–ã™ï¼ˆåˆ¥ã®ã‚«ãƒ¼ãƒ‰ã«ç§»å‹•ã™ã‚‹æ™‚ï¼‰
                            if (badge.attachedToTaskId && badge.attachedToTaskId !== taskId) {
                                const prevTaskId = badge.attachedToTaskId;
                                
                                // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆãƒãƒƒã‚¸ã‚’å¤–ã™æ™‚ã®ã¿ï¼‰
                                const prevTask = tasks.find(t => t.id === prevTaskId);
                                const prevTaskTitle = prevTask ? prevTask.title : 'ã‚¿ã‚¹ã‚¯';
                                const badgeName = badge.name || 'ãƒãƒƒã‚¸';
                                
                                if (confirm(`ä½œæ¥­ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ\nãƒãƒƒã‚¸ã‚’å¤–ã™ã¨ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒåœæ­¢ã—ã¾ã™ã€‚\n\nãƒãƒƒã‚¸: ${badgeName}\nã‚¿ã‚¹ã‚¯: ${prevTaskTitle}`)) {
                                    // ä»¥å‰ã®ã‚¿ã‚¹ã‚¯ã‹ã‚‰ã“ã®ãƒãƒƒã‚¸ã«é–¢é€£ã™ã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åœæ­¢
                                    endTimeRecordsForBadge(prevTaskId, badge.id);
                                    
                                    if (taskBadges[prevTaskId]) {
                                        taskBadges[prevTaskId] = taskBadges[prevTaskId].filter(id => id !== badge.id);
                                        if (taskBadges[prevTaskId].length === 0) {
                                            delete taskBadges[prevTaskId];
                                        }
                                    }
                                    // Firebaseã«ä¿å­˜
                                    saveTaskMarketData();
                                } else {
                                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã¯ã€æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã¸ã®å¸ç€ã‚’ä¸­æ­¢
                                    e.preventDefault();
                                    return;
                                }
                            }
                            
                            // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã«ãƒãƒƒã‚¸ã‚’å¸ç€
                            badge.attachedToTaskId = taskId;
                            if (!taskBadges[taskId]) {
                                taskBadges[taskId] = [];
                            }
                            if (!taskBadges[taskId].includes(badge.id)) {
                                taskBadges[taskId].push(badge.id);
                                // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰èµ·å‹•ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                                const taskObj = tasks.find(t => t.id === taskId);
                                const taskTitle = taskObj ? taskObj.title : 'ã‚¿ã‚¹ã‚¯';
                                const badgeName = badge.name || 'ãƒãƒƒã‚¸';
                                
                                if (confirm(`${badgeName}ï¼šã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’èµ·å‹•ã—ã€ã‚¿ã‚¹ã‚¯ã€Œ${taskTitle}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`)) {
                                    // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆãƒãƒƒã‚¸ãŒã‚¿ã‚¹ã‚¯ã«ä»˜ã‘ã‚‰ã‚ŒãŸæ™‚ï¼‰
                                    createTimeRecord(taskId, badge.id);
                                }
                                // Firebaseã«ä¿å­˜
                                saveTaskMarketData();
                            }
                            
                            // ã‚«ãƒ¼ãƒ‰ã«ç›´æ¥ãƒãƒƒã‚¸ã‚’è¿½åŠ 
                            const existingBadges = card.querySelectorAll('.badge.attached');
                            const badgeIndex = existingBadges.length;
                            const attachedBadgeElement = createAttachedBadgeElement(badge, badgeIndex);
                            card.appendChild(attachedBadgeElement);
                            card.classList.add('badge-attached');
                            
                            // ã‚°ãƒªãƒƒãƒ‰ä¸Šã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤
                            this.remove();
                            
                            // ãƒãƒƒã‚¸ã‚’æ›´æ–°ï¼ˆã‚°ãƒªãƒƒãƒ‰ä¸Šã®ãƒãƒƒã‚¸ã‚’æ›´æ–°ï¼‰
                            updateBadges();
                            
                            console.log('ãƒãƒƒã‚¸ã‚’ã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ã¾ã—ãŸ:', badge.id, taskId);
                        } else {
                            // ãƒãƒƒã‚¸ã®ä½ç½®æƒ…å ±ã‚’æ›´æ–°
                            const newLeft = badgeRect.left - gridRect.left;
                            const newTop = badgeRect.top - gridRect.top;
                            
                            // ãƒãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã®ä½ç½®ã‚’æ›´æ–°ï¼ˆã‚«ãƒ¼ãƒ‰ã«å¸ç€ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
                            if (!badge.attachedToTaskId) {
                                badge.position.left = newLeft;
                                badge.position.top = newTop;
                            }
                            
                            this.style.transition = '';
                            this.style.zIndex = '10';
                            this.style.opacity = '1';
                            this.style.transform = this.style.transform.replace(' scale(1.1)', '');
                            this.classList.remove('dragging');
                            
                            console.log('ãƒãƒƒã‚¸ã®ä½ç½®ã‚’æ›´æ–°ã—ã¾ã—ãŸ:', badge.id, badge.position);
                            // Firebaseã«ä¿å­˜
                            saveTaskMarketData();
                        }
                        
                        isBadgeDragging = false;
                        currentTouchedBadge = null;
                        
                        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å¾Œã‚‚é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒ
                        this.classList.add('selected');
                        selectedBadge = this;
                    } else if (currentTouchedBadge === this) {
                        // ã‚¿ãƒƒãƒ—åˆ¤å®šï¼ˆç§»å‹•é‡ãŒå°‘ãªã„å ´åˆï¼‰
                        const touch = e.changedTouches[0];
                        const deltaX = Math.abs(touch.clientX - touchStartX);
                        const deltaY = Math.abs(touch.clientY - touchStartY);
                        
                        if (deltaX < 10 && deltaY < 10) {
                            // ã‚¿ãƒƒãƒ—ï¼šé¸æŠçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                            if (this.classList.contains('selected')) {
                                this.classList.remove('selected');
                                selectedBadge = null;
                            } else {
                                deselectAllBadges();
                                this.classList.add('selected');
                                selectedBadge = this;
                            }
                        }
                        currentTouchedBadge = null;
                    }
                });
            
            // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
            badgeElement.addEventListener('touchcancel', function(e) {
                clearTimeout(badgeTouchTimeout);
                badgeTouchTimeout = null;
                isBadgeDragging = false;
                this.classList.remove('dragging');
                this.style.transition = '';
                this.style.opacity = '1';
                this.style.transform = this.style.transform.replace(' scale(1.1)', '');
                currentTouchedBadge = null;
                
                // ã‚´ãƒŸç®±ã®æ‹¡å¤§è¡¨ç¤ºã‚’è§£é™¤
                const trashBin = document.getElementById('trashBin');
                if (trashBin) {
                    trashBin.classList.remove('touch-drag-over');
                }
                
                // ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ…‹ã‚’è§£é™¤
                const taskCards = taskGrid.querySelectorAll('.task-card');
                taskCards.forEach(card => {
                    card.classList.remove('drag-over-badge');
                });
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼ˆPCå¯¾å¿œï¼‰
            badgeElement.addEventListener('dragstart', function(e) {
                draggedBadgeGlobal = badge;
                this.classList.add('dragging');
                
                const rect = this.getBoundingClientRect();
                const gridRect = taskGrid.getBoundingClientRect();
                draggedBadgeOffset.x = e.clientX - rect.left;
                draggedBadgeOffset.y = e.clientY - rect.top;
                
                // å…ƒã®ãƒãƒƒã‚¸ã‚’ä¸€æ™‚çš„ã«éè¡¨ç¤ºã«ã—ã¦æ®‹åƒã‚’é˜²æ­¢
                this.style.visibility = 'hidden';
                
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('badgeId', badge.id.toString());
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ï¼ˆPCå¯¾å¿œï¼‰
            badgeElement.addEventListener('dragend', function(e) {
                // å…ƒã®ãƒãƒƒã‚¸ã‚’å†åº¦è¡¨ç¤º
                this.style.visibility = 'visible';
                this.classList.remove('dragging');
                
                // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆãŒã‚«ãƒ¼ãƒ‰ã§ãªã„å ´åˆã€ä½ç½®ã‚’æ›´æ–°
                if (draggedBadgeGlobal && !draggedBadgeGlobal.attachedToTaskId) {
                    const rect = this.getBoundingClientRect();
                    const gridRect = taskGrid.getBoundingClientRect();
                    draggedBadgeGlobal.position.left = parseInt(this.style.left);
                    draggedBadgeGlobal.position.top = parseInt(this.style.top);
                    // Firebaseã«ä¿å­˜
                    saveTaskMarketData();
                }
                
                draggedBadgeGlobal = null;
            });
            
            badgeElement.setAttribute('draggable', 'true');
        }
        
        // å®Œäº†ãƒœã‚¿ãƒ³ã®ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚’è¨­å®šï¼ˆé‡è¤‡ç™»éŒ²ã‚’é˜²ãï¼‰
        let completeButtonHandlerSet = false;
        function setupCompleteButtonDrop() {
            const completeButton = document.getElementById('completeButton');
            if (!completeButton) return;
            
            // æ—¢ã«è¨­å®šæ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (completeButtonHandlerSet) return;
            completeButtonHandlerSet = true;
            
            // å®Œäº†ãƒœã‚¿ãƒ³ã®ä¸Šã§ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
            completeButton.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
                this.classList.add('drag-over');
            });
            
            // å®Œäº†ãƒœã‚¿ãƒ³ã‹ã‚‰é›¢ã‚ŒãŸæ™‚
            completeButton.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });
            
            // å®Œäº†ãƒœã‚¿ãƒ³ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆä¸€åº¦ã ã‘å‡¦ç†ã•ã‚Œã‚‹ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ï¼‰
            let isProcessing = false;
            completeButton.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
                
                // æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (isProcessing) return;
                isProcessing = true;
                
                // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆ
                const taskGrid = document.getElementById('taskGrid');
                const draggedCard = taskGrid.querySelector('.task-card.dragging');
                if (draggedCard) {
                    const taskIdNum = parseInt(draggedCard.dataset.taskId);
                    if (taskIdNum && !isNaN(taskIdNum)) {
                        completeTask(taskIdNum);
                        // å‡¦ç†å®Œäº†å¾Œã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                        setTimeout(() => { isProcessing = false; }, 100);
                        return;
                    }
                }
                
                // å‡¦ç†å®Œäº†å¾Œã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => { isProcessing = false; }, 100);
            });
        }
        
        // ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹
        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // æ—¢ã«å®Œäº†æ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (task.status === 'completed') return;
            
            // ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†çŠ¶æ…‹ã«å¤‰æ›´
            task.status = 'completed';
            task.completedAt = new Date().toISOString();
            task.updatedAt = new Date().toISOString();
            
            // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’çµ‚äº†ï¼ˆã“ã®ã‚¿ã‚¹ã‚¯ã«ç´ã¥ãã™ã¹ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰
            endTimeRecordsForTask(taskId);
            
            // ã‚°ãƒªãƒƒãƒ‰ã‚’æ›´æ–°ï¼ˆå®Œäº†ã‚¿ã‚¹ã‚¯ã¯è¡¨ç¤ºã‹ã‚‰é™¤å¤–ï¼‰
            updateTaskGrid();
            
            // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‘ãƒãƒ«ã‚’æ›´æ–°ï¼ˆãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆï¼‰
            if (document.getElementById('slidePanelOverlay5') && document.getElementById('slidePanelOverlay5').classList.contains('active')) {
                updateArchivePanel();
            }
            
            // Firebaseã«ä¿å­˜
            saveTaskMarketData();
            
            console.log('ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã—ãŸ:', task.title);
        }
        
        // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆãƒãƒƒã‚¸ãŒã‚¿ã‚¹ã‚¯ã«ä»˜ã‘ã‚‰ã‚ŒãŸæ™‚ï¼‰
        function createTimeRecord(taskId, badgeId) {
            const timeRecord = {
                id: Date.now(),
                taskId: taskId,
                badgeId: badgeId,
                startTime: new Date().toISOString(),
                endTime: null,
                duration: null, // ç§’å˜ä½
                status: 'active' // 'active' or 'completed'
            };
            
            timeRecords.push(timeRecord);
            saveTimeRecords();
            
            console.log('ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸ:', timeRecord);
            return timeRecord;
        }
        
        // ã‚¿ã‚¹ã‚¯ã«ç´ã¥ãã™ã¹ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’çµ‚äº†
        function endTimeRecordsForTask(taskId) {
            const endTime = new Date();
            const endTimeISO = endTime.toISOString();
            
            timeRecords.forEach(record => {
                if (record.taskId === taskId && record.status === 'active') {
                    const startTime = new Date(record.startTime);
                    const duration = Math.floor((endTime - startTime) / 1000); // ç§’å˜ä½
                    
                    record.endTime = endTimeISO;
                    record.duration = duration;
                    record.status = 'completed';
                }
            });
            
            saveTimeRecords();
            console.log('ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸ:', taskId);
        }
        
        // ç‰¹å®šã®ãƒãƒƒã‚¸ã«ç´ã¥ãã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’çµ‚äº†ï¼ˆãƒãƒƒã‚¸ã‚’å¤–ã—ãŸæ™‚ï¼‰
        function endTimeRecordsForBadge(taskId, badgeId) {
            const endTime = new Date();
            const endTimeISO = endTime.toISOString();
            
            timeRecords.forEach(record => {
                if (record.taskId === taskId && record.badgeId === badgeId && record.status === 'active') {
                    const startTime = new Date(record.startTime);
                    const duration = Math.floor((endTime - startTime) / 1000); // ç§’å˜ä½
                    
                    record.endTime = endTimeISO;
                    record.duration = duration;
                    record.status = 'completed';
                }
            });
            
            saveTimeRecords();
            console.log('ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åœæ­¢ã—ã¾ã—ãŸï¼ˆãƒãƒƒã‚¸ã‚’å¤–ã—ãŸï¼‰:', taskId, badgeId);
        }
        
        // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
        function saveTimeRecords() {
            localStorage.setItem('timeRecords', JSON.stringify(timeRecords));
            // Firebaseã«ã‚‚ä¿å­˜
            saveTaskMarketData();
        }
        
        // ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        function getTimeRecordsForTask(taskId) {
            return timeRecords.filter(record => record.taskId === taskId);
        }
        
        // æ™‚é–“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼‰
        function formatDuration(seconds) {
            if (!seconds && seconds !== 0) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            if (hours > 0) {
                return `${hours}æ™‚é–“ ${minutes}åˆ† ${secs}ç§’`;
            } else if (minutes > 0) {
                return `${minutes}åˆ† ${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }
        
        // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆåˆ¥ãƒ‘ãƒãƒ«ã§è¡¨ç¤ºï¼‰
        function showTimeRecords() {
            if (!currentDetailTaskId) return;
            
            const task = tasks.find(t => t.id === currentDetailTaskId);
            if (!task) return;
            
            const taskRecords = getTimeRecordsForTask(currentDetailTaskId);
            const activeRecord = taskRecords.find(r => r.status === 'active');
            
            const overlay = document.getElementById('timeRecordPanelOverlay');
            const panel = document.getElementById('timeRecordPanel');
            const content = document.getElementById('timeRecordContent');
            
            // ãƒãƒƒã‚¸æƒ…å ±ã‚’å–å¾—
            const badgeMap = {};
            badges.forEach(badge => {
                badgeMap[badge.id] = badge;
            });
            
            function formatDateTime(isoString) {
                if (!isoString) return '-';
                const date = new Date(isoString);
                return date.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            // ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰æƒ…å ±ã‚’è¡¨ç¤º
            let currentInfoHTML = '';
            if (activeRecord) {
                const badge = badgeMap[activeRecord.badgeId];
                const badgeName = badge ? badge.name : 'ä¸æ˜ãªãƒãƒƒã‚¸';
                
                currentInfoHTML = `
                    <div style="background: var(--color-background); border: 2px solid #4CAF50; border-radius: var(--border-radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md); color: var(--color-text-primary);">ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰</h3>
                        <div style="margin-bottom: var(--spacing-sm);">
                            <span style="font-weight: var(--font-weight-semibold); color: var(--color-text-secondary);">æ‹…å½“è€…: </span>
                            <span style="color: var(--color-text-primary);">${escapeHtml(badgeName)}</span>
                        </div>
                        <div style="margin-bottom: var(--spacing-sm);">
                            <span style="font-weight: var(--font-weight-semibold); color: var(--color-text-secondary);">é–‹å§‹æ™‚é–“: </span>
                            <span style="color: var(--color-text-primary);">${formatDateTime(activeRecord.startTime)}</span>
                        </div>
                        ${task.estimatedTime ? `
                        <div style="margin-bottom: var(--spacing-sm);">
                            <span style="font-weight: var(--font-weight-semibold); color: var(--color-text-secondary);">äºˆæƒ³ä½œæ¥­æ™‚é–“: </span>
                            <span style="color: var(--color-text-primary);">${formatEstimatedTime(task.estimatedTime)}</span>
                        </div>
                        ` : ''}
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border);">
                            <span style="font-size: var(--font-size-sm); color: #4CAF50; font-weight: var(--font-weight-semibold);">â— ä½œæ¥­ä¸­</span>
                        </div>
                    </div>
                `;
            } else {
                currentInfoHTML = `
                    <div style="background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                        <p style="color: var(--color-text-secondary); text-align: center;">
                            ç¾åœ¨å®Ÿè¡Œä¸­ã®ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“
                        </p>
                    </div>
                `;
            }
            
            // å±¥æ­´ã‚’è¡¨ç¤º
            const completedRecords = taskRecords.filter(r => r.status === 'completed');
            let historyHTML = '';
            
            if (completedRecords.length > 0) {
                const historyItems = completedRecords.map(record => {
                    const badge = badgeMap[record.badgeId];
                    const badgeName = badge ? badge.name : 'ä¸æ˜ãªãƒãƒƒã‚¸';
                    
                    return `
                        <div style="background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                                <span style="font-weight: var(--font-weight-semibold); color: var(--color-text-primary);">${escapeHtml(badgeName)}</span>
                                <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">å®Œäº†</span>
                            </div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                <div>é–‹å§‹: ${formatDateTime(record.startTime)}</div>
                                ${record.endTime ? `<div>çµ‚äº†: ${formatDateTime(record.endTime)}</div>` : ''}
                                <div style="margin-top: var(--spacing-xs); font-weight: var(--font-weight-semibold); color: var(--color-text-primary);">
                                    ä½œæ¥­æ™‚é–“: ${formatDuration(record.duration)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // åˆè¨ˆæ™‚é–“ã‚’è¨ˆç®—
                const totalDuration = completedRecords
                    .filter(r => r.duration !== null)
                    .reduce((sum, r) => sum + r.duration, 0);
                
                historyHTML = `
                    <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 2px solid var(--color-border);">
                        <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md); color: var(--color-text-primary);">å±¥æ­´</h3>
                        <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: var(--color-background-secondary); border-radius: var(--border-radius-md);">
                            <div style="font-weight: var(--font-weight-semibold); color: var(--color-text-primary);">
                                åˆè¨ˆä½œæ¥­æ™‚é–“: ${formatDuration(totalDuration)}
                            </div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: 4px;">
                                è¨˜éŒ²æ•°: ${completedRecords.length}ä»¶
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${historyItems}
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div style="background: var(--color-background); border-radius: var(--border-radius-lg); padding: var(--spacing-md);">
                    ${currentInfoHTML}
                    ${historyHTML}
                </div>
            `;
            
            // ãƒ‘ãƒãƒ«ã‚’é–‹ã
            overlay.classList.add('active');
            setTimeout(function() {
                panel.classList.add('active');
            }, 10);
        }
        
        // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        function closeTimeRecordPanel() {
            const overlay = document.getElementById('timeRecordPanelOverlay');
            const panel = document.getElementById('timeRecordPanel');
            
            panel.classList.remove('active');
            setTimeout(function() {
                overlay.classList.remove('active');
            }, 300);
        }
        
        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        function closeTimeRecordPanelOnOverlay(event) {
            if (event.target.id === 'timeRecordPanelOverlay') {
                closeTimeRecordPanel();
            }
        }
        
        // ã‚´ãƒŸç®±ã®ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚’è¨­å®šï¼ˆé‡è¤‡ç™»éŒ²ã‚’é˜²ãï¼‰
        let trashBinHandlerSet = false;
        function setupTrashBinDrop() {
            const trashBin = document.getElementById('trashBin');
            if (!trashBin) return;
            
            // æ—¢ã«è¨­å®šæ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (trashBinHandlerSet) return;
            trashBinHandlerSet = true;
            
            // ã‚´ãƒŸç®±ã®ä¸Šã§ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
            trashBin.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
                this.classList.add('drag-over');
            });
            
            // ã‚´ãƒŸç®±ã‹ã‚‰é›¢ã‚ŒãŸæ™‚
            trashBin.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });
            
            // ã‚´ãƒŸç®±ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆä¸€åº¦ã ã‘å‡¦ç†ã•ã‚Œã‚‹ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ï¼‰
            let isProcessing = false;
            trashBin.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
                
                // æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (isProcessing) return;
                isProcessing = true;
                
                // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆ
                const taskGrid = document.getElementById('taskGrid');
                const draggedCard = taskGrid.querySelector('.task-card.dragging');
                if (draggedCard) {
                    const taskIdNum = parseInt(draggedCard.dataset.taskId);
                    if (taskIdNum && !isNaN(taskIdNum)) {
                        deleteTask(taskIdNum);
                        // å‡¦ç†å®Œäº†å¾Œã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                        setTimeout(() => { isProcessing = false; }, 100);
                        return;
                    }
                }
                
                // ãƒãƒƒã‚¸ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆ
                const badgeId = e.dataTransfer.getData('badgeId');
                if (badgeId) {
                    deleteBadge(parseInt(badgeId));
                }
                
                // å‡¦ç†å®Œäº†å¾Œã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => { isProcessing = false; }, 100);
            });
        }
        
        // ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ï¼ˆé‡è¤‡å®Ÿè¡Œã‚’é˜²ãï¼‰
        let isDeletingTask = false;
        function deleteTask(taskId) {
            // æ—¢ã«å‰Šé™¤å‡¦ç†ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (isDeletingTask) return;
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // å‰Šé™¤ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
            isDeletingTask = true;
            
            // å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            const taskTitle = task.title || 'ç„¡é¡Œã®ã‚¿ã‚¹ã‚¯';
            if (!confirm(`ã€Œ${taskTitle}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã‚‚ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                isDeletingTask = false;
                return;
            }
            
            // ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
            tasks = tasks.filter(t => t.id !== taskId);
            
            // ã‚¿ã‚¹ã‚¯ã«ç´ã¥ããƒãƒƒã‚¸ã‚‚å‰Šé™¤
            if (taskBadges[taskId]) {
                taskBadges[taskId].forEach(badgeId => {
                    const badge = badges.find(b => b.id === badgeId);
                    if (badge) {
                        badge.attachedToTaskId = null;
                    }
                });
                delete taskBadges[taskId];
            }
            
            // ã‚°ãƒªãƒƒãƒ‰ã‚’æ›´æ–°
            updateTaskGrid();
            
            // Firebaseã«ä¿å­˜
            saveTaskMarketData();
            
            console.log('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', taskId);
            
            // å‰Šé™¤å‡¦ç†å®Œäº†å¾Œã«ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            isDeletingTask = false;
        }
        
        // ãƒãƒƒã‚¸ã‚’å‰Šé™¤
        function deleteBadge(badgeId) {
            const badge = badges.find(b => b.id === badgeId);
            if (!badge) return;
            
            // ãƒãƒƒã‚¸ãŒã‚¿ã‚¹ã‚¯ã«å¸ç€ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åœæ­¢
            if (badge.attachedToTaskId) {
                const taskId = badge.attachedToTaskId;
                const task = tasks.find(t => t.id === taskId);
                const taskTitle = task ? task.title : 'ã‚¿ã‚¹ã‚¯';
                const badgeName = badge.name || 'ãƒãƒƒã‚¸';
                
                if (confirm(`ä½œæ¥­ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ\nãƒãƒƒã‚¸ã‚’å‰Šé™¤ã™ã‚‹ã¨ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒåœæ­¢ã—ã¾ã™ã€‚\n\nãƒãƒƒã‚¸: ${badgeName}\nã‚¿ã‚¹ã‚¯: ${taskTitle}`)) {
                    // ã“ã®ãƒãƒƒã‚¸ã«é–¢é€£ã™ã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åœæ­¢
                    endTimeRecordsForBadge(taskId, badgeId);
                } else {
                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã¯å‰Šé™¤ã‚’ä¸­æ­¢
                    return;
                }
            }
            
            // ãƒãƒƒã‚¸ã‚’å‰Šé™¤
            badges = badges.filter(b => b.id !== badgeId);
            
            // ã‚¿ã‚¹ã‚¯ã‹ã‚‰ãƒãƒƒã‚¸ã®ç´ä»˜ã‘ã‚’å‰Šé™¤
            if (badge.attachedToTaskId) {
                const taskId = badge.attachedToTaskId;
                if (taskBadges[taskId]) {
                    taskBadges[taskId] = taskBadges[taskId].filter(id => id !== badgeId);
                    if (taskBadges[taskId].length === 0) {
                        delete taskBadges[taskId];
                    }
                }
            }
            
            // ãƒãƒƒã‚¸è¡¨ç¤ºã‚’æ›´æ–°
            updateBadges();
            
            // Firebaseã«ä¿å­˜
            saveTaskMarketData();
            
            console.log('ãƒãƒƒã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', badgeId);
        }

        // ã‚°ãƒªãƒƒãƒ‰ä¸Šã§ã®ãƒãƒƒã‚¸ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ä½ç½®ã‚’æ›´æ–°ï¼ˆä¸€åº¦ã ã‘è¨­å®šï¼‰
        let badgeDragHandlerSet = false;
        function setupBadgeDragHandler() {
            if (badgeDragHandlerSet) return;
            badgeDragHandlerSet = true;
            
            const taskGrid = document.getElementById('taskGrid');
            if (taskGrid) {
                taskGrid.addEventListener('dragover', function(e) {
                    if (draggedBadgeGlobal && !draggedBadgeGlobal.attachedToTaskId) {
                        const draggingElement = taskGrid.querySelector(`.badge[data-badge-id="${draggedBadgeGlobal.id}"].dragging`);
                        if (draggingElement) {
                            const gridRect = taskGrid.getBoundingClientRect();
                            let newLeft = e.clientX - gridRect.left - draggedBadgeOffset.x;
                            let newTop = e.clientY - gridRect.top - draggedBadgeOffset.y;
                            
                            // ã‚°ãƒªãƒƒãƒ‰å†…ã«åˆ¶é™
                            newLeft = Math.max(0, Math.min(newLeft, gridRect.width - draggingElement.offsetWidth));
                            newTop = Math.max(0, Math.min(newTop, gridRect.height - draggingElement.offsetHeight));
                            
                            draggingElement.style.left = newLeft + 'px';
                            draggingElement.style.top = newTop + 'px';
                        }
                    }
                });
            }
        }

        // ã‚«ãƒ¼ãƒ‰ã¸ã®ãƒãƒƒã‚¸å¸ç€æ©Ÿèƒ½ã‚’è¨­å®š
        function setupTaskCardBadgeDrop(cardElement, task) {
            cardElement.addEventListener('dragover', function(e) {
                const badgeId = e.dataTransfer.getData('badgeId');
                if (badgeId) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    this.classList.add('drag-over-badge');
                }
            });
            
            cardElement.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over-badge');
            });
            
            cardElement.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over-badge');
                
                const badgeId = parseInt(e.dataTransfer.getData('badgeId'));
                if (badgeId) {
                    const badge = badges.find(b => b.id === badgeId);
                    if (badge && badge.attachedToTaskId !== task.id) {
                        // ä»¥å‰ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ãƒãƒƒã‚¸ã‚’å¤–ã™ï¼ˆåˆ¥ã®ã‚«ãƒ¼ãƒ‰ã«ç§»å‹•ã™ã‚‹æ™‚ï¼‰
                        if (badge.attachedToTaskId) {
                            const prevTaskId = badge.attachedToTaskId;
                            
                            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆãƒãƒƒã‚¸ã‚’å¤–ã™æ™‚ã®ã¿ï¼‰
                            const prevTask = tasks.find(t => t.id === prevTaskId);
                            const prevTaskTitle = prevTask ? prevTask.title : 'ã‚¿ã‚¹ã‚¯';
                            const badgeName = badge.name || 'ãƒãƒƒã‚¸';
                            
                            if (confirm(`ä½œæ¥­ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ\nãƒãƒƒã‚¸ã‚’å¤–ã™ã¨ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒåœæ­¢ã—ã¾ã™ã€‚\n\nãƒãƒƒã‚¸: ${badgeName}\nã‚¿ã‚¹ã‚¯: ${prevTaskTitle}`)) {
                                // ä»¥å‰ã®ã‚¿ã‚¹ã‚¯ã‹ã‚‰ã“ã®ãƒãƒƒã‚¸ã«é–¢é€£ã™ã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åœæ­¢
                                endTimeRecordsForBadge(prevTaskId, badge.id);
                                
                            if (taskBadges[prevTaskId]) {
                                taskBadges[prevTaskId] = taskBadges[prevTaskId].filter(id => id !== badge.id);
                                }
                            } else {
                                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã¯ã€æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã¸ã®å¸ç€ã‚’ä¸­æ­¢
                                e.preventDefault();
                                e.stopPropagation();
                                return;
                            }
                        }
                        
                        // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã«ãƒãƒƒã‚¸ã‚’å¸ç€
                        badge.attachedToTaskId = task.id;
                        if (!taskBadges[task.id]) {
                            taskBadges[task.id] = [];
                        }
                        if (!taskBadges[task.id].includes(badge.id)) {
                            taskBadges[task.id].push(badge.id);
                            // Firebaseã«ä¿å­˜
                            saveTaskMarketData();
                            // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰èµ·å‹•ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                            const taskObj = tasks.find(t => t.id === task.id);
                            const taskTitle = taskObj ? taskObj.title : 'ã‚¿ã‚¹ã‚¯';
                            const badgeName = badge.name || 'ãƒãƒƒã‚¸';
                            
                            if (confirm(`${badgeName}ï¼šã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’èµ·å‹•ã—ã€ã‚¿ã‚¹ã‚¯ã€Œ${taskTitle}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`)) {
                                // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆãƒãƒƒã‚¸ãŒã‚¿ã‚¹ã‚¯ã«ä»˜ã‘ã‚‰ã‚ŒãŸæ™‚ï¼‰
                                createTimeRecord(task.id, badge.id);
                            }
                        }
                        
                        // ã‚«ãƒ¼ãƒ‰ã«ç›´æ¥ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆupdateTaskGrid()ã‚’å‘¼ã°ãªã„ï¼‰
                        // æ—¢å­˜ã®ãƒãƒƒã‚¸ã®æ•°ã‚’å–å¾—ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
                        const existingBadges = this.querySelectorAll('.badge.attached');
                        const badgeIndex = existingBadges.length;
                        const badgeElement = createAttachedBadgeElement(badge, badgeIndex);
                        this.appendChild(badgeElement);
                        this.classList.add('badge-attached');
                        
                        // ãƒãƒƒã‚¸ã‚’æ›´æ–°ï¼ˆã‚°ãƒªãƒƒãƒ‰ä¸Šã®ãƒãƒƒã‚¸ã‚’æ›´æ–°ï¼‰
                        updateBadges();
                    }
                }
            });
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼åå–å¾—
        function getCategoryName(category) {
            const names = {
                'design': 'ãƒ‡ã‚¶ã‚¤ãƒ³',
                'frontend': 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰',
                'backend': 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰',
                'database': 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹',
                'media': 'ãƒ¡ãƒ‡ã‚£ã‚¢',
                'other': 'ãã®ä»–'
            };
            return names[category] || category;
        }

        // ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³ãƒ‘ã‚¹å–å¾—
        function getCategoryIconPath(category) {
            const iconPaths = {
                'design': 'images/ãƒ‡ã‚¶ã‚¤ãƒ³.svg',
                'frontend': 'images/ãƒ•ãƒ­ãƒ³ãƒˆ.svg',
                'backend': 'images/ãƒãƒƒã‚¯.svg',
                'media': 'images/ãƒ¡ãƒ‡ã‚£ã‚¢ ãƒ»SNS.svg',
                'database': 'images/ãƒãƒƒã‚¯.svg',
                'other': null
            };
            return iconPaths[category] || null;
        }

        // å„ªå…ˆåº¦åå–å¾—
        function getPriorityName(priority) {
            const names = {
                'low': 'ä½',
                'medium': 'ä¸­',
                'high': 'é«˜'
            };
            return names[priority] || priority;
        }

        // å„ªå…ˆåº¦ã‚«ãƒ©ãƒ¼å–å¾—
        function getPriorityColor(priority) {
            const colors = {
                'low': '#10b981',
                'medium': '#f59e0b',
                'high': '#ef4444'
            };
            return colors[priority] || '#7f8c8d';
        }

        // å„ªå…ˆåº¦ã‚’â­ï¸ã§è¡¨ç¤º
        function getPriorityStars(priority) {
            const starCount = {
                'low': 1,
                'medium': 2,
                'high': 3
            };
            const count = starCount[priority] || 1;
            return 'â­ï¸'.repeat(count);
        }
        
        // äºˆæƒ³ä½œæ¥­æ™‚é–“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆåˆ†å˜ä½ã‚’æ—¥æœ¬èªè¡¨è¨˜ã«å¤‰æ›ï¼‰
        function formatEstimatedTime(minutes) {
            if (!minutes && minutes !== 0) return '-';
            
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            if (hours > 0 && mins > 0) {
                return `${hours}æ™‚é–“${mins}åˆ†`;
            } else if (hours > 0) {
                return `${hours}æ™‚é–“`;
            } else {
                return `${mins}åˆ†`;
            }
        }

        // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¿ã‚¹ã‚¯IDã‚’ä¿æŒ
        let currentDetailTaskId = null;

        // ã‚¿ã‚¹ã‚¯è©³ç´°è¡¨ç¤ºï¼ˆå³ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ï¼‰
        function showTaskDetail(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            currentDetailTaskId = taskId;

            const overlay = document.getElementById('detailBoardOverlay');
            const detailBoard = document.getElementById('detailBoard');
            const detailContent = document.getElementById('detailContent');
            const editButton = document.getElementById('detailEditButton');
            const timeRecordButton = document.getElementById('detailTimeRecordButton');
            
            // ä¿®æ­£ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            editButton.style.display = 'flex';
            // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            timeRecordButton.style.display = 'flex';
            
            // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§è©³ç´°ã‚’è¡¨ç¤º
            renderTaskDetailView(task);
            
            // ãƒ‘ãƒãƒ«ã‚’é–‹ã
            overlay.classList.add('active');
            setTimeout(function() {
                detailBoard.classList.add('active');
            }, 10);
        }

        // ã‚¿ã‚¹ã‚¯è©³ç´°ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
        function renderTaskDetailView(task) {
            const detailContent = document.getElementById('detailContent');
            
            detailContent.innerHTML = `
                <div style="background: var(--color-background); border-radius: var(--border-radius-lg); padding: var(--spacing-md);">
                    <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md); color: var(--color-text-primary);">${task.title}</h3>
                    <div style="margin-bottom: var(--spacing-sm);">
                        <span style="font-weight: var(--font-weight-semibold); color: var(--color-text-secondary);">ã‚«ãƒ†ã‚´ãƒªãƒ¼: </span>
                        <span>${getCategoryName(task.category)}</span>
                    </div>
                    <div style="margin-bottom: var(--spacing-sm);">
                        <span style="font-weight: var(--font-weight-semibold); color: var(--color-text-secondary);">å„ªå…ˆåº¦: </span>
                        <span style="color: ${getPriorityColor(task.priority)};">${getPriorityStars(task.priority)}</span>
                    </div>
                    <div style="margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                        <span style="font-weight: var(--font-weight-semibold); color: var(--color-text-secondary);">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: </span>
                        <span>${task.status === 'completed' ? 'å®Œäº†' : 'æœªç€æ‰‹'}</span>
                    </div>
                    ${task.estimatedTime ? `
                    <div style="margin-bottom: var(--spacing-md);">
                        <span style="font-weight: var(--font-weight-semibold); color: var(--color-text-secondary);">äºˆæƒ³ä½œæ¥­æ™‚é–“: </span>
                        <span>${formatEstimatedTime(task.estimatedTime)}</span>
                    </div>
                    ` : ''}
                    <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border);">
                        <p style="font-weight: var(--font-weight-semibold); color: var(--color-text-secondary); margin-bottom: var(--spacing-sm);">èª¬æ˜:</p>
                        <p style="color: var(--color-text-primary); line-height: 1.6;">${task.description || 'èª¬æ˜ãªã—'}</p>
                    </div>
                </div>
            `;
        }

        // ã‚¿ã‚¹ã‚¯è©³ç´°ã®ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        function renderTaskDetailEdit(task) {
            const detailContent = document.getElementById('detailContent');
            
            detailContent.innerHTML = `
                <div style="background: var(--color-background); border-radius: var(--border-radius-lg); padding: var(--spacing-md);">
                    <form id="taskEditForm">
                        <div class="form-group">
                            <label for="editTaskTitle">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                            <input type="text" id="editTaskTitle" name="title" value="${task.title || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskCategory">ã‚«ãƒ†ã‚´ãƒªãƒ¼ *</label>
                            <select id="editTaskCategory" name="category" required>
                                <option value="design" ${task.category === 'design' ? 'selected' : ''}>ãƒ‡ã‚¶ã‚¤ãƒ³</option>
                                <option value="frontend" ${task.category === 'frontend' ? 'selected' : ''}>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</option>
                                <option value="backend" ${task.category === 'backend' ? 'selected' : ''}>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</option>
                                <option value="database" ${task.category === 'database' ? 'selected' : ''}>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</option>
                                <option value="media" ${task.category === 'media' ? 'selected' : ''}>ãƒ¡ãƒ‡ã‚£ã‚¢</option>
                                <option value="other" ${task.category === 'other' ? 'selected' : ''}>ãã®ä»–</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskPriority">å„ªå…ˆåº¦ *</label>
                            <select id="editTaskPriority" name="priority" required>
                                <option value="low" ${task.priority === 'low' ? 'selected' : ''}>ä½ (â­ï¸)</option>
                                <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>ä¸­ (â­ï¸â­ï¸)</option>
                                <option value="high" ${task.priority === 'high' ? 'selected' : ''}>é«˜ (â­ï¸â­ï¸â­ï¸)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskEstimatedTime">äºˆæƒ³ä½œæ¥­æ™‚é–“</label>
                            <select id="editTaskEstimatedTime" name="estimatedTime">
                                <option value="">æœªè¨­å®š</option>
                                <option value="10" ${task.estimatedTime === 10 ? 'selected' : ''}>10åˆ†</option>
                                <option value="20" ${task.estimatedTime === 20 ? 'selected' : ''}>20åˆ†</option>
                                <option value="30" ${task.estimatedTime === 30 ? 'selected' : ''}>30åˆ†</option>
                                <option value="40" ${task.estimatedTime === 40 ? 'selected' : ''}>40åˆ†</option>
                                <option value="50" ${task.estimatedTime === 50 ? 'selected' : ''}>50åˆ†</option>
                                <option value="60" ${task.estimatedTime === 60 ? 'selected' : ''}>1æ™‚é–“</option>
                                <option value="70" ${task.estimatedTime === 70 ? 'selected' : ''}>1æ™‚é–“10åˆ†</option>
                                <option value="80" ${task.estimatedTime === 80 ? 'selected' : ''}>1æ™‚é–“20åˆ†</option>
                                <option value="90" ${task.estimatedTime === 90 ? 'selected' : ''}>1æ™‚é–“30åˆ†</option>
                                <option value="100" ${task.estimatedTime === 100 ? 'selected' : ''}>1æ™‚é–“40åˆ†</option>
                                <option value="110" ${task.estimatedTime === 110 ? 'selected' : ''}>1æ™‚é–“50åˆ†</option>
                                <option value="120" ${task.estimatedTime === 120 ? 'selected' : ''}>2æ™‚é–“</option>
                                <option value="150" ${task.estimatedTime === 150 ? 'selected' : ''}>2æ™‚é–“30åˆ†</option>
                                <option value="180" ${task.estimatedTime === 180 ? 'selected' : ''}>3æ™‚é–“</option>
                                <option value="240" ${task.estimatedTime === 240 ? 'selected' : ''}>4æ™‚é–“</option>
                                <option value="300" ${task.estimatedTime === 300 ? 'selected' : ''}>5æ™‚é–“</option>
                                <option value="360" ${task.estimatedTime === 360 ? 'selected' : ''}>6æ™‚é–“</option>
                                <option value="480" ${task.estimatedTime === 480 ? 'selected' : ''}>8æ™‚é–“</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskDescription">èª¬æ˜</label>
                            <textarea id="editTaskDescription" name="description" rows="5">${task.description || ''}</textarea>
                        </div>
                        
                        <div class="form-actions" style="margin-top: var(--spacing-md);">
                            <button type="button" class="btn btn-secondary" onclick="cancelTaskEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
            `;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            const taskEditForm = document.getElementById('taskEditForm');
            if (taskEditForm) {
                // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
                const newTaskEditForm = taskEditForm.cloneNode(true);
                taskEditForm.parentNode.replaceChild(newTaskEditForm, taskEditForm);
                
                newTaskEditForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveTaskEdit();
                });
            }
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleTaskEditMode() {
            if (!currentDetailTaskId) return;
            
            const task = tasks.find(t => t.id === currentDetailTaskId);
            if (!task) return;
            
            const editButton = document.getElementById('detailEditButton');
            const detailContent = document.getElementById('detailContent');
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼‰
            const isEditMode = detailContent.querySelector('#taskEditForm');
            
            if (isEditMode) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
                renderTaskDetailView(task);
            } else {
                // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
                renderTaskDetailEdit(task);
            }
        }

        // ã‚¿ã‚¹ã‚¯ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelTaskEdit() {
            if (!currentDetailTaskId) return;
            
            const task = tasks.find(t => t.id === currentDetailTaskId);
            if (!task) return;
            
            renderTaskDetailView(task);
        }

        // ã‚¿ã‚¹ã‚¯ç·¨é›†ã‚’ä¿å­˜
        function saveTaskEdit() {
            if (!currentDetailTaskId) return;
            
            const task = tasks.find(t => t.id === currentDetailTaskId);
            if (!task) return;
            
            const form = document.getElementById('taskEditForm');
            const formData = new FormData(form);
            
            // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            const estimatedTime = formData.get('estimatedTime');
            task.title = formData.get('title');
            task.category = formData.get('category');
            task.priority = formData.get('priority');
            task.description = formData.get('description') || '';
            task.estimatedTime = estimatedTime ? parseInt(estimatedTime) : null; // åˆ†å˜ä½
            task.updatedAt = new Date().toISOString();
            
            // ã‚«ãƒ¼ãƒ‰ã®å†…å®¹ã‚’æ›´æ–°ï¼ˆã‚¿ã‚¹ã‚¯ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»ï¼‰
            updateTaskGrid();
            
            // è©³ç´°ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
            renderTaskDetailView(task);
            
            // Firebaseã«ä¿å­˜
            saveTaskMarketData();
            
            console.log('ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ:', task);
        }

        // è©³ç´°ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDetailBoard() {
            const overlay = document.getElementById('detailBoardOverlay');
            const detailBoard = document.getElementById('detailBoard');
            const editButton = document.getElementById('detailEditButton');
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
            const detailContent = document.getElementById('detailContent');
            const isEditMode = detailContent && detailContent.querySelector('#taskEditForm');
            if (isEditMode) {
                cancelTaskEdit();
            }
            
            // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¿ã‚¹ã‚¯IDã‚’ãƒªã‚»ãƒƒãƒˆ
            currentDetailTaskId = null;
            
            // ä¿®æ­£ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            editButton.style.display = 'none';
            // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            const timeRecordButton = document.getElementById('detailTimeRecordButton');
            if (timeRecordButton) {
                timeRecordButton.style.display = 'none';
            }
            
            detailBoard.classList.remove('active');
            setTimeout(function() {
                overlay.classList.remove('active');
            }, 300);
        }

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDetailBoardOnOverlay(event) {
            if (event.target.id === 'detailBoardOverlay') {
                closeDetailBoard();
            }
        }


        // è©³ç´°ãƒœãƒ¼ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆå‰Šé™¤ï¼šè©³ç´°ãƒœãƒ¼ãƒ‰ã¯ã‚«ãƒ©ãƒ ã§ã¯ãªãã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ãƒ‘ãƒãƒ«ã«å¤‰æ›´ï¼‰
        // function toggleDetail() {
        //     const detailBoard = document.querySelector('.detail-board');
        //     const mainBoard = document.querySelector('.main-board');
        //     const toggleBtn = document.getElementById('toggleDetail');
        //     
        //     detailBoard.classList.toggle('hidden');
        //     toggleBtn.classList.toggle('active');
        //     updateMainBoardWidth();
        // }

        // ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ã®å¹…ã‚’å‹•çš„ã«èª¿æ•´ï¼ˆè©³ç´°ãƒœãƒ¼ãƒ‰ã¯ã‚«ãƒ©ãƒ ã§ã¯ãªããªã£ãŸãŸã‚å‰Šé™¤ï¼‰

        // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®éè¡¨ç¤ºå‡¦ç†
        window.addEventListener('load', function() {
            const splashScreen = document.getElementById('splashScreen');
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œï¼ˆ3.5ç§’ï¼‰ã«ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’å‰Šé™¤
            // é †ç•ª: 1. ç™½ç”»é¢ãŒå‡ºã‚‹ï¼ˆ0ç§’ï¼‰â†’ 2. ãƒ­ã‚´ãŒå‡ºã‚‹ï¼ˆ0.3ç§’ã€œ1.3ç§’ï¼‰â†’ 3. ãƒ­ã‚´ãŒæ¶ˆãˆã‚‹ï¼ˆ2ç§’ã€œ2.5ç§’ï¼‰â†’ 4. ç™½ç”»é¢ã‚’æ¶ˆã™ï¼ˆ3ç§’ã€œ3.5ç§’ï¼‰
            setTimeout(function() {
                splashScreen.classList.add('hidden');
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«å®Œå…¨ã«å‰Šé™¤
                setTimeout(function() {
                    splashScreen.remove();
                    // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥å¾Œã«ã‚¿ã‚¹ã‚¯ã‚°ãƒªãƒƒãƒ‰ã‚’æ›´æ–°ï¼ˆç¢ºå®Ÿã«ã‚µã‚¤ã‚ºã‚’å–å¾—ã™ã‚‹ãŸã‚ï¼‰
                    setTimeout(function() {
                        updateTaskGrid();
                    }, 100);
                }, 500);
            }, 3500);
        });

        // ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ’ãƒ³ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
        function updatePullRefreshHint() {
            if (window.innerWidth > 430) return;
            
            const taskGrid = document.getElementById('taskGrid');
            if (!taskGrid) return;
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒæœ€ä¸Šéƒ¨ï¼ˆ5pxä»¥ä¸‹ï¼‰ã®æ™‚ã®ã¿ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
            if (taskGrid.scrollTop <= 5) {
                taskGrid.classList.add('scroll-top');
            } else {
                taskGrid.classList.remove('scroll-top');
            }
        }
        
        // ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼‰
        function setupPullRefresh() {
            const taskGrid = document.getElementById('taskGrid');
            const pullRefreshIndicator = document.getElementById('pullRefreshIndicator');
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ’ãƒ³ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
            taskGrid.addEventListener('scroll', function() {
                updatePullRefreshHint();
            }, { passive: true });
            
            if (!taskGrid || !pullRefreshIndicator || window.innerWidth > 430) {
                return; // ã‚¹ãƒãƒ›ç‰ˆã®ã¿
            }
            
            let touchStartY = 0;
            let touchCurrentY = 0;
            let isPulling = false;
            let pullDistance = 0;
            const PULL_THRESHOLD = 80; // 80pxå¼•ã£å¼µã£ãŸã‚‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–‹å§‹
            const PULL_MAX = 120; // æœ€å¤§120pxã¾ã§å¼•ã£å¼µã‚Œã‚‹
            
            // ã‚¿ãƒƒãƒé–‹å§‹
            taskGrid.addEventListener('touchstart', function(e) {
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒæœ€ä¸Šéƒ¨ï¼ˆ0ã¾ãŸã¯0ã«è¿‘ã„ï¼‰ã®æ™‚ã®ã¿æœ‰åŠ¹
                if (taskGrid.scrollTop <= 5) {
                    touchStartY = e.touches[0].clientY;
                    isPulling = false;
                    pullDistance = 0;
                }
            }, { passive: true });
            
            // ã‚¿ãƒƒãƒç§»å‹•
            taskGrid.addEventListener('touchmove', function(e) {
                if (touchStartY === 0) return;
                
                touchCurrentY = e.touches[0].clientY;
                const deltaY = touchCurrentY - touchStartY;
                
                // ä¸‹æ–¹å‘ã¸ã®å¼•ã£å¼µã‚Šã‚’æ¤œå‡ºï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãŒæœ€ä¸Šéƒ¨ã®æ™‚ï¼‰
                if (deltaY > 0 && taskGrid.scrollTop <= 5) {
                    e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢
                    
                    pullDistance = Math.min(deltaY, PULL_MAX);
                    isPulling = pullDistance > 10; // 10pxä»¥ä¸Šå¼•ã£å¼µã£ãŸã‚‰é–‹å§‹
                    
                    // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    if (pullDistance >= PULL_THRESHOLD) {
                        pullRefreshIndicator.classList.add('active');
                        pullRefreshIndicator.querySelector('span').textContent = 'é›¢ã—ã¦æ›´æ–°';
                    } else {
                        pullRefreshIndicator.classList.remove('active');
                        pullRefreshIndicator.querySelector('span').textContent = 'æ›´æ–°ä¸­...';
                    }
                    
                    // ã‚°ãƒªãƒƒãƒ‰ã‚’ä¸‹ã«å¼•ã£å¼µã‚‹
                    taskGrid.style.transform = `translateY(${Math.min(pullDistance * 0.5, PULL_MAX * 0.5)}px)`;
                }
            }, { passive: false });
            
            // ã‚¿ãƒƒãƒçµ‚äº†
            taskGrid.addEventListener('touchend', function(e) {
                if (!isPulling) {
                    touchStartY = 0;
                    touchCurrentY = 0;
                    pullDistance = 0;
                    taskGrid.style.transform = '';
                    pullRefreshIndicator.classList.remove('active');
                    return;
                }
                
                if (pullDistance >= PULL_THRESHOLD) {
                    // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Ÿè¡Œ
                    pullRefreshIndicator.classList.add('active');
                    pullRefreshIndicator.querySelector('span').textContent = 'æ›´æ–°ä¸­...';
                    
                    // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†
                    refreshTaskData();
                } else {
                    // é–¾å€¤ã«é”ã—ã¦ã„ãªã„å ´åˆã¯å…ƒã«æˆ»ã™
                    taskGrid.style.transform = '';
                    pullRefreshIndicator.classList.remove('active');
                }
                
                // ãƒªã‚»ãƒƒãƒˆ
                touchStartY = 0;
                touchCurrentY = 0;
                pullDistance = 0;
                isPulling = false;
            }, { passive: true });
            
            // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«
            taskGrid.addEventListener('touchcancel', function(e) {
                touchStartY = 0;
                touchCurrentY = 0;
                pullDistance = 0;
                isPulling = false;
                taskGrid.style.transform = '';
                pullRefreshIndicator.classList.remove('active');
            }, { passive: true });
        }
        
        // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆå†èª­ã¿è¾¼ã¿ï¼‰
        function refreshTaskData() {
            console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¾ã™...');
            
            // å®Ÿéš›ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å‡¦ç†ï¼ˆFirebaseãªã©ã‹ã‚‰å†èª­ã¿è¾¼ã¿ï¼‰
            // ä»Šå›ã¯ç°¡å˜ã«updateTaskGridã¨updateBadgesã‚’å‘¼ã³å‡ºã™
            setTimeout(() => {
                updateTaskGrid();
                updateBadges();
                
                // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Œäº†
                const pullRefreshIndicator = document.getElementById('pullRefreshIndicator');
                if (pullRefreshIndicator) {
                    pullRefreshIndicator.querySelector('span').textContent = 'æ›´æ–°å®Œäº†';
                    setTimeout(() => {
                        pullRefreshIndicator.classList.remove('active');
                        const taskGrid = document.getElementById('taskGrid');
                        if (taskGrid) {
                            taskGrid.style.transform = '';
                        }
                    }, 500);
                }
            }, 800); // 0.8ç§’å¾Œã«å®Œäº†ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
        }

        // ãƒªãƒ³ã‚¯ãƒ‘ãƒãƒ«é–¢é€£ã®å¤‰æ•°ï¼ˆåˆæœŸåŒ–æ™‚ã¯ç©ºã€loadTaskMarketData()ã§èª­ã¿è¾¼ã‚€ï¼‰
        let externalLinks = [];
        let selectedLinkIds = new Set();
        let linkDragStartPosition = { x: 0, y: 0 };
        
        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‘ãƒãƒ«é–¢é€£ã®å¤‰æ•°
        let archiveFilters = {
            date: 'all',
            assignee: 'all',
            category: 'all',
            search: ''
        };
        
        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‘ãƒãƒ«ï¼šå®Œäº†æ¸ˆã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
        function updateArchivePanel() {
            const archiveTaskList = document.getElementById('archiveTaskList');
            if (!archiveTaskList) return;
            
            // å®Œäº†æ¸ˆã‚¿ã‚¹ã‚¯ã‚’å–å¾—
            let completedTasks = tasks.filter(task => task.status === 'completed');
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            completedTasks = applyArchiveFilters(completedTasks);
            
            archiveTaskList.innerHTML = '';
            
            if (completedTasks.length === 0) {
                archiveTaskList.innerHTML = '<p class="archive-empty">å®Œäº†æ¸ˆã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            completedTasks.sort((a, b) => {
                const dateA = new Date(a.completedAt || a.updatedAt || a.createdAt || 0);
                const dateB = new Date(b.completedAt || b.updatedAt || b.createdAt || 0);
                return dateB - dateA;
            });
            
            completedTasks.forEach(task => {
                const archiveItem = createArchiveTaskItem(task);
                archiveTaskList.appendChild(archiveItem);
            });
        }
        
        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰
        function createArchiveTaskItem(task) {
            const item = document.createElement('div');
            item.className = 'archive-task-item';
            item.dataset.taskId = task.id;
            
            // å®Œäº†æ—¥æ™‚
            const completedDate = task.completedAt ? new Date(task.completedAt) : (task.updatedAt ? new Date(task.updatedAt) : new Date(task.createdAt));
            const dateStr = completedDate.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // æ‹…å½“ãƒãƒƒã‚¸
            const assignedBadges = getAssignedBadgesForTask(task.id);
            
            // ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã®åˆè¨ˆä½œæ¥­æ™‚é–“ã‚’è¨ˆç®—
            const taskRecords = getTimeRecordsForTask(task.id);
            const completedRecords = taskRecords.filter(r => r.status === 'completed' && r.duration !== null);
            const totalDuration = completedRecords.reduce((sum, r) => sum + r.duration, 0);
            const totalDurationFormatted = totalDuration > 0 ? formatDuration(totalDuration) : '-';
            
            // ã‚«ãƒ†ã‚´ãƒªå
            const categoryNames = {
                'design': 'ãƒ‡ã‚¶ã‚¤ãƒ³',
                'frontend': 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰',
                'backend': 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰',
                'database': 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹',
                'media': 'ãƒ¡ãƒ‡ã‚£ã‚¢',
                'other': 'ãã®ä»–'
            };
            
            item.innerHTML = `
                <div class="archive-task-header" onclick="toggleArchiveTask(this)">
                    <div style="flex: 1;">
                        <div class="archive-task-title">${escapeHtml(task.title || 'ç„¡é¡Œã®ã‚¿ã‚¹ã‚¯')}</div>
                        <div class="archive-task-meta">
                            <span>ğŸ“… ${dateStr}</span>
                            <span>|</span>
                            <span>${categoryNames[task.category] || 'æœªåˆ†é¡'}</span>
                            ${assignedBadges.length > 0 ? `<span>|</span><span>æ‹…å½“: ${assignedBadges.length}äºº</span>` : ''}
                            ${totalDuration > 0 ? `<span>|</span><span>â±ï¸ ${totalDurationFormatted}</span>` : ''}
                        </div>
                    </div>
                    <span class="archive-task-arrow">â–¼</span>
                </div>
                <div class="archive-task-content">
                    <div class="archive-task-body">
                        ${task.description ? `<div class="archive-task-description">${escapeHtml(task.description)}</div>` : ''}
                        ${assignedBadges.length > 0 ? `
                            <div class="archive-task-badges">
                                <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-right: var(--spacing-xs);">æ‹…å½“è€…:</span>
                                ${assignedBadges.map(badge => `
                                    <div class="archive-task-badge">
                                        ${badge.picture ? `<img src="${badge.picture}" alt="${escapeHtml(badge.name)}" class="archive-task-badge-icon">` : 
                                          badge.icon && badge.icon.startsWith('img:') ? `<img src="${badge.icon.substring(4)}" alt="${escapeHtml(badge.name)}" class="archive-task-badge-icon">` :
                                          `<span>${badge.icon || 'ğŸ‘¤'}</span>`}
                                        <span>${escapeHtml(badge.name)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return item;
        }
        
        // ã‚¿ã‚¹ã‚¯ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒãƒƒã‚¸ã‚’å–å¾—
        function getAssignedBadgesForTask(taskId) {
            if (!taskBadges[taskId] || taskBadges[taskId].length === 0) {
                return [];
            }
            
            return badges.filter(badge => taskBadges[taskId].includes(badge.id));
        }
        
        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰
        function toggleArchiveTask(header) {
            const item = header.closest('.archive-task-item');
            item.classList.toggle('active');
        }
        
        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
        function applyArchiveFilters(tasks) {
            let filtered = [...tasks];
            
            // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (archiveFilters.date !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                filtered = filtered.filter(task => {
                    const taskDate = task.completedAt ? new Date(task.completedAt) : (task.updatedAt ? new Date(task.updatedAt) : new Date(task.createdAt));
                    
                    switch (archiveFilters.date) {
                        case 'today':
                            return taskDate >= today;
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return taskDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return taskDate >= monthAgo;
                        case 'year':
                            const yearAgo = new Date(today);
                            yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                            return taskDate >= yearAgo;
                        default:
                            return true;
                    }
                });
            }
            
            // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (archiveFilters.assignee !== 'all') {
                filtered = filtered.filter(task => {
                    const assignedBadges = getAssignedBadgesForTask(task.id);
                    return assignedBadges.some(badge => badge.id.toString() === archiveFilters.assignee);
                });
            }
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (archiveFilters.category !== 'all') {
                filtered = filtered.filter(task => task.category === archiveFilters.category);
            }
            
            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (archiveFilters.search.trim() !== '') {
                const searchTerm = archiveFilters.search.toLowerCase();
                filtered = filtered.filter(task => 
                    (task.title && task.title.toLowerCase().includes(searchTerm)) ||
                    (task.description && task.description.toLowerCase().includes(searchTerm))
                );
            }
            
            return filtered;
        }
        
        // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
        function setupArchiveFilters() {
            const filterDate = document.getElementById('archiveFilterDate');
            const filterAssignee = document.getElementById('archiveFilterAssignee');
            const filterCategory = document.getElementById('archiveFilterCategory');
            const filterSearch = document.getElementById('archiveFilterSearch');
            
            if (filterDate) {
                filterDate.addEventListener('change', function() {
                    archiveFilters.date = this.value;
                    updateArchivePanel();
                });
            }
            
            if (filterAssignee) {
                filterAssignee.addEventListener('change', function() {
                    archiveFilters.assignee = this.value;
                    updateArchivePanel();
                });
            }
            
            if (filterCategory) {
                filterCategory.addEventListener('change', function() {
                    archiveFilters.category = this.value;
                    updateArchivePanel();
                });
            }
            
            if (filterSearch) {
                filterSearch.addEventListener('input', function() {
                    archiveFilters.search = this.value;
                    updateArchivePanel();
                });
            }
            
            // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            updateAssigneeFilterOptions();
        }
        
        // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateAssigneeFilterOptions() {
            const filterAssignee = document.getElementById('archiveFilterAssignee');
            if (!filterAssignee) return;
            
            // ç¾åœ¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿æŒï¼ˆã€Œã™ã¹ã¦ã€ã®ã¿ï¼‰
            filterAssignee.innerHTML = '<option value="all">ã™ã¹ã¦</option>';
            
            // ã™ã¹ã¦ã®ãƒãƒƒã‚¸ã‚’å–å¾—
            badges.forEach(badge => {
                const option = document.createElement('option');
                option.value = badge.id.toString();
                option.textContent = badge.name;
                filterAssignee.appendChild(option);
            });
        }
        
        // å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
        function addExternalLink(url, title = '') {
            try {
                const urlObj = new URL(url);
                const domain = urlObj.hostname;
                
                // ã‚¿ã‚¤ãƒˆãƒ«ãŒæœªæŒ‡å®šã®å ´åˆã¯ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’ä½¿ç”¨
                const linkTitle = title || domain.replace('www.', '');
                
                // ãƒ•ã‚¡ãƒ“ã‚³ãƒ³URLã‚’ç”Ÿæˆ
                const faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                
                const link = {
                    id: Date.now(),
                    url: url,
                    title: linkTitle,
                    domain: domain,
                    faviconUrl: faviconUrl,
                    position: {
                        x: Math.random() * 300,
                        y: Math.random() * 300
                    },
                    groupId: null // ã‚°ãƒ«ãƒ¼ãƒ—IDï¼ˆnullã¯ã‚°ãƒ«ãƒ¼ãƒ—æœªæ‰€å±ï¼‰
                };
                
                externalLinks.push(link);
                saveExternalLinks();
                updateLinkIconGrid();
                
                return link;
            } catch (error) {
                alert('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                console.error('URLè§£æã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚’ä¿å­˜
        function saveExternalLinks() {
            localStorage.setItem('externalLinks', JSON.stringify(externalLinks));
            // Firebaseã«ã‚‚ä¿å­˜
            saveTaskMarketData();
        }
        
        // å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤
        function deleteExternalLink(linkId) {
            externalLinks = externalLinks.filter(link => link.id !== linkId);
            saveExternalLinks();
            updateLinkIconGrid();
        }
        
        // ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚°ãƒªãƒƒãƒ‰ã‚’æ›´æ–°
        function updateLinkIconGrid() {
            const linkIconGrid = document.getElementById('linkIconGrid');
            if (!linkIconGrid) return;
            
            linkIconGrid.innerHTML = '';
            
            externalLinks.forEach(link => {
                const linkIcon = document.createElement('div');
                linkIcon.className = 'link-icon';
                linkIcon.dataset.linkId = link.id;
                linkIcon.draggable = true;
                
                // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ä½ç½®ã‚’é©ç”¨
                if (link.position && link.position.x !== undefined && link.position.y !== undefined) {
                    linkIcon.style.position = 'absolute';
                    linkIcon.style.left = link.position.x + 'px';
                    linkIcon.style.top = link.position.y + 'px';
                }
                
                // ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ç”»åƒ
                const img = document.createElement('img');
                img.src = link.faviconUrl;
                img.alt = link.title;
                img.onerror = function() {
                    // ãƒ•ã‚¡ãƒ“ã‚³ãƒ³èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
                    this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50"><rect fill="%23ccc" width="50" height="50"/><text x="25" y="30" font-size="20" text-anchor="middle" fill="%23666">ğŸ”—</text></svg>';
                };
                
                // ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
                const titleSpan = document.createElement('span');
                titleSpan.className = 'link-icon-title';
                titleSpan.textContent = link.title;
                
                linkIcon.appendChild(img);
                linkIcon.appendChild(titleSpan);
                
                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
                setupLinkDragAndDrop(linkIcon, link);
                
                // é¸æŠç”¨ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆCtrlã‚­ãƒ¼ã¾ãŸã¯é•·æŠ¼ã—ã§é¸æŠï¼‰
                linkIcon.addEventListener('click', function(e) {
                    // Ctrlã‚­ãƒ¼ï¼ˆMacã§ã¯Cmdã‚­ãƒ¼ï¼‰ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠãƒ¢ãƒ¼ãƒ‰
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        toggleLinkSelection(link.id);
                    }
                });
                
                linkIconGrid.appendChild(linkIcon);
            });
            
            // ã‚´ãƒŸç®±ã®ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚’è¨­å®š
            // ãƒ‘ãƒãƒ«å†…ã‚´ãƒŸç®±ã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ã“ã®é–¢æ•°ã¯å‘¼ã°ãªã„
            // setupPanelTrashBin();
        }
        
        // ãƒªãƒ³ã‚¯ã®é¸æŠçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleLinkSelection(linkId) {
            if (selectedLinkIds.has(linkId)) {
                selectedLinkIds.delete(linkId);
            } else {
                selectedLinkIds.add(linkId);
            }
            
            // UIæ›´æ–°
            const linkIcon = document.querySelector(`.link-icon[data-link-id="${linkId}"]`);
            if (linkIcon) {
                if (selectedLinkIds.has(linkId)) {
                    linkIcon.classList.add('selected');
                } else {
                    linkIcon.classList.remove('selected');
                }
            }
            
            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ç¢ºèª
            if (selectedLinkIds.size > 1) {
                groupSelectedLinks();
            } else {
                ungroupLinks();
            }
        }
        
        // é¸æŠã•ã‚ŒãŸãƒªãƒ³ã‚¯ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        function groupSelectedLinks() {
            const groupId = Date.now();
            const selectedArray = Array.from(selectedLinkIds);
            
            selectedArray.forEach(linkId => {
                const link = externalLinks.find(l => l.id === linkId);
                if (link) {
                    link.groupId = groupId;
                }
            });
            
            saveExternalLinks();
        }
        
        // ãƒªãƒ³ã‚¯ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è§£é™¤
        function ungroupLinks() {
            externalLinks.forEach(link => {
                if (selectedLinkIds.has(link.id)) {
                    link.groupId = null;
                }
            });
            saveExternalLinks();
        }
        
        // ãƒªãƒ³ã‚¯ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’è¨­å®š
        function setupLinkDragAndDrop(linkIcon, link) {
            // PCç‰ˆï¼šãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            let dragStartPosition = { x: 0, y: 0 };
            
            linkIcon.addEventListener('dragstart', function(e) {
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('linkId', link.id.toString());
                
                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ã‚‚ä¸€ç·’ã«ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹å ´åˆã®å‡¦ç†
                if (link.groupId) {
                    e.dataTransfer.setData('groupId', link.groupId.toString());
                }
                
                // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ä½ç½®ã‚’è¨˜éŒ²
                dragStartPosition.x = link.position.x;
                dragStartPosition.y = link.position.y;
            });
            
            linkIcon.addEventListener('drag', function(e) {
                // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ä½ç½®æ›´æ–°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ã‚‚ä¸€ç·’ã«ç§»å‹•ï¼‰
                if (link.groupId && e.clientX !== 0 && e.clientY !== 0) {
                    const gridRect = document.getElementById('linkIconGrid').getBoundingClientRect();
                    const newX = e.clientX - gridRect.left - 25; // ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­å¿ƒã‚’è€ƒæ…®
                    const newY = e.clientY - gridRect.top - 25;
                    
                    const deltaX = newX - dragStartPosition.x;
                    const deltaY = newY - dragStartPosition.y;
                    
                    moveGroupedLinks(link.id, deltaX, deltaY);
                    dragStartPosition.x = newX;
                    dragStartPosition.y = newY;
                }
            });
            
            linkIcon.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
                
                // æœ€çµ‚ä½ç½®ã‚’ä¿å­˜
                const rect = this.getBoundingClientRect();
                const gridRect = document.getElementById('linkIconGrid').getBoundingClientRect();
                link.position.x = rect.left - gridRect.left;
                link.position.y = rect.top - gridRect.top;
                saveExternalLinks();
            });
            
            // ã‚¹ãƒãƒ›ç‰ˆï¼šã‚¿ãƒƒãƒãƒ‰ãƒ©ãƒƒã‚°
            let touchStartX = 0;
            let touchStartY = 0;
            let isDragging = false;
            let linkStartX = 0;
            let linkStartY = 0;
            let touchTimeout = null;
            
            linkIcon.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                    isDragging = false;
                    
                    // ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã®ç¾åœ¨ä½ç½®ã‚’å–å¾—
                    const rect = this.getBoundingClientRect();
                    const gridRect = document.getElementById('linkIconGrid').getBoundingClientRect();
                    linkStartX = rect.left - gridRect.left;
                    linkStartY = rect.top - gridRect.top;
                    
                    // é•·æŠ¼ã—ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼ˆ300msï¼‰
                    touchTimeout = setTimeout(() => {
                        isDragging = true;
                        this.classList.add('dragging');
                        this.style.transition = 'none';
                        this.style.zIndex = '100';
                    }, 300);
                }
            }, { passive: true });
            
            linkIcon.addEventListener('touchmove', function(e) {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - touchStartX);
                    const deltaY = Math.abs(touch.clientY - touchStartY);
                    
                    if ((deltaX > 5 || deltaY > 5) && !isDragging) {
                        clearTimeout(touchTimeout);
                        isDragging = true;
                        this.classList.add('dragging');
                        this.style.transition = 'none';
                        this.style.zIndex = '100';
                    }
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ä½ç½®æ›´æ–°
                    if (isDragging) {
                        e.preventDefault();
                        const gridRect = document.getElementById('linkIconGrid').getBoundingClientRect();
                        const newX = linkStartX + (touch.clientX - touchStartX);
                        const newY = linkStartY + (touch.clientY - touchStartY);
                        
                        // ã‚°ãƒªãƒƒãƒ‰å†…ã«åˆ¶é™
                        const maxX = gridRect.width - 50;
                        const maxY = gridRect.height - 50;
                        const clampedX = Math.max(0, Math.min(newX, maxX));
                        const clampedY = Math.max(0, Math.min(newY, maxY));
                        
                        this.style.position = 'absolute';
                        this.style.left = clampedX + 'px';
                        this.style.top = clampedY + 'px';
                        
                        // ãƒ‘ãƒãƒ«å†…ã‚´ãƒŸç®±ã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ã“ã®ãƒã‚§ãƒƒã‚¯ã¯ä¸è¦
                        // const panelTrashBin = document.getElementById('panelTrashBin1');
                        // ...
                    }
                }
            }, { passive: false });
            
            linkIcon.addEventListener('touchend', function(e) {
                clearTimeout(touchTimeout);
                
                if (isDragging) {
                    isDragging = false;
                    this.classList.remove('dragging');
                    this.style.transition = '';
                    this.style.zIndex = '';
                    
                    // ãƒ‘ãƒãƒ«å†…ã‚´ãƒŸç®±ã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ãƒ¡ã‚¤ãƒ³ã®ã‚´ãƒŸç®±ã§ãƒã‚§ãƒƒã‚¯
                    const trashBin = document.getElementById('trashBin');
                    if (trashBin) {
                        const trashRect = trashBin.getBoundingClientRect();
                        const linkRect = this.getBoundingClientRect();
                        
                        // ãƒªãƒ³ã‚¯ã®é ˜åŸŸãŒã‚´ãƒŸç®±ã®é ˜åŸŸã¨é‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (linkRect.left < trashRect.right && linkRect.right > trashRect.left &&
                            linkRect.top < trashRect.bottom && linkRect.bottom > trashRect.top) {
                            // ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤
                            if (confirm('ã“ã®ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                                deleteExternalLink(link.id);
                            } else {
                                // ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                                this.style.position = '';
                                this.style.left = '';
                                this.style.top = '';
                            }
                        } else {
                            // ä½ç½®ã‚’æ›´æ–°ï¼ˆã‚°ãƒªãƒƒãƒ‰ã‹ã‚‰ç‹¬ç«‹ã—ãŸä½ç½®ã«ç§»å‹•ï¼‰
                            const rect = this.getBoundingClientRect();
                            const gridRect = document.getElementById('linkIconGrid').getBoundingClientRect();
                            link.position.x = rect.left - gridRect.left;
                            link.position.y = rect.top - gridRect.top;
                            saveExternalLinks();
                            
                            // çµ¶å¯¾ä½ç½®ã§ä¿æŒ
                            this.style.position = 'absolute';
                            this.style.left = link.position.x + 'px';
                            this.style.top = link.position.y + 'px';
                        }
                    } else {
                        // ä½ç½®ã‚’æ›´æ–°ï¼ˆã‚°ãƒªãƒƒãƒ‰ã‹ã‚‰ç‹¬ç«‹ã—ãŸä½ç½®ã«ç§»å‹•ï¼‰
                        const rect = this.getBoundingClientRect();
                        const gridRect = document.getElementById('linkIconGrid').getBoundingClientRect();
                        link.position.x = rect.left - gridRect.left;
                        link.position.y = rect.top - gridRect.top;
                        saveExternalLinks();
                        
                        // çµ¶å¯¾ä½ç½®ã§ä¿æŒ
                        this.style.position = 'absolute';
                        this.style.left = link.position.x + 'px';
                        this.style.top = link.position.y + 'px';
                    }
                } else {
                    // ã‚¿ãƒƒãƒ—ï¼šãƒªãƒ³ã‚¯ã‚’é–‹ãï¼ˆCtrl/Cmdã‚­ãƒ¼ã§é¸æŠï¼‰
                    // é¸æŠå‡¦ç†ã¯åˆ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§å‡¦ç†
                }
            }, { passive: true });
            
            // ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹ãï¼ˆé¸æŠãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã®ã¿ï¼‰
            linkIcon.addEventListener('click', function(e) {
                if (!isDragging && !e.ctrlKey && !e.metaKey) {
                    window.open(link.url, '_blank');
                }
            });
        }
        
        // ãƒ‘ãƒãƒ«å†…ã‚´ãƒŸç®±ã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ã“ã®é–¢æ•°ã¯ä¸è¦
        // function setupPanelTrashBin() { ... }
        
        // ãƒªãƒ³ã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
        document.getElementById('linkAddForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const url = document.getElementById('linkUrl').value.trim();
            const title = document.getElementById('linkTitle').value.trim();
            
            if (!url) {
                alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            addExternalLink(url, title);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkTitle').value = '';
        });
        
        // ãƒ‘ãƒãƒ«1ãŒé–‹ã‹ã‚ŒãŸæ™‚ã«ãƒªãƒ³ã‚¯ã‚°ãƒªãƒƒãƒ‰ã‚’æ›´æ–°
        function updateLinkPanelOnOpen() {
            if (document.getElementById('slidePanelOverlay1').classList.contains('active')) {
                updateLinkIconGrid();
            }
        }
        
        // ãƒ‘ãƒãƒ«é–‹é–‰æ™‚ã«ãƒªãƒ³ã‚¯ã‚°ãƒªãƒƒãƒ‰ã‚’æ›´æ–°ï¼ˆãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ï¼‰
        function openSlidePanel(panelNumber) {
            openSlidePanelOriginal(panelNumber);
            if (panelNumber === 1) {
                setTimeout(() => {
                    updateLinkIconGrid();
                }, 100);
            } else if (panelNumber === 5) {
                // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸæ™‚ã«æ›´æ–°
                setTimeout(() => {
                    updateArchivePanel();
                    updateAssigneeFilterOptions();
                }, 100);
            }
        }

        // åˆæœŸåŒ–ï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚å®Ÿè¡Œã€ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥å¾Œã«å†å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
        setTimeout(async function() {
            // Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆæœ€å„ªå…ˆï¼‰
            await loadTaskMarketData();
            
            // ã‚´ãƒŸç®±ã‚’å…¨ã¦å‰Šé™¤ã—ã¦ã‹ã‚‰å†ä½œæˆï¼ˆé‡è¤‡ã‚’å®Œå…¨ã«é˜²ãï¼‰
            const allTrashBins = document.querySelectorAll('.trash-bin[id="trashBin"]');
            allTrashBins.forEach(function(trashBin) {
                trashBin.remove();
            });
            
            // å³ä¸‹ã«1ã¤ã ã‘ã‚´ãƒŸç®±ã‚’ä½œæˆ
            const trashBin = document.createElement('div');
            trashBin.className = 'trash-bin';
            trashBin.id = 'trashBin';
            trashBin.innerHTML = '<span class="trash-icon">ğŸ—‘ï¸</span><span class="tooltip-text">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§å‰Šé™¤</span>';
            document.body.appendChild(trashBin);
            
            // setupTrashBinDropã®ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ–°ã—ã„ã‚´ãƒŸç®±ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹ãŸã‚ï¼‰
            trashBinHandlerSet = false;
            
            setupBadgeDragHandler(); // ãƒãƒƒã‚¸ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®š
            setupTrashBinDrop(); // ã‚´ãƒŸç®±ã®ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚’åˆæœŸåŒ–
            setupCompleteButtonDrop(); // å®Œäº†ãƒœã‚¿ãƒ³ã®ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚’åˆæœŸåŒ–
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ™‚ã«æ—¢ã«updateTaskGrid()ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ãŸã‚ã€é‡è¤‡ã‚’é¿ã‘ã‚‹
            // ãŸã ã—ã€ã‚´ãƒŸç®±ä½œæˆå¾Œã«UIã‚’æ›´æ–°
            if (!document.getElementById('taskGrid').hasChildNodes() || document.getElementById('taskGrid').childElementCount === 0) {
                updateTaskGrid();
            }
            if (badges.length > 0) {
                updateBadges(); // ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
            }
            // ãƒªãƒ³ã‚¯ãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–
            updateLinkIconGrid();
            // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‘ãƒãƒ«ã®åˆæœŸåŒ–
            setupArchiveFilters();
            updateArchivePanel();
            // ãƒ—ãƒ«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ï¼ˆã‚¹ãƒãƒ›ç‰ˆã®ã¿ï¼‰
            if (window.innerWidth <= 430) {
                setupPullRefresh();
                // ãƒ’ãƒ³ãƒˆã®åˆæœŸè¡¨ç¤ºã‚’è¨­å®š
                const taskGrid = document.getElementById('taskGrid');
                if (taskGrid) {
                    // åˆæœŸåŒ–æ™‚ã¯æœ€ä¸Šéƒ¨ã¨ã¿ãªã™
                    taskGrid.classList.add('scroll-top');
                    updatePullRefreshHint();
                }
            }
        }, 100);

        // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ãƒ‘ãƒãƒ«ã®é–‹é–‰æ©Ÿèƒ½ï¼ˆ5ã¤ã®ãƒ‘ãƒãƒ«å¯¾å¿œï¼‰
        function openSlidePanelOriginal(panelNumber) {
            const overlay = document.getElementById('slidePanelOverlay' + panelNumber);
            const panel = document.getElementById('slidePanel' + panelNumber);
            const handle = document.getElementById('slidePanelHandle' + panelNumber);
            overlay.classList.add('active');
            handle.classList.add('active');
            // å°‘ã—é…å»¶ã•ã›ã¦ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®è¡¨ç¤ºå¾Œã«ï¼‰
            setTimeout(function() {
                panel.classList.add('active');
            }, 10);
        }

        function closeSlidePanel(panelNumber) {
            const overlay = document.getElementById('slidePanelOverlay' + panelNumber);
            const panel = document.getElementById('slidePanel' + panelNumber);
            const handle = document.getElementById('slidePanelHandle' + panelNumber);
            panel.classList.remove('active');
            handle.classList.remove('active');
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
            setTimeout(function() {
                overlay.classList.remove('active');
            }, 300);
        }

        // ãƒ‘ãƒãƒ«ã®é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        function toggleSlidePanel(panelNumber) {
            const overlay = document.getElementById('slidePanelOverlay' + panelNumber);
            if (overlay.classList.contains('active')) {
                closeSlidePanel(panelNumber);
            } else {
                // ä»–ã®ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
                for (let i = 1; i <= 5; i++) {
                    if (i !== panelNumber) {
                        closeSlidePanel(i);
                    }
                }
                openSlidePanel(panelNumber);
            }
        }

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        function closeSlidePanelOnOverlay(event, panelNumber) {
            if (event.target.id === 'slidePanelOverlay' + panelNumber) {
                closeSlidePanel(panelNumber);
            }
        }

        // ESCã‚­ãƒ¼ã§é–‹ã„ã¦ã„ã‚‹ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // è©³ç´°ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
                const detailOverlay = document.getElementById('detailBoardOverlay');
                if (detailOverlay && detailOverlay.classList.contains('active')) {
                    closeDetailBoard();
                    return;
                }
                
                // é–‹ã„ã¦ã„ã‚‹ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ãƒ‘ãƒãƒ«ã‚’ã™ã¹ã¦é–‰ã˜ã‚‹
                for (let i = 1; i <= 5; i++) {
                    const overlay = document.getElementById('slidePanelOverlay' + i);
                    if (overlay && overlay.classList.contains('active')) {
                        closeSlidePanel(i);
                    }
                }
            }
        });
    </script>
</body>
</html>

