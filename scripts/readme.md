# スクリプト仕様（scripts/）

このディレクトリは、静的モックのビルド（簡易テンプレート生成）とスモークテストを提供する実行スクリプト群を管理します。

## 対象スクリプト
- `build.py`: `@include` のみ（Laravel 風）の簡易ビルダー。`src/pages/**/*.html` → `public/**/*.html` を生成。
- `test_smoke.py`: ビルド（任意）→ 生成物（`public/`）の存在・サイズ・参照切れを検査する最小スモークテスト。

## 目的
- 目視検証の抜け漏れを減らし、最低限の品質ゲートを自動化する。
- テンプレート導入後も、生成 HTML の健全性を継続的に確認する。

## 前提/対象ディレクトリ
- リポジトリルート直下の `public/` を検査対象とする。
- `scripts/build.py` が存在する場合は先に実行し、その結果に対して検査する（存在しない場合はスキップ）。
- 将来的に `src/pages/*.html` が存在する場合、それらに対応する `public/*.html` が生成されていることを期待する（後方互換として `templates/pages/*.html` にも対応）。

## 実行方法
- `python3 scripts/build.py` で生成
- `python3 scripts/test_smoke.py` で検証
  - ビルドがあれば実行 → `public/` 内の HTML を検査 → 問題があれば詳細を列挙して非 0 終了。

## チェック内容
- ビルド実行（任意）
  - `scripts/build.py` を `python3` で起動し、終了コードと標準出力/標準エラーを記録。
- 期待ページの決定
  - 優先: `src/pages/*.html` があれば、そのファイル名と同名の `public/*.html` を期待。
  - 後方互換: `templates/pages/*.html` があれば同様に期待。
  - 代替: どちらも無ければ、現在存在する `public/*.html` を対象として検査。
- HTML の存在・サイズ
  - 期待ページが存在すること。
  - ファイルサイズが閾値以上（デフォルト: 256 bytes）であること。
- 参照（リンク/アセット）の存在確認
  - `href`/`src` を正規表現で抽出し、相対参照を `public/` を基準に解決して存在確認。
  - 除外（検査対象外）: `http://`, `https://`, `//`, `mailto:`, `tel:`, `data:`, `javascript:`, `about:`, `#`（ページ内アンカー）
  - `?query` と `#hash` は解決前に除去。末尾 `/` の場合は `index.html` を補完して存在確認を試行。

## 終了コード
- 0: すべての検査を通過。
- 1: いずれかの検査で失敗（ビルド失敗/欠落ファイル/過小サイズ/参照切れ/読み込みエラー等）。

## 代表的な出力
- `[info] ...`: 情報ログ（ビルド有無など）
- `[warn] ...`: 警告（検査対象ページが見つからない等）
- `[OK] Smoke tests passed.`: 合格
- `[FAIL] Issues found:` 以下に箇条書きで問題を列挙

## カスタマイズ方法
- 閾値変更: `SIZE_THRESHOLD_BYTES`（既定 256）を調整。
- 抽出正規表現: `RE_REF` を変更してチェック対象属性を拡張（例: `srcset` など）。
- 除外スキーム: `is_external_or_ignored()` 内の条件を追加/削除。

## 制約と注意
- 参照解決は `public/` を基点とした単純解決（ディレクトリ階層をまたぐテンプレート相対パスには未対応）。必要に応じてページごとの相対基点に拡張してください。
- HTML パースは依存最小化のため正規表現ベース。厳密性が必要になった段階で `BeautifulSoup` 等への置き換えを推奨。
- `public/` は生成物想定。テンプレート導入後はテンプレートを編集→ビルド→本スクリプトで検証する運用に切り替えてください。

## 将来拡張（例）
- 厳密な HTML バリデーション（例: vnu.jar）
- CSS/JS の Lint 連携（Stylelint/ESLint）
- GitHub Actions 等 CI での自動実行

---

## ビルダー仕様（@include に統一）

対応ディレクティブ
- `@include('...')`: 部分テンプレートを挿入（ドットは `/` に解決、拡張子省略可）。

探索ルールと出力
- 入力: `src/pages/**/*.html`
- 出力: `public/**/*.html`（相対パスを維持）
- 検索順: `src/<指定パス>`, `src/partials/<指定パス>`, `src/layouts/<指定パス>`
- セキュリティ: `..` を含む指定は拒否。再帰深さは 20 で制限。

使い方の指針
- レイアウトも含め「共通断片」はすべて `@include` で組み立てる（例: ページ先頭で `@include('layouts.base-header')`、末尾で `@include('layouts.base-footer')` など）。
- 条件分岐や繰り返しなどのロジックは持たせない（静的モック用途）。
